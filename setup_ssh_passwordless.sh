#!/bin/bash
################################################################################
# SSH í‚¤ ê¸°ë°˜ ì¸ì¦ ìë™ ì„¤ì •
# í•œ ë²ˆë§Œ ì„¤ì •í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ì´ SSH ì ‘ì† ê°€ëŠ¥
#
# Usage: ./setup_ssh_passwordless.sh [CONFIG_FILE]
#   CONFIG_FILE: Path to YAML config file (default: my_cluster.yaml)
################################################################################

# ì„¤ì • íŒŒì¼ íŒŒë¼ë¯¸í„° (ê¸°ë³¸ê°’: my_cluster.yaml)
CONFIG_FILE="${1:-my_cluster.yaml}"

echo "================================================================================"
echo "ğŸ”‘ SSH í‚¤ ê¸°ë°˜ ì¸ì¦ ìë™ ì„¤ì •"
echo "================================================================================"
echo ""
echo "ğŸ’¡ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´:"
echo "   - SSH í‚¤ ìƒì„± (ì—†ëŠ” ê²½ìš°)"
echo "   - ëª¨ë“  ë…¸ë“œì— ê³µê°œí‚¤ ë³µì‚¬"
echo "   - ì´í›„ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ì´ SSH ì ‘ì† ê°€ëŠ¥"
echo ""
echo "ğŸ“‹ ì„¤ì • íŒŒì¼: $CONFIG_FILE"
echo ""

# YAMLì—ì„œ ë…¸ë“œ ì •ë³´ ì½ê¸°
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CONFIG_FILE"
    exit 1
fi

echo "ğŸ“ $CONFIG_FILEì—ì„œ ë…¸ë“œ ì •ë³´ ì½ëŠ” ì¤‘..."
echo ""

# Pythonìœ¼ë¡œ ë…¸ë“œ ëª©ë¡ ì¶”ì¶œ (multi-headì™€ single-head ëª¨ë‘ ì§€ì›)
NODES=$(CONFIG_FILE="$CONFIG_FILE" python3 << 'EOFPY'
import yaml
import os

config_file = os.environ.get('CONFIG_FILE', 'my_cluster.yaml')

with open(config_file, 'r') as f:
    config = yaml.safe_load(f)

nodes_config = config['nodes']

# Use dict to deduplicate by hostname (first occurrence wins)
nodes_dict = {}

# Support both single-head (controller) and multi-head (controllers) formats
if 'controllers' in nodes_config and isinstance(nodes_config['controllers'], list):
    # Multi-head format: all controllers
    for node in nodes_config['controllers']:
        ssh_user = node['ssh_user']
        ip = node['ip_address']
        hostname = node['hostname']
        if hostname not in nodes_dict:
            nodes_dict[hostname] = f"{ssh_user}@{ip}#{hostname}"
elif 'controller' in nodes_config:
    # Single-head format: single controller
    controller = nodes_config['controller']
    ssh_user = controller['ssh_user']
    ip = controller['ip_address']
    hostname = controller['hostname']
    if hostname not in nodes_dict:
        nodes_dict[hostname] = f"{ssh_user}@{ip}#{hostname}"

# ê³„ì‚° ë…¸ë“œ
for node in nodes_config['compute_nodes']:
    ssh_user = node['ssh_user']
    ip = node['ip_address']
    hostname = node['hostname']
    if hostname not in nodes_dict:
        nodes_dict[hostname] = f"{ssh_user}@{ip}#{hostname}"

# Print all unique nodes
for node_info in nodes_dict.values():
    print(node_info)
EOFPY
)

if [ -z "$NODES" ]; then
    echo "âŒ ë…¸ë“œ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
    exit 1
fi

echo "ğŸ“‹ ì„¤ì •í•  ë…¸ë“œ ëª©ë¡:"
echo "$NODES" | while IFS='#' read -r user_ip hostname; do
    echo "  - $hostname ($user_ip)"
done
echo ""

# SSH í‚¤ í™•ì¸ ë° ìƒì„± (ë¨¼ì €!)
SSH_KEY="$HOME/.ssh/id_rsa"

if [ ! -f "$SSH_KEY" ]; then
    echo "ğŸ”‘ SSH í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤..."
    echo ""
    read -p "SSH í‚¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¹„ë°€ë²ˆí˜¸ ì—†ì´ í•˜ë ¤ë©´ ê·¸ëƒ¥ Enter) (y/N): " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # ë¹„ë°€ë²ˆí˜¸ ìˆëŠ” í‚¤
        ssh-keygen -t rsa -b 4096 -C "slurm-cluster-key"
    else
        # ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” í‚¤ (ê¶Œì¥)
        ssh-keygen -t rsa -b 4096 -C "slurm-cluster-key" -N ""
    fi

    if [ $? -eq 0 ]; then
        echo "âœ… SSH í‚¤ ìƒì„± ì™„ë£Œ: $SSH_KEY"
    else
        echo "âŒ SSH í‚¤ ìƒì„± ì‹¤íŒ¨!"
        exit 1
    fi
else
    echo "âœ… ê¸°ì¡´ SSH í‚¤ ì‚¬ìš©: $SSH_KEY"
fi

echo ""

# /etc/hosts ì—…ë°ì´íŠ¸
echo "ğŸ”§ /etc/hosts íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘..."
echo ""

# ë°±ì—… ìƒì„±
if [ -f /etc/hosts ]; then
    sudo cp /etc/hosts /etc/hosts.backup.$(date +%Y%m%d_%H%M%S)
fi

# í´ëŸ¬ìŠ¤í„° ì„¹ì…˜ ë§ˆì»¤
CLUSTER_START="# === HPC Cluster Nodes (Auto-generated by setup_ssh_passwordless.sh) ==="
CLUSTER_END="# === End of HPC Cluster Nodes ==="

# ê¸°ì¡´ í´ëŸ¬ìŠ¤í„° ì„¹ì…˜ ì œê±°
if grep -q "$CLUSTER_START" /etc/hosts 2>/dev/null; then
    sudo sed -i "/$CLUSTER_START/,/$CLUSTER_END/d" /etc/hosts
fi

# ìƒˆ í´ëŸ¬ìŠ¤í„° ì„¹ì…˜ ìƒì„±
{
    echo ""
    echo "$CLUSTER_START"
    echo "$NODES" | while IFS='#' read -r user_ip hostname; do
        ip=$(echo "$user_ip" | cut -d'@' -f2)
        echo "$ip    $hostname"
    done
    echo "$CLUSTER_END"
} | sudo tee -a /etc/hosts > /dev/null

echo "âœ… /etc/hosts ì—…ë°ì´íŠ¸ ì™„ë£Œ (ë°±ì—…: /etc/hosts.backup.*)"
echo ""

echo "================================================================================"
echo "ğŸ“¤ ê° ë…¸ë“œì— ê³µê°œí‚¤ ë³µì‚¬ ì¤‘..."
echo "================================================================================"
echo ""
echo "âš ï¸  ê° ë…¸ë“œì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆì”©ë§Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤."
echo "   ì´í›„ì—ëŠ” ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ìë™ìœ¼ë¡œ ì ‘ì†ë©ë‹ˆë‹¤!"
echo ""

SUCCESS_COUNT=0
FAIL_COUNT=0
FAILED_NODES=""

while IFS='#' read -r user_ip hostname; do
    echo "----------------------------------------"
    echo "ğŸ“¤ $hostname ($user_ip)"
    echo "----------------------------------------"

    # ssh-copy-idë¡œ ê³µê°œí‚¤ ë³µì‚¬
    ssh-copy-id -o StrictHostKeyChecking=no "$user_ip" 2>/dev/null

    if [ $? -eq 0 ]; then
        echo "âœ… $hostname: ê³µê°œí‚¤ ë³µì‚¬ ì™„ë£Œ"
        ((SUCCESS_COUNT++))

        # ì ‘ì† í…ŒìŠ¤íŠ¸
        echo "ğŸ” ì ‘ì† í…ŒìŠ¤íŠ¸ ì¤‘..."
        ssh -o BatchMode=yes -o ConnectTimeout=5 "$user_ip" "echo '   âœ… ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì ‘ì† ì„±ê³µ!'" 2>/dev/null

        if [ $? -ne 0 ]; then
            echo "   âš ï¸  ì ‘ì† í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”."
        else
            # NOPASSWD sudoers ì„¤ì • ì¶”ê°€
            echo "ğŸ”§ NOPASSWD sudoers ì„¤ì • ì¤‘..."
            echo "   (ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤)"
            USER_NAME=$(echo "$user_ip" | cut -d'@' -f1)

            # sudoers íŒŒì¼ ìƒì„± (ë¡œì»¬ì— ì„ì‹œ íŒŒì¼ë¡œ)
            SUDOERS_TMP="/tmp/cluster-sudoers.$$"
            cat > "$SUDOERS_TMP" << EOF
# Allow $USER_NAME to run cluster management commands without password
# Generated by setup_ssh_passwordless.sh
$USER_NAME ALL=(ALL) NOPASSWD: /bin/cp /tmp/hosts.tmp /etc/hosts
$USER_NAME ALL=(ALL) NOPASSWD: /bin/rm /tmp/hosts.tmp
$USER_NAME ALL=(ALL) NOPASSWD: /bin/mv /tmp/munge.key /etc/munge/
$USER_NAME ALL=(ALL) NOPASSWD: /bin/chown *
$USER_NAME ALL=(ALL) NOPASSWD: /bin/chmod *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart munge
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart redis
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart mariadb
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart keepalived
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl start *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl status *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl enable *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/dpkg -i *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/dpkg --configure -a
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/apt-get update
$USER_NAME ALL=(ALL) NOPASSWD: /usr/bin/apt-get install *
$USER_NAME ALL=(ALL) NOPASSWD: /bin/mkdir -p *
$USER_NAME ALL=(ALL) NOPASSWD: /usr/sbin/gluster *
EOF

            # sudoers íŒŒì¼ì„ ì›ê²© ë…¸ë“œì— ë³µì‚¬
            scp -o BatchMode=yes -o StrictHostKeyChecking=no "$SUDOERS_TMP" "$user_ip:/tmp/cluster-sudoers" 2>/dev/null

            # ì›ê²© ë…¸ë“œì—ì„œ sudoers íŒŒì¼ ì„¤ì¹˜ (interactive, stdinì€ ttyì—ì„œ)
            ssh -t -o StrictHostKeyChecking=no "$user_ip" "sudo bash -c 'visudo -c -f /tmp/cluster-sudoers && mv /tmp/cluster-sudoers /etc/sudoers.d/cluster-automation && chmod 440 /etc/sudoers.d/cluster-automation'" < /dev/tty

            if [ $? -eq 0 ]; then
                echo "   âœ… NOPASSWD sudoers ì„¤ì • ì™„ë£Œ"
            else
                echo "   âš ï¸  sudoers ì„¤ì • ì‹¤íŒ¨ (ì¼ë¶€ ëª…ë ¹ì— ë¹„ë°€ë²ˆí˜¸ í•„ìš”í•  ìˆ˜ ìˆìŒ)"
            fi

            # ë¡œì»¬ ì„ì‹œ íŒŒì¼ ì‚­ì œ
            rm -f "$SUDOERS_TMP"

            # /etc/hosts íŒŒì¼ ë³µì‚¬ (ì´ì œ NOPASSWDë¡œ ì‘ë™)
            echo "ğŸ”§ /etc/hosts íŒŒì¼ ë°°í¬ ì¤‘..."
            scp -o BatchMode=yes -o StrictHostKeyChecking=no /etc/hosts "$user_ip:/tmp/hosts.tmp" 2>/dev/null
            ssh -o BatchMode=yes -o StrictHostKeyChecking=no "$user_ip" "sudo cp /tmp/hosts.tmp /etc/hosts && sudo rm /tmp/hosts.tmp" 2>/dev/null

            if [ $? -eq 0 ]; then
                echo "   âœ… /etc/hosts ë°°í¬ ì™„ë£Œ"
            else
                echo "   âš ï¸  /etc/hosts ë°°í¬ ì‹¤íŒ¨ (ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬ í•„ìš”)"
            fi
        fi
    else
        echo "âŒ $hostname: ê³µê°œí‚¤ ë³µì‚¬ ì‹¤íŒ¨"
        ((FAIL_COUNT++))
        FAILED_NODES="$FAILED_NODES\n  - $hostname ($user_ip)"
    fi

    echo ""
done < <(echo "$NODES")

echo "================================================================================"
echo "âœ… SSH í‚¤ ì„¤ì • ì™„ë£Œ!"
echo "================================================================================"
echo ""

echo "ğŸ“Š ê²°ê³¼ ìš”ì•½:"
echo "  - ì„¤ì • ì™„ë£Œ: $SUCCESS_COUNTê°œ ë…¸ë“œ"
if [ $FAIL_COUNT -gt 0 ]; then
    echo "  - ì„¤ì • ì‹¤íŒ¨: $FAIL_COUNTê°œ ë…¸ë“œ"
    echo -e "    $FAILED_NODES"
fi
echo ""

echo "ğŸ§ª í…ŒìŠ¤íŠ¸:"
while IFS='#' read -r user_ip hostname; do
    echo "  ssh $user_ip 'hostname'"
done < <(echo "$NODES")
echo ""

echo "âœ¨ ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì´ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì‘ë™í•©ë‹ˆë‹¤:"
echo "  - ssh node001 'command'"
echo "  - scp file.txt node001:/tmp/"
echo "  - ./setup_cluster_full.sh  â† ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ì´ ì§„í–‰!"
echo ""

echo "================================================================================"
echo ""

# ìë™ í…ŒìŠ¤íŠ¸ ì œì•ˆ
read -p "ì§€ê¸ˆ SSH ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    echo ""
    echo "ğŸ§ª SSH ì ‘ì† í…ŒìŠ¤íŠ¸ ì¤‘..."
    echo ""

    while IFS='#' read -r user_ip hostname; do
        echo -n "  $hostname ($user_ip): "

        # ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì ‘ì† ì‹œë„
        RESULT=$(ssh -o BatchMode=yes -o ConnectTimeout=5 "$user_ip" "hostname" 2>/dev/null)

        if [ $? -eq 0 ]; then
            echo "âœ… $RESULT"
        else
            echo "âŒ ì ‘ì† ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•¨)"
        fi
    done < <(echo "$NODES")

    echo ""
fi

echo "================================================================================"
echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
echo ""
echo "  1. setup_cluster_full.sh ë˜ëŠ” setup_cluster_full_multihead.sh ì‹¤í–‰ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì—†ìŒ!)"
echo "     ./setup_cluster_full.sh"
echo "     ./setup_cluster_full_multihead.sh $CONFIG_FILE"
echo ""
echo "  2. ë˜ëŠ” ê°œë³„ ë…¸ë“œ ì ‘ì† í…ŒìŠ¤íŠ¸"
echo "     ssh <hostname>"
echo ""
echo "================================================================================"
