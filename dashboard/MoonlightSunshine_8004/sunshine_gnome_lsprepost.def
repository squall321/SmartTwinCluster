Bootstrap: docker
From: ubuntu:22.04

%post
    # Set non-interactive frontend
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Asia/Seoul

    # Update package lists
    apt-get update

    # Install basic utilities
    apt-get install -y \
        wget \
        curl \
        gnupg \
        software-properties-common \
        ca-certificates \
        apt-transport-https \
        tzdata \
        locales \
        build-essential

    # Set timezone and locale
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
    echo $TZ > /etc/timezone
    locale-gen ko_KR.UTF-8
    update-locale LANG=ko_KR.UTF-8

    # Install X11 and Desktop Environment (GNOME)
    apt-get install -y \
        gnome-session \
        gnome-terminal \
        gnome-control-center \
        gnome-system-monitor \
        nautilus \
        dbus-x11 \
        x11-xserver-utils \
        x11-utils \
        x11-apps \
        mesa-utils \
        libgl1-mesa-glx \
        libgl1-mesa-dri

    # Install NVIDIA Container Runtime libraries
    apt-get install -y \
        libnvidia-encode-535 \
        libnvidia-decode-535 \
        libnvidia-gl-535

    # Install Sunshine dependencies
    apt-get install -y \
        libssl3 \
        libavcodec58 \
        libavformat58 \
        libavutil56 \
        libswscale5 \
        libboost-filesystem1.74.0 \
        libboost-log1.74.0 \
        libboost-program-options1.74.0 \
        libboost-thread1.74.0 \
        libpulse0 \
        libopus0 \
        libevdev2 \
        libxtst6 \
        libx11-6 \
        libxrandr2 \
        libxfixes3 \
        libdrm2 \
        libwayland-client0 \
        libnuma1 \
        libcap2

    # Install PulseAudio
    apt-get install -y \
        pulseaudio \
        pulseaudio-utils \
        alsa-utils

    # Download and install Sunshine
    SUNSHINE_VERSION="0.23.1"
    wget -O /tmp/sunshine.deb \
        https://github.com/LizardByte/Sunshine/releases/download/v${SUNSHINE_VERSION}/sunshine-ubuntu-22.04-amd64.deb

    apt-get install -y /tmp/sunshine.deb || {
        echo "Failed to install Sunshine, trying with --fix-broken"
        apt-get install -f -y
        dpkg -i /tmp/sunshine.deb
    }

    rm /tmp/sunshine.deb

    # Verify Sunshine installation
    if ! command -v sunshine &> /dev/null; then
        echo "ERROR: Sunshine installation failed!"
        exit 1
    fi

    # Install CAE/Engineering tools prerequisites
    apt-get install -y \
        libgfortran5 \
        libgomp1 \
        libquadmath0 \
        libomp-dev \
        tcl \
        tk \
        libxmu6 \
        libxi6 \
        libxpm4 \
        libxft2

    # Install useful applications
    apt-get install -y \
        firefox \
        gedit \
        file-roller \
        vim \
        htop \
        gvfs \
        gvfs-backends

    # Install fonts
    apt-get install -y \
        fonts-noto \
        fonts-noto-cjk \
        fonts-noto-color-emoji \
        fonts-liberation

    # Create LS-PrePost installation directory
    # Note: Actual LS-PrePost binary should be bind-mounted or installed separately
    mkdir -p /opt/lsprepost
    mkdir -p /opt/cae

    # Create a placeholder script for LS-PrePost
    cat > /opt/lsprepost/lsprepost <<'EOF'
#!/bin/bash
# LS-PrePost Launcher
# Actual LS-PrePost should be bind-mounted to /opt/lsprepost/bin/

if [ -f /opt/lsprepost/bin/lsprepost ]; then
    exec /opt/lsprepost/bin/lsprepost "$@"
else
    echo "ERROR: LS-PrePost not found!"
    echo "Please bind-mount LS-PrePost installation to /opt/lsprepost/bin/"
    exit 1
fi
EOF

    chmod +x /opt/lsprepost/lsprepost

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Create required directories
    mkdir -p /opt/sunshine
    mkdir -p /var/log/sunshine

    # Create startup script for GNOME
    cat > /opt/sunshine/start_gnome.sh <<'EOF'
#!/bin/bash
# Start D-Bus
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax)
    export DBUS_SESSION_BUS_ADDRESS
    export DBUS_SESSION_BUS_PID
fi

# Add LS-PrePost to PATH if exists
if [ -d /opt/lsprepost/bin ]; then
    export PATH="/opt/lsprepost/bin:$PATH"
fi

# Start GNOME Session
exec gnome-session
EOF

    chmod +x /opt/sunshine/start_gnome.sh

%environment
    # Locale
    export LANG=ko_KR.UTF-8
    export LC_ALL=ko_KR.UTF-8

    # NVIDIA/CUDA environment
    export NVIDIA_VISIBLE_DEVICES=all
    export NVIDIA_DRIVER_CAPABILITIES=all

    # Mesa/GL
    export LIBGL_ALWAYS_INDIRECT=0

    # GNOME specific
    export XDG_SESSION_TYPE=x11
    export XDG_CURRENT_DESKTOP=GNOME

    # LS-PrePost specific
    export LSPP_HOME=/opt/lsprepost
    export PATH=/opt/lsprepost/bin:$PATH

%runscript
    exec sunshine "$@"

%labels
    Author koopark
    Version v1.0.0
    Description Sunshine streaming server with GNOME desktop and LS-PrePost
    ImageType gnome_lsprepost
    DesktopEnv gnome
    CAEApp lsprepost

%help
    Sunshine Desktop Container (GNOME + LS-PrePost)

    This container provides:
    - Ubuntu 22.04 base
    - GNOME Desktop Environment
    - Sunshine v0.23.1 streaming server
    - Hardware video encoding (NVENC via host GPU)
    - LS-PrePost CAE software support

    LS-PrePost Installation:
        This container expects LS-PrePost to be bind-mounted at runtime.

        Example:
            apptainer exec --nv --writable \
                --bind /path/to/lsprepost:/opt/lsprepost/bin \
                --bind /tmp/.X11-unix:/tmp/.X11-unix \
                --env DISPLAY=:10 \
                sunshine_gnome_lsprepost.sif \
                /opt/sunshine/start_gnome.sh

    Usage with Slurm/Apptainer:
        apptainer build --sandbox /scratch/sunshine_sandboxes/user_gnome_lsprepost \
            sunshine_gnome_lsprepost.sif

        apptainer exec --nv --writable \
            --bind /opt/lsprepost:/opt/lsprepost/bin \
            --bind /tmp/.X11-unix:/tmp/.X11-unix \
            --env DISPLAY=:10 \
            /scratch/sunshine_sandboxes/user_gnome_lsprepost \
            /opt/sunshine/start_gnome.sh
