# ========================================================================
# Moonlight/Sunshine Nginx Configuration
# ========================================================================
# 이 설정을 /etc/nginx/conf.d/auth-portal.conf에 추가
# ⚠️ 주의: 기존 파일에 추가 (새 파일 생성하지 말 것!)
#
# 추가 위치:
# 1. Upstream 정의: 파일 최상단 (server 블록 위)
# 2. /api/moonlight/: Line 102 (/api/ 위에)
# 3. /moonlight/signaling: Line 133 근처 (WebSocket 섹션)
# 4. /moonlight/: Line 220 근처 (Static files 섹션)
# ========================================================================

# ========================================================================
# 1. Upstream Definitions (파일 최상단에 추가)
# ========================================================================

upstream moonlight_backend {
    server 127.0.0.1:8004;
}

upstream moonlight_signaling {
    server 127.0.0.1:8005;
}

# Connection upgrade map for WebSocket (없으면 추가)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# ========================================================================
# 2. Moonlight API (Line 102 위에 추가 - /api/ 보다 먼저!)
# ========================================================================

    # Moonlight/Sunshine Backend API (Port 8004)
    # ⚠️ 주의: /api/ 위에 정의되어야 우선순위 확보
    # proxy_pass에 슬래시 없음 → /api/moonlight/images → http://127.0.0.1:8004/api/moonlight/images
    location /api/moonlight/ {
        proxy_pass http://moonlight_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

# ========================================================================
# 3. Moonlight WebSocket Signaling (Line 133 근처에 추가)
# ========================================================================

    # Moonlight WebRTC Signaling WebSocket (Port 8005)
    location /moonlight/signaling {
        proxy_pass http://moonlight_signaling;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket specific settings
        proxy_read_timeout 86400s;  # 24시간
        proxy_send_timeout 86400s;
        proxy_buffering off;
    }

# ========================================================================
# 4. Moonlight Frontend (Line 220 근처에 추가)
# ========================================================================

    # Moonlight Frontend (Static Files)
    location /moonlight/ {
        alias /var/www/html/moonlight/;
        try_files $uri $uri/ /moonlight/index.html;
        index index.html;

        # Enable gzip
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

        # Prevent caching of index.html
        location = /moonlight/index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Cache static assets
        location ~* /moonlight/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
