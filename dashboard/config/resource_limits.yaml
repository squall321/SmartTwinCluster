# Resource Limits Configuration
# N중화 배포 시 각 서버별 리소스 할당

# ==================== 전체 시스템 리소스 ====================
system:
  total_cpu_cores: 16  # 총 CPU 코어 수
  total_memory_gb: 64  # 총 메모리 (GB)

  # 서비스용 리소스 할당 (나머지는 다른 용도)
  allocated_cpu_cores: 8  # 서비스에 할당할 CPU 코어
  allocated_memory_gb: 32  # 서비스에 할당할 메모리

# ==================== 서비스별 리소스 제한 ====================
services:
  auth_backend:
    port: 4430
    cpu_quota: "100%"  # 1 CPU 코어
    memory_limit: "2G"
    workers: 2
    threads: 2
    max_requests: 1000

  auth_frontend:
    port: 4431
    # Vite dev server는 리소스 제한 불필요 (개발용)
    # Production에서는 static files (nginx)

  dashboard_backend:
    port: 5010
    cpu_quota: "200%"  # 2 CPU 코어
    memory_limit: "4G"
    workers: 4
    threads: 2
    max_requests: 1000

  websocket:
    port: 5011
    cpu_quota: "100%"  # 1 CPU 코어
    memory_limit: "2G"
    workers: 2
    threads: 4  # WebSocket은 스레드 많이
    max_requests: 5000

  cae_backend:
    port: 5000
    cpu_quota: "200%"  # 2 CPU 코어
    memory_limit: "8G"  # CAE는 메모리 많이 사용
    workers: 4
    threads: 2
    max_requests: 500  # CAE 작업은 무거움

  cae_automation:
    port: 5001
    cpu_quota: "200%"  # 2 CPU 코어
    memory_limit: "8G"
    workers: 4
    threads: 2
    max_requests: 500

# ==================== N중화 배포 설정 ====================
deployment:
  mode: "multi_server"  # single_server | multi_server

  servers:
    - name: "pc1"
      ip: "192.168.1.10"
      services: ["auth_backend", "auth_frontend", "dashboard_backend", "websocket", "cae_backend", "cae_automation"]
      priority: 1  # Primary server

    - name: "pc2"
      ip: "192.168.1.11"
      services: ["auth_backend", "dashboard_backend", "websocket", "cae_backend", "cae_automation"]
      priority: 2  # Secondary server

    - name: "pc3"
      ip: "192.168.1.12"
      services: ["dashboard_backend", "cae_backend", "cae_automation"]
      priority: 3  # Tertiary server (CAE 전용)

    - name: "pc4"
      ip: "192.168.1.13"
      services: ["cae_backend", "cae_automation"]
      priority: 4  # CAE 전용

# ==================== Load Balancing ====================
load_balancing:
  enabled: true
  strategy: "round_robin"  # round_robin | least_conn | ip_hash
  health_check:
    enabled: true
    interval: 10  # seconds
    timeout: 5
    path: "/health"

  # Nginx upstream 설정 자동 생성
  nginx_upstream:
    auth_backend:
      - "192.168.1.10:4430"
      - "192.168.1.11:4430"

    dashboard_backend:
      - "192.168.1.10:5010"
      - "192.168.1.11:5010"
      - "192.168.1.12:5010"

    cae_backend:
      - "192.168.1.10:5000"
      - "192.168.1.11:5000"
      - "192.168.1.12:5000"
      - "192.168.1.13:5000"

# ==================== Monitoring ====================
monitoring:
  prometheus:
    enabled: true
    port: 9090
    scrape_interval: 15  # seconds

  node_exporter:
    enabled: true
    port: 9100

  grafana:
    enabled: false
    port: 3000

# ==================== 리소스 계산 예시 ====================
# PC 1대 기준 (CPU 16코어, RAM 64GB)
# - Auth Backend: 1 CPU, 2GB = 6.25% CPU, 3.1% RAM
# - Dashboard Backend: 2 CPU, 4GB = 12.5% CPU, 6.3% RAM
# - WebSocket: 1 CPU, 2GB = 6.25% CPU, 3.1% RAM
# - CAE Backend: 2 CPU, 8GB = 12.5% CPU, 12.5% RAM
# - CAE Automation: 2 CPU, 8GB = 12.5% CPU, 12.5% RAM
# 합계: 8 CPU (50%), 24GB (37.5%)
# 나머지: 8 CPU (50%), 40GB (62.5%) 다른 용도로 사용 가능
