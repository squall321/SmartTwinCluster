# ========================================================================
# Nginx Performance Optimization - Server Block Settings
# ========================================================================
# 이 파일은 server {} 블록 내에 include 하세요
# 위치: /etc/nginx/sites-available/default 또는 /etc/nginx/conf.d/auth-portal.conf
# ========================================================================

# ==================== 정적 파일 캐싱 ====================

# JavaScript, CSS, Images, Fonts - 1년 캐싱
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|webp)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;  # 로그 비활성화로 I/O 절감

    # CORS (필요 시)
    add_header Access-Control-Allow-Origin "*" always;
}

# HTML 파일 - 캐싱 안 함 (항상 최신 버전)
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# JSON, XML - 짧은 캐싱 (5분)
location ~* \.(json|xml)$ {
    expires 5m;
    add_header Cache-Control "public, max-age=300" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# ==================== 보안 헤더 ====================
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# ==================== Rate Limiting 적용 (선택적) ====================

# API 요청 제한
# location /api/ {
#     limit_req zone=api_limit burst=20 nodelay;
#     proxy_pass http://backend_5010;
#     proxy_http_version 1.1;
#     proxy_set_header Connection "";
# }

# 로그인 요청 제한
# location /auth/login {
#     limit_req zone=login_limit burst=5 nodelay;
#     proxy_pass http://backend_4430;
#     proxy_http_version 1.1;
#     proxy_set_header Connection "";
# }

# ==================== API 캐싱 (선택적) ====================

# Slurm 노드 상태 - 5초 캐싱
# location /api/nodes {
#     proxy_cache api_cache;
#     proxy_cache_valid 200 5s;
#     proxy_cache_key "$request_uri|$http_x_username";
#     add_header X-Cache-Status $upstream_cache_status always;
#
#     proxy_pass http://backend_5010;
#     proxy_http_version 1.1;
#     proxy_set_header Connection "";
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
# }
