import { useState, useEffect } from 'react'
import './App.css'

interface VNCSession {
  session_id: string
  job_id: number
  status: string
  node?: string
  novnc_url?: string
  vnc_port: number
  novnc_port: number
  geometry: string
  image_id?: string
  image_name?: string
  created_at: string
}

interface VNCImage {
  id: string
  name: string
  description: string
  icon: string
  default: boolean
  available: boolean
}

function App() {
  const [sessions, setSessions] = useState<VNCSession[]>([])
  const [images, setImages] = useState<VNCImage[]>([])
  const [selectedImageId, setSelectedImageId] = useState<string>('xfce4')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [creating, setCreating] = useState(false)
  const [resetDialogSession, setResetDialogSession] = useState<string | null>(null)

  // URLì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸° ë° ì €ì¥
  useEffect(() => {
    const params = new URLSearchParams(window.location.search)
    const token = params.get('token')
    if (token) {
      localStorage.setItem('jwt_token', token)
      // URLì—ì„œ í† í° ì œê±° (ë³´ì•ˆ)
      window.history.replaceState({}, document.title, window.location.pathname)
    }
  }, [])

  // ì´ë¯¸ì§€ ëª©ë¡ ì¡°íšŒ
  const fetchImages = async () => {
    try {
      const token = localStorage.getItem('jwt_token')
      const response = await fetch('/dashboardapi/vnc/images', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })

      if (!response.ok) throw new Error('Failed to fetch images')

      const data = await response.json()
      setImages(data.images || [])

      // ê¸°ë³¸ ì´ë¯¸ì§€ ì„ íƒ
      const defaultImage = data.images.find((img: VNCImage) => img.default)
      if (defaultImage) {
        setSelectedImageId(defaultImage.id)
      }
    } catch (err: any) {
      console.error('Failed to load images:', err)
    }
  }

  // ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
  const fetchSessions = async () => {
    try {
      setLoading(true)
      const token = localStorage.getItem('jwt_token')
      const response = await fetch('/dashboardapi/vnc/sessions', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })

      if (!response.ok) throw new Error('Failed to fetch sessions')

      const data = await response.json()
      setSessions(data.sessions || [])
      setError('')
    } catch (err: any) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  // ì„¸ì…˜ ìƒì„±
  const createSession = async () => {
    try {
      setCreating(true)
      const token = localStorage.getItem('jwt_token')

      // ê¸°ì¡´ ì„¸ì…˜ì´ ìˆê³  ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•œ ê²½ìš° ê²½ê³ 
      const existingSession = sessions.find(s => s.status === 'running' || s.status === 'pending')
      if (existingSession && existingSession.image_id && existingSession.image_id !== selectedImageId) {
        const confirmed = confirm(
          `âš ï¸ ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€!\n\n` +
          `í˜„ì¬ ì„¸ì…˜: ${existingSession.image_name || existingSession.image_id}\n` +
          `ìƒˆ ì´ë¯¸ì§€: ${images.find(img => img.id === selectedImageId)?.name}\n\n` +
          `ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•˜ë©´ ê¸°ì¡´ ì„¸ì…˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n` +
          `ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        )

        if (!confirmed) {
          setCreating(false)
          return
        }

        // ê¸°ì¡´ ì„¸ì…˜ ì´ˆê¸°í™”
        await resetSession(existingSession.session_id)
      }

      const response = await fetch('/dashboardapi/vnc/sessions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          image_id: selectedImageId,
          geometry: '1920x1080',
          duration_hours: 4,
          gpu_count: 1
        })
      })

      if (!response.ok) throw new Error('Failed to create session')

      await fetchSessions()
      setError('')
    } catch (err: any) {
      setError(err.message)
    } finally {
      setCreating(false)
    }
  }

  // ì„¸ì…˜ ì‚­ì œ
  const deleteSession = async (sessionId: string) => {
    if (!confirm('ì„¸ì…˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return

    try {
      const token = localStorage.getItem('jwt_token')
      const response = await fetch(`/dashboardapi/vnc/sessions/${sessionId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })

      if (!response.ok) throw new Error('Failed to delete session')

      await fetchSessions()
    } catch (err: any) {
      setError(err.message)
    }
  }

  // ì„¸ì…˜ ì´ˆê¸°í™” (Sandbox ì‚­ì œ)
  const resetSession = async (sessionId: string) => {
    try {
      const token = localStorage.getItem('jwt_token')
      const response = await fetch(`/dashboardapi/vnc/sessions/${sessionId}/reset`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })

      if (!response.ok) throw new Error('Failed to reset session')

      await fetchSessions()
      setResetDialogSession(null)
    } catch (err: any) {
      setError(err.message)
    }
  }

  const handleResetClick = (sessionId: string) => {
    setResetDialogSession(sessionId)
  }

  const confirmReset = () => {
    if (resetDialogSession) {
      resetSession(resetDialogSession)
    }
  }

  // ì´ˆê¸° ë¡œë“œ ë° ìë™ ê°±ì‹ 
  useEffect(() => {
    fetchImages()
    fetchSessions()
    const interval = setInterval(fetchSessions, 5000) // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 
    return () => clearInterval(interval)
  }, [])

  const getStatusColor = (status: string) => {
    switch (status.toLowerCase()) {
      case 'running': return '#10b981'
      case 'pending': return '#f59e0b'
      case 'completed': return '#6b7280'
      default: return '#ef4444'
    }
  }

  const getStatusText = (status: string) => {
    switch (status.toLowerCase()) {
      case 'running': return 'ì‹¤í–‰ ì¤‘'
      case 'pending': return 'ëŒ€ê¸° ì¤‘'
      case 'completed': return 'ì™„ë£Œë¨'
      default: return status
    }
  }

  return (
    <div className="app">
      <header className="header">
        <div className="header-content">
          <h1>ğŸ–¥ï¸ VNC Visualization Service</h1>
          <p>GPU ê°€ì† ì›ê²© ë°ìŠ¤í¬í†±</p>
        </div>
        <div className="header-actions">
          <div className="image-selector">
            <label htmlFor="image-select">ë°ìŠ¤í¬í†± í™˜ê²½:</label>
            <select
              id="image-select"
              value={selectedImageId}
              onChange={(e) => setSelectedImageId(e.target.value)}
              className="image-select"
            >
              {images.filter(img => img.available).map(image => (
                <option key={image.id} value={image.id}>
                  {image.icon} {image.name}
                </option>
              ))}
            </select>
          </div>
          <button
            className="btn-primary"
            onClick={createSession}
            disabled={creating}
          >
            {creating ? 'ìƒì„± ì¤‘...' : '+ ìƒˆ ì„¸ì…˜'}
          </button>
        </div>
      </header>

      {error && (
        <div className="error-banner">
          âŒ {error}
        </div>
      )}

      <main className="main">
        <div className="sessions-grid">
          {loading && sessions.length === 0 ? (
            <div className="loading">ë¡œë”© ì¤‘...</div>
          ) : sessions.length === 0 ? (
            <div className="empty-state">
              <div className="empty-icon">ğŸ’»</div>
              <h3>í™œì„± ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</h3>
              <p>ìƒˆ VNC ì„¸ì…˜ì„ ìƒì„±í•˜ì—¬ ì›ê²© ë°ìŠ¤í¬í†±ì„ ì‹œì‘í•˜ì„¸ìš”</p>
            </div>
          ) : (
            sessions.map(session => (
              <div key={session.session_id} className="session-card">
                <div className="session-header">
                  <div>
                    <h3>
                      {session.image_name || 'VNC ì„¸ì…˜'} #{session.session_id.split('-').pop()}
                    </h3>
                    <span
                      className="status-badge"
                      style={{ backgroundColor: getStatusColor(session.status) }}
                    >
                      {getStatusText(session.status)}
                    </span>
                  </div>
                  <div className="session-actions-header">
                    <button
                      className="btn-reset"
                      onClick={() => handleResetClick(session.session_id)}
                      title="ì„¸ì…˜ ë°ì´í„° ì´ˆê¸°í™”"
                    >
                      ğŸ”„ ì´ˆê¸°í™”
                    </button>
                    <button
                      className="btn-danger"
                      onClick={() => deleteSession(session.session_id)}
                    >
                      ì¢…ë£Œ
                    </button>
                  </div>
                </div>

                <div className="session-info">
                  <div className="info-row">
                    <span className="label">Job ID:</span>
                    <span className="value">{session.job_id}</span>
                  </div>
                  <div className="info-row">
                    <span className="label">ë…¸ë“œ:</span>
                    <span className="value">{session.node || '-'}</span>
                  </div>
                  <div className="info-row">
                    <span className="label">í•´ìƒë„:</span>
                    <span className="value">{session.geometry}</span>
                  </div>
                  <div className="info-row">
                    <span className="label">VNC í¬íŠ¸:</span>
                    <span className="value">{session.vnc_port}</span>
                  </div>
                  <div className="info-row">
                    <span className="label">ìƒì„± ì‹œê°„:</span>
                    <span className="value">
                      {new Date(session.created_at).toLocaleString('ko-KR')}
                    </span>
                  </div>
                </div>

                {session.status === 'running' && session.novnc_url && (
                  <div className="session-actions">
                    <a
                      href={session.novnc_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="btn-connect"
                    >
                      ğŸš€ ì—°ê²°í•˜ê¸°
                    </a>
                  </div>
                )}

                {session.status === 'pending' && (
                  <div className="session-pending">
                    â³ ì„¸ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘...
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </main>

      {/* ì´ˆê¸°í™” í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */}
      {resetDialogSession && (
        <div className="dialog-overlay" onClick={() => setResetDialogSession(null)}>
          <div className="dialog" onClick={(e) => e.stopPropagation()}>
            <h2>âš ï¸ ì„¸ì…˜ ë°ì´í„° ì´ˆê¸°í™”</h2>
            <p>
              í˜„ì¬ ì„¸ì…˜ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.<br />
              ì„¸ì…˜ì´ ì¢…ë£Œë˜ê³  ìƒŒë“œë°•ìŠ¤ê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br />
              <br />
              <strong>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>
            </p>
            <div className="dialog-actions">
              <button className="btn-secondary" onClick={() => setResetDialogSession(null)}>
                ì·¨ì†Œ
              </button>
              <button className="btn-danger" onClick={confirmReset}>
                ì´ˆê¸°í™”
              </button>
            </div>
          </div>
        </div>
      )}

      <footer className="footer">
        <a href="/" className="back-link">
          â† Auth Portalë¡œ ëŒì•„ê°€ê¸°
        </a>
      </footer>
    </div>
  )
}

export default App
