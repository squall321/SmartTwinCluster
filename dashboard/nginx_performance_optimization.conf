# ========================================================================
# Nginx Performance Optimization Configuration
# ========================================================================
# 이 파일은 /etc/nginx/conf.d/auth-portal.conf에 추가하거나
# 별도의 성능 최적화 설정으로 include할 수 있습니다.
# ========================================================================

# ==================== Gzip 압축 (이미 있다면 확인/업데이트) ====================
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/x-javascript
    application/xhtml+xml
    application/atom+xml
    image/svg+xml
    text/x-component
    text/x-cross-domain-policy;

# ==================== 브라우저 캐싱 설정 ====================

# 정적 파일 (JS, CSS, Images, Fonts) - 1년 캐싱
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|webp)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;  # 로그 비활성화로 I/O 절감

    # CORS (필요 시)
    add_header Access-Control-Allow-Origin "*" always;
}

# HTML 파일 - 캐싱 안 함 (항상 최신 버전)
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# JSON, XML - 짧은 캐싱
location ~* \.(json|xml)$ {
    expires 5m;
    add_header Cache-Control "public, max-age=300" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# ==================== API 응답 캐싱 (선택적) ====================
# Nginx proxy_cache를 사용한 API 응답 캐싱
# 주의: 동적 데이터는 캐싱 TTL을 짧게 설정

# Proxy cache path 설정 (http 블록에 추가)
# proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60s;

# Slurm 노드 상태 API - 5초 캐싱
location /api/nodes {
    # proxy_cache api_cache;
    # proxy_cache_valid 200 5s;
    # proxy_cache_key "$request_uri|$http_x_username";  # 사용자별 캐시
    # add_header X-Cache-Status $upstream_cache_status always;

    proxy_pass http://backend_5010;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ==================== Connection Keep-Alive ====================
# Upstream 연결 재사용으로 성능 향상

upstream backend_5010 {
    server 127.0.0.1:5010;
    keepalive 32;  # Keep-alive 연결 수
}

upstream backend_5000 {
    server 127.0.0.1:5000;
    keepalive 32;
}

upstream backend_8004 {
    server 127.0.0.1:8004;
    keepalive 16;
}

# ==================== HTTP/2 Server Push (선택적) ====================
# HTTP/2가 활성화된 경우 주요 리소스 푸시

# location = /dashboard/index.html {
#     http2_push /dashboard/assets/index.js;
#     http2_push /dashboard/assets/index.css;
# }

# ==================== Open File Cache ====================
# 파일 디스크립터 캐싱으로 I/O 절감 (http 블록에 추가)

# open_file_cache max=10000 inactive=60s;
# open_file_cache_valid 120s;
# open_file_cache_min_uses 2;
# open_file_cache_errors on;

# ==================== Buffer 최적화 ====================
# Proxy buffer 크기 조정 (http 블록에 추가)

# proxy_buffering on;
# proxy_buffer_size 8k;
# proxy_buffers 32 8k;
# proxy_busy_buffers_size 16k;

# client_body_buffer_size 128k;
# client_max_body_size 100M;
# client_header_buffer_size 1k;
# large_client_header_buffers 4 8k;

# ==================== Rate Limiting (보안 + 성능) ====================
# API 요청 제한으로 DoS 방지 (http 블록에 추가)

# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
# limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

# location /api/ {
#     limit_req zone=api_limit burst=20 nodelay;
#     proxy_pass http://backend_5010;
# }

# location /auth/login {
#     limit_req zone=login_limit burst=5 nodelay;
#     proxy_pass http://auth_backend;
# }

# ==================== 로깅 최적화 ====================
# 정적 파일 로그 비활성화 (이미 위에 적용됨)
# 액세스 로그 버퍼링

# access_log /var/log/nginx/access.log combined buffer=64k flush=5s;
# error_log /var/log/nginx/error.log warn;

# ==================== Security Headers ====================
# 보안 헤더 추가

add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# ==================== TCP 최적화 (http 블록에 추가) ====================
# tcp_nopush on;
# tcp_nodelay on;
# sendfile on;
# sendfile_max_chunk 512k;

# ==================== Worker Connections (main 블록에 추가) ====================
# worker_processes auto;
# worker_rlimit_nofile 65535;
#
# events {
#     worker_connections 4096;
#     use epoll;
#     multi_accept on;
# }

# ========================================================================
# 적용 방법:
# 1. 이 파일을 /etc/nginx/conf.d/performance.conf로 복사
# 2. 기존 auth-portal.conf에서 중복 설정 제거
# 3. nginx -t로 문법 확인
# 4. systemctl reload nginx로 적용
# ========================================================================
