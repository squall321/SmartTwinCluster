# QoS ë¬¸ì œ ê·¼ë³¸ í•´ê²°: slurmdbd ì„¤ì¹˜

## ğŸ” ë¬¸ì œ ê·¼ë³¸ ì›ì¸

**`setup_cluster_full.sh`ì— slurmdbd ì„¤ì¹˜ ë‹¨ê³„ê°€ ë¹ ì ¸ìˆìŒ!**

QoS (Quality of Service)ëŠ” Slurmì˜ **Accounting** ê¸°ëŠ¥ì´ í•„ìš”í•œë°, ì´ê²ƒì€ `slurmdbd` (Slurm Database Daemon)ì´ ì œê³µí•©ë‹ˆë‹¤.

### í˜„ì¬ ìƒí™©
```
setup_cluster_full.sh ìˆœì„œ:
1. Munge ì„¤ì¹˜ âœ…
2. Slurm ì„¤ì¹˜ âœ…
3. Slurm ì„¤ì • âœ…
4. ì„œë¹„ìŠ¤ ì‹œì‘ âœ…
5. slurmdbd ì„¤ì¹˜ âŒ <- ë¹ ì§!
```

### ê²°ê³¼
- QoS ìƒì„± ì‹œë„ â†’ `sacctmgr` ì‹¤íŒ¨
- Apply Configuration ì‹¤íŒ¨
- Dashboardì—ì„œ ê·¸ë£¹ë³„ CPU ì œí•œ ë¶ˆê°€

## âœ… í•´ê²° ë°©ë²•

### 1. slurmdbd ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ

**`/home/koopark/claude/KooSlurmInstallAutomationRefactory/install_slurm_accounting.sh`**

ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ ìë™ìœ¼ë¡œ:
1. âœ… MariaDB ì„¤ì¹˜
2. âœ… slurm_acct_db ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
3. âœ… slurmdbd ë°”ì´ë„ˆë¦¬ í™•ì¸/ë¹Œë“œ
4. âœ… slurmdbd.conf ìƒì„±
5. âœ… slurmdbd ì„œë¹„ìŠ¤ ì‹œì‘
6. âœ… slurm.confì— Accounting ì„¤ì • ì¶”ê°€
7. âœ… Cluster ë° Account ë“±ë¡

### 2. ì¦‰ì‹œ ì ìš© ë°©ë²•

```bash
# 1. slurmdbd ì„¤ì¹˜
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory
chmod +x install_slurm_accounting.sh
sudo ./install_slurm_accounting.sh

# 2. Backend ì¬ì‹œì‘
cd dashboard/dashboard_refactory/backend_5010
./stop.sh
export MOCK_MODE=false
./start.sh

# 3. Apply Configuration í…ŒìŠ¤íŠ¸
# ë¸Œë¼ìš°ì €: System Management â†’ Apply Configuration
```

### 3. ê²€ì¦

ì„¤ì¹˜ í›„ í…ŒìŠ¤íŠ¸:

```bash
# QoS ëª©ë¡ í™•ì¸
sacctmgr show qos

# ì˜ˆìƒ ì¶œë ¥:
#       Name   Priority
# ---------- ----------
#     normal          0

# Cluster í™•ì¸
sacctmgr show cluster

# ì˜ˆìƒ ì¶œë ¥:
#    Cluster     ControlHost  ControlPort   RPC     Share GrpJobs       GrpTRES ...
# ---------- --------------- ------------ ----- --------- ------- ------------- ...
#  mycluster       localhost         6817  8192         1                       ...
```

## ğŸ“Š ì„¤ì¹˜ í›„ ë™ì‘

### Apply Configuration í”„ë¡œì„¸ìŠ¤

```
Frontend â†’ POST /api/slurm/apply-config
    â†“
Backend: apply_full_configuration(skip_qos=False)
    â†“
Step 1: Creating/Updating QoS
    â”œâ”€ sacctmgr add qos group1_qos âœ…
    â”œâ”€ sacctmgr modify qos MaxTRESPerJob=cpu=8192 âœ…
    â”œâ”€ sacctmgr modify qos Priority=1100 âœ…
    â””â”€ ëª¨ë“  ê·¸ë£¹ì˜ QoS ìƒì„± âœ…
    â†“
Step 2: Updating Partitions
    â”œâ”€ slurm.conf ë°±ì—… âœ…
    â”œâ”€ íŒŒí‹°ì…˜ ì„¹ì…˜ ì¬ìƒì„± (QoS í¬í•¨) âœ…
    â”œâ”€ scontrol show config (ê²€ì¦) âœ…
    â””â”€ scontrol reconfigure âœ…
    â†“
âœ… ì „ì²´ ì„±ê³µ!
```

### slurm.conf ì˜ˆì‹œ (QoS í¬í•¨)

```conf
# Partitions (Auto-generated by Dashboard)
PartitionName=group1 Nodes=node[001-064] Default=YES MaxTime=INFINITE State=UP QOS=group1_qos AllowQos=group1_qos
PartitionName=group2 Nodes=node[065-128] Default=YES MaxTime=INFINITE State=UP QOS=group2_qos AllowQos=group2_qos
```

## ğŸ”§ slurmdbd êµ¬ì„± ìš”ì†Œ

### 1. MariaDB ë°ì´í„°ë² ì´ìŠ¤

```sql
CREATE DATABASE slurm_acct_db;
CREATE USER 'slurm'@'localhost' IDENTIFIED BY 'slurmdbpass';
GRANT ALL ON slurm_acct_db.* TO 'slurm'@'localhost';
```

### 2. slurmdbd.conf

```conf
# /usr/local/slurm/etc/slurmdbd.conf
AuthType=auth/munge
DbdHost=localhost
StorageType=accounting_storage/mysql
StorageHost=localhost
StorageUser=slurm
StoragePass=slurmdbpass
StorageLoc=slurm_acct_db
LogFile=/var/log/slurm/slurmdbd.log
PidFile=/var/run/slurm/slurmdbd.pid
SlurmUser=slurm
```

**ì¤‘ìš”**: ê¶Œí•œì€ `600` (ì†Œìœ ìë§Œ ì½ê¸°/ì“°ê¸°)

### 3. slurm.confì— Accounting ì¶”ê°€

```conf
# Accounting
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost=localhost
AccountingStoragePort=6819
```

### 4. systemd ì„œë¹„ìŠ¤

```ini
[Unit]
Description=Slurm Database Daemon
After=network.target munge.service mariadb.service

[Service]
Type=forking
ExecStart=/usr/local/slurm/sbin/slurmdbd -D
PIDFile=/var/run/slurm/slurmdbd.pid

[Install]
WantedBy=multi-user.target
```

## ğŸ¯ QoS ê¸°ëŠ¥

slurmdbd ì„¤ì¹˜ í›„ ì‚¬ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥:

### 1. CPU ì œí•œ

```bash
# QoSì— ìµœëŒ€ CPU ì„¤ì •
sacctmgr -i modify qos group1_qos set MaxTRESPerJob=cpu=8192

# ì‘ì—… ì œì¶œ ì‹œ ìë™ ì œí•œ ì ìš©
sbatch --qos=group1_qos job.sh
```

### 2. ìš°ì„ ìˆœìœ„ ê´€ë¦¬

```bash
# ë†’ì€ ìš°ì„ ìˆœìœ„ QoS
sacctmgr -i modify qos high_priority set Priority=1000

# ë‚®ì€ ìš°ì„ ìˆœìœ„ QoS
sacctmgr -i modify qos low_priority set Priority=100
```

### 3. ì‘ì—… ì œí•œ

```bash
# ë™ì‹œ ì‹¤í–‰ ì‘ì—… ìˆ˜ ì œí•œ
sacctmgr -i modify qos group1_qos set MaxJobsPerUser=10

# ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ ì œí•œ
sacctmgr -i modify qos group1_qos set MaxWall=24:00:00
```

### 4. Accounting ì •ë³´

```bash
# ì‚¬ìš©ìë³„ ì‚¬ìš©ëŸ‰
sacct -u username

# ê·¸ë£¹ë³„ ì‚¬ìš©ëŸ‰
sreport cluster AccountUtilizationByUser
```

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: slurmdbd ì‹œì‘ ì‹¤íŒ¨

```bash
# ë¡œê·¸ í™•ì¸
sudo journalctl -u slurmdbd -n 50

# ë˜ëŠ”
sudo tail -50 /var/log/slurm/slurmdbd.log
```

**ì¼ë°˜ì ì¸ ì›ì¸:**
- MariaDBê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ: `sudo systemctl start mariadb`
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ë¹„ë°€ë²ˆí˜¸ í™•ì¸
- munge ë¬¸ì œ: `sudo systemctl restart munge`

### ë¬¸ì œ 2: sacctmgr ëª…ë ¹ì–´ ì‹¤íŒ¨

```bash
# slurmdbd ìƒíƒœ í™•ì¸
sudo systemctl status slurmdbd

# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
mysql -u slurm -pslurmdbpass -e "USE slurm_acct_db; SHOW TABLES;"
```

### ë¬¸ì œ 3: QoSê°€ ì ìš©ë˜ì§€ ì•ŠìŒ

```bash
# slurmctld ì¬ì‹œì‘
sudo systemctl restart slurmctld

# ì„¤ì • í™•ì¸
scontrol show config | grep Accounting
```

## ğŸ“‹ setup_cluster_full.sh ìˆ˜ì • í•„ìš”

í–¥í›„ `setup_cluster_full.sh`ì— ë‹¤ìŒ ë‹¨ê³„ë¥¼ **Step 6.5**ë¡œ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤:

```bash
################################################################################
# Step 6.5: Slurm Accounting (slurmdbd) ì„¤ì¹˜
################################################################################

echo "ğŸ—„ï¸  Step 6.5/13: Slurm Accounting (slurmdbd) ì„¤ì¹˜..."
echo "--------------------------------------------------------------------------------"
echo "slurmdbdëŠ” QoS ê¸°ëŠ¥ì— í•„ìˆ˜ì…ë‹ˆë‹¤."
echo ""

read -p "slurmdbdë¥¼ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    if [ -f "install_slurm_accounting.sh" ]; then
        chmod +x install_slurm_accounting.sh
        sudo ./install_slurm_accounting.sh
        
        if [ $? -eq 0 ]; then
            echo "âœ… slurmdbd ì„¤ì¹˜ ì™„ë£Œ"
        else
            echo "âš ï¸  slurmdbd ì„¤ì¹˜ ì‹¤íŒ¨ (QoS ê¸°ëŠ¥ ë¹„í™œì„±í™”)"
        fi
    else
        echo "âš ï¸  install_slurm_accounting.shë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    fi
else
    echo "â­ï¸  slurmdbd ì„¤ì¹˜ ê±´ë„ˆëœ€ (QoS ê¸°ëŠ¥ ë¹„í™œì„±í™”)"
fi

echo ""
```

## ğŸ“ ê°œë… ì •ë¦¬

### QoSê°€ ì—†ì–´ë„ Slurmì€ ì‘ë™í•˜ëŠ”ê°€?

**YES!** QoSëŠ” ì„ íƒ ì‚¬í•­ì…ë‹ˆë‹¤.

| ê¸°ëŠ¥ | QoS ì—†ìŒ | QoS ìˆìŒ |
|------|----------|----------|
| **ì‘ì—… ì œì¶œ** | âœ… | âœ… |
| **íŒŒí‹°ì…˜ ì‚¬ìš©** | âœ… | âœ… |
| **ë¦¬ì†ŒìŠ¤ í• ë‹¹** | âœ… | âœ… |
| **CPU ì œí•œ** | âŒ | âœ… |
| **ìš°ì„ ìˆœìœ„** | âŒ | âœ… |
| **ì‚¬ìš©ëŸ‰ ì¶”ì ** | âŒ | âœ… |

### QoSë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°

1. **ë©€í‹° í…Œë„ŒíŠ¸ í™˜ê²½**: ì—¬ëŸ¬ ê·¸ë£¹/ì‚¬ìš©ìê°€ í´ëŸ¬ìŠ¤í„° ê³µìœ 
2. **ë¦¬ì†ŒìŠ¤ ì œí•œ í•„ìš”**: ê·¸ë£¹ë³„ CPU/ë©”ëª¨ë¦¬ ì œí•œ
3. **ìš°ì„ ìˆœìœ„ ê´€ë¦¬**: VIP ì‚¬ìš©ìì—ê²Œ ë†’ì€ ìš°ì„ ìˆœìœ„
4. **Accounting í•„ìš”**: ì‚¬ìš©ëŸ‰ ì¶”ì  ë° ê³¼ê¸ˆ
5. **Fair Share**: ê³µì •í•œ ë¦¬ì†ŒìŠ¤ ë¶„ë°°

### Dashboardì™€ QoS

Dashboardì˜ `Apply Configuration`ì€:
- **QoS ìˆìŒ**: ê·¸ë£¹ë³„ CPU ì œí•œ ì ìš©
- **QoS ì—†ìŒ**: Partitionë§Œ ìƒì„± (ì œí•œ ì—†ìŒ)

ë‘˜ ë‹¤ ì‘ë™í•˜ì§€ë§Œ, QoSê°€ ìˆìœ¼ë©´ ë” ì„¸ë°€í•œ ì œì–´ ê°€ëŠ¥.

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

ì„¤ì¹˜ í›„ í™•ì¸:

- [ ] MariaDB ì‹¤í–‰: `sudo systemctl status mariadb`
- [ ] slurmdbd ì‹¤í–‰: `sudo systemctl status slurmdbd`
- [ ] slurmctld ì‹¤í–‰: `sudo systemctl status slurmctld`
- [ ] QoS ëª©ë¡: `sacctmgr show qos`
- [ ] Cluster ë“±ë¡: `sacctmgr show cluster`
- [ ] Apply Configuration ì„±ê³µ
- [ ] Job Templatesì—ì„œ ê·¸ë£¹ ëª©ë¡ í™•ì¸

---

**ì‘ì„±ì¼**: 2025-10-11  
**ìƒì„± íŒŒì¼**:
- `install_slurm_accounting.sh` - slurmdbd ìë™ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸

**ìˆ˜ì • íŒŒì¼**:
- `slurm_config_manager.py` - skip_qos ê¸°ë³¸ê°’ Falseë¡œ ë³€ê²½

**í•´ê²°ëœ ë¬¸ì œ**:
- QoS ìƒì„± ì‹¤íŒ¨ (slurmdbd ë¯¸ì„¤ì¹˜)
- Apply Configuration ì‹¤íŒ¨
- setup_cluster_full.shì— slurmdbd ë‹¨ê³„ ëˆ„ë½

**ë‹¤ìŒ ë‹¨ê³„**:
1. `install_slurm_accounting.sh` ì‹¤í–‰
2. Backend ì¬ì‹œì‘
3. Apply Configuration í…ŒìŠ¤íŠ¸
4. `setup_cluster_full.sh`ì— slurmdbd ë‹¨ê³„ ì¶”ê°€ (í–¥í›„)
