# Redis Cluster Configuration Template
# Generated by cluster/setup/phase2_redis.sh
# This file should be placed at /etc/redis/redis.conf

################################## NETWORK #####################################

# Bind to specific interface
# TEMPLATE_VARIABLE: bind
bind {{BIND_ADDRESS}}

# Accept connections on specified port
port {{REDIS_PORT}}

# TCP listen() backlog
tcp-backlog 511

# Close connection after client idle for N seconds (0 to disable)
timeout 0

# TCP keepalive
tcp-keepalive 300

# Protected mode (disable for cluster)
protected-mode no

################################# GENERAL #####################################

# Run as daemon
daemonize yes

# PID file location
pidfile /var/run/redis/redis-server.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Number of databases (cluster mode uses db 0 only)
databases 16

# Show Redis logo on startup
always-show-logo no

################################ SNAPSHOTTING  ################################

# Save the DB on disk:
# save <seconds> <changes>
save 900 1
save 300 10
save 60 10000

# Stop writes if save fails
stop-writes-on-bgsave-error yes

# Compress string objects using LZF
rdbcompression yes

# Checksum at the end of the file
rdbchecksum yes

# The filename where to dump the DB
dbfilename dump.rdb

# The working directory
dir /var/lib/redis

################################# REPLICATION #################################

# Replication mode
# TEMPLATE_VARIABLE: replicaof (only for Sentinel mode)
# replicaof <masterip> <masterport>

# Replica serves read-only queries
replica-read-only yes

# Replicas send PINGs to master
repl-ping-replica-period 10

# Replication timeout
repl-timeout 60

# Disable TCP_NODELAY on replica socket
repl-disable-tcp-nodelay no

# Replica priority for Sentinel
replica-priority 100

################################## SECURITY ###################################

# Require password
# TEMPLATE_VARIABLE: requirepass
requirepass {{REDIS_PASSWORD}}

# Master password (for replica)
# TEMPLATE_VARIABLE: masterauth (only for Sentinel mode)
# masterauth <master-password>

################################### CLIENTS ####################################

# Max number of connected clients
# TEMPLATE_VARIABLE: maxclients
maxclients {{MAX_CLIENTS}}

############################## MEMORY MANAGEMENT ################################

# Max memory limit
# TEMPLATE_VARIABLE: maxmemory
maxmemory {{MAX_MEMORY}}

# Max memory policy when limit reached
# Options: noeviction, allkeys-lru, allkeys-lfu, volatile-lru, volatile-lfu,
#          allkeys-random, volatile-random, volatile-ttl
maxmemory-policy allkeys-lru

# LRU/LFU/minimal TTL algorithm samples
maxmemory-samples 5

# Evict expired keys
# Options: no, volatile, allkeys
# maxmemory-eviction-policy noeviction

############################# LAZY FREEING ####################################

# Lazy freeing useful for performance
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

############################## APPEND ONLY MODE ###############################

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF fsync mode
# Options: always, everysec, no
appendfsync everysec

# Don't fsync during rewrite
no-appendfsync-on-rewrite no

# Auto rewrite AOF file
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file
aof-load-truncated yes

# Use RDB-AOF mixed format
aof-use-rdb-preamble yes

################################ REDIS CLUSTER  ###############################

# Enable cluster mode
# TEMPLATE_VARIABLE: cluster-enabled
cluster-enabled {{CLUSTER_ENABLED}}

# Cluster configuration file (auto-generated)
cluster-config-file /var/lib/redis/nodes.conf

# Cluster node timeout
cluster-node-timeout 15000

# Replica validity factor
cluster-replica-validity-factor 10

# Minimum number of replicas for master availability
cluster-require-full-coverage yes

# Allow reads from replicas during failures
cluster-allow-reads-when-down no

################################## SLOW LOG ###################################

# Slow log threshold in microseconds
slowlog-log-slower-than 10000

# Slow log max entries
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

# Latency monitoring threshold
latency-monitor-threshold 100

############################# EVENT NOTIFICATION ##############################

# Keyspace notifications
# K - Keyspace events
# E - Keyevent events
# g - Generic commands (DEL, EXPIRE, RENAME, ...)
# $ - String commands
# l - List commands
# s - Set commands
# h - Hash commands
# z - Sorted set commands
# x - Expired events
# e - Evicted events
# A - Alias for "g$lshzxe"
notify-keyspace-events ""

############################### ADVANCED CONFIG ###############################

# Hash data structure optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List data structure optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set data structure optimization
set-max-intset-entries 512

# Sorted set data structure optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# Stream macro node max size
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
# client-query-buffer-limit 1gb

# Protocol max bulk length
# proto-max-bulk-len 512mb

# Frequency of rehashing
hz 10

# Dynamic HZ
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

################################ REDIS SENTINEL ###############################
# Only used in Sentinel mode (2-node deployments)

# Sentinel monitor configuration
# TEMPLATE_VARIABLE: sentinel monitor (only for Sentinel mode)
# sentinel monitor mymaster {{MASTER_IP}} {{MASTER_PORT}} 2
# sentinel auth-pass mymaster {{REDIS_PASSWORD}}
# sentinel down-after-milliseconds mymaster 5000
# sentinel parallel-syncs mymaster 1
# sentinel failover-timeout mymaster 10000

################################## INCLUDES ###################################

# Include additional config files
# include /path/to/local.conf
# include /path/to/other.conf
