#!/bin/bash
################################################################################
# Munge ìë™ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ (ë¹„ë°€ë²ˆí˜¸ ìºì‹±)
# ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆë§Œ ì…ë ¥í•˜ê³  ëª¨ë“  ë…¸ë“œì— ì ìš©
################################################################################

set -e

USER_NAME="koopark"
NODES=("192.168.122.90" "192.168.122.103")
NODE_NAMES=("node1" "node2")

echo "================================================================================"
echo "ğŸ” Munge ìë™ ì„¤ì¹˜ (ë¹„ë°€ë²ˆí˜¸ ìºì‹±)"
echo "================================================================================"
echo ""
echo "ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì„ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤:"
echo "  1. ì»¨íŠ¸ë¡¤ëŸ¬ì— Munge ì„¤ì¹˜ ë° í‚¤ ìƒì„±"
echo "  2. ê³„ì‚° ë…¸ë“œì— Munge ì„¤ì¹˜"
echo "  3. Munge í‚¤ ë°°í¬"
echo "  4. ì„œë¹„ìŠ¤ ì‹œì‘ ë° ê²€ì¦"
echo ""
echo "ëŒ€ìƒ ë…¸ë“œ:"
echo "  - ì»¨íŠ¸ë¡¤ëŸ¬: smarttwincluster (localhost)"
for i in "${!NODES[@]}"; do
  echo "  - ${NODE_NAMES[$i]}: ${NODES[$i]}"
done
echo ""

read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
  echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
  exit 0
fi

echo ""
echo "================================================================================"
echo "ğŸ“ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
echo "================================================================================"
echo ""
echo "ë…¸ë“œë“¤ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
echo "(ëª¨ë“  ë…¸ë“œì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤)"
echo ""

# ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
read -s -p "ë¹„ë°€ë²ˆí˜¸: " PASSWORD
echo ""

if [ -z "$PASSWORD" ]; then
  echo "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
  exit 1
fi

# ë¹„ë°€ë²ˆí˜¸ í™•ì¸
read -s -p "ë¹„ë°€ë²ˆí˜¸ í™•ì¸: " PASSWORD_CONFIRM
echo ""

if [ "$PASSWORD" != "$PASSWORD_CONFIRM" ]; then
  echo "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  exit 1
fi

echo ""
echo "âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ"

# sshpass ì„¤ì¹˜ í™•ì¸
if ! command -v sshpass &> /dev/null; then
    echo ""
    echo "ğŸ“¦ sshpass ì„¤ì¹˜ ì¤‘..."
    sudo apt-get update > /dev/null 2>&1
    sudo apt-get install -y sshpass > /dev/null 2>&1 || sudo yum install -y sshpass > /dev/null 2>&1
    
    if ! command -v sshpass &> /dev/null; then
        echo "âŒ sshpass ì„¤ì¹˜ ì‹¤íŒ¨"
        echo "ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”: sudo apt install sshpass"
        exit 1
    fi
fi

echo ""
echo "================================================================================"
echo "1ë‹¨ê³„: ì»¨íŠ¸ë¡¤ëŸ¬ Munge ì„¤ì¹˜"
echo "================================================================================"
echo ""

chmod +x install_munge_manual.sh
sudo ./install_munge_manual.sh controller

if [ $? -ne 0 ]; then
    echo "âŒ ì»¨íŠ¸ë¡¤ëŸ¬ Munge ì„¤ì¹˜ ì‹¤íŒ¨"
    exit 1
fi

echo ""
echo "âœ… ì»¨íŠ¸ë¡¤ëŸ¬ Munge ì„¤ì¹˜ ì™„ë£Œ"

echo ""
echo "================================================================================"
echo "2ë‹¨ê³„: ê³„ì‚° ë…¸ë“œ Munge ì„¤ì¹˜"
echo "================================================================================"
echo ""

PASSWORD_WORKS=true

for i in "${!NODES[@]}"; do
    node="${NODES[$i]}"
    node_name="${NODE_NAMES[$i]}"
    
    echo "ğŸ“Œ $node_name ($node)"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    # ì—°ê²° í…ŒìŠ¤íŠ¸
    echo "  [1/5] SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
    if ! sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 $USER_NAME@$node "echo OK" > /dev/null 2>&1; then
        echo "  âŒ SSH ì—°ê²° ì‹¤íŒ¨ - ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        PASSWORD_WORKS=false
        
        # ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥
        echo ""
        echo "  ğŸ”‘ $node_nameì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:"
        read -s -p "  ë¹„ë°€ë²ˆí˜¸: " NEW_PASSWORD
        echo ""
        
        # ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¬ì‹œë„
        if ! sshpass -p "$NEW_PASSWORD" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 $USER_NAME@$node "echo OK" > /dev/null 2>&1; then
            echo "  âŒ ì—°ê²° ì‹¤íŒ¨. ì´ ë…¸ë“œëŠ” ê±´ë„ˆëœë‹ˆë‹¤."
            continue
        fi
        
        PASSWORD="$NEW_PASSWORD"
        echo "  âœ… ì—°ê²° ì„±ê³µ"
    else
        echo "  âœ… ì—°ê²° ì„±ê³µ"
    fi
    
    # ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
    echo "  [2/5] ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬..."
    sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no install_munge_manual.sh $USER_NAME@$node:/tmp/ > /dev/null 2>&1
    
    # Munge ì„¤ì¹˜
    echo "  [3/5] Munge ì„¤ì¹˜ ì¤‘..."
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USER_NAME@$node \
        "cd /tmp && chmod +x install_munge_manual.sh && echo '$PASSWORD' | sudo -S ./install_munge_manual.sh" > /dev/null 2>&1
    
    # í‚¤ ë³µì‚¬
    echo "  [4/5] Munge í‚¤ ë³µì‚¬..."
    sudo scp /etc/munge/munge.key $USER_NAME@$node:/tmp/ > /dev/null 2>&1
    
    # í‚¤ ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ì‹œì‘
    echo "  [5/5] Munge í‚¤ ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ ì‹œì‘..."
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USER_NAME@$node \
        "echo '$PASSWORD' | sudo -S bash -c 'mv /tmp/munge.key /etc/munge/ && chown munge:munge /etc/munge/munge.key && chmod 400 /etc/munge/munge.key && systemctl restart munge'" > /dev/null 2>&1
    
    echo "  âœ… $node_name ì™„ë£Œ"
    echo ""
done

echo "================================================================================"
echo "3ë‹¨ê³„: Munge ê²€ì¦"
echo "================================================================================"
echo ""

all_success=true

# ì»¨íŠ¸ë¡¤ëŸ¬ ê²€ì¦
echo -n "ğŸ“Œ ì»¨íŠ¸ë¡¤ëŸ¬ (smarttwincluster): "
if munge -n | unmunge > /dev/null 2>&1; then
    echo "âœ… ì •ìƒ"
else
    echo "âŒ ì‹¤íŒ¨"
    all_success=false
fi

# ê³„ì‚° ë…¸ë“œ ê²€ì¦
for i in "${!NODES[@]}"; do
    node="${NODES[$i]}"
    node_name="${NODE_NAMES[$i]}"
    
    echo -n "ğŸ“Œ $node_name ($node): "
    
    result=$(sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USER_NAME@$node "munge -n | unmunge 2>&1" 2>/dev/null)
    
    if echo "$result" | grep -q "Success"; then
        echo "âœ… ì •ìƒ"
    else
        echo "âŒ ì‹¤íŒ¨"
        all_success=false
    fi
done

echo ""
echo "================================================================================"
echo "4ë‹¨ê³„: ë…¸ë“œ ê°„ ì¸ì¦ í…ŒìŠ¤íŠ¸"
echo "================================================================================"
echo ""

for i in "${!NODES[@]}"; do
    node="${NODES[$i]}"
    node_name="${NODE_NAMES[$i]}"
    
    echo -n "ğŸ“Œ ì»¨íŠ¸ë¡¤ëŸ¬ â†’ $node_name: "
    
    if munge -n | sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USER_NAME@$node unmunge 2>/dev/null | grep -q "Success"; then
        echo "âœ… ì¸ì¦ ì„±ê³µ"
    else
        echo "âŒ ì¸ì¦ ì‹¤íŒ¨"
        all_success=false
    fi
done

echo ""
echo "================================================================================"

if [ "$all_success" = true ]; then
    echo "ğŸ‰ Munge ì„¤ì¹˜ ë° ê²€ì¦ ì™„ë£Œ!"
    echo "================================================================================"
    echo ""
    echo "âœ… ëª¨ë“  ë…¸ë“œì—ì„œ Mungeê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."
    echo ""
    echo "ë‹¤ìŒ ë‹¨ê³„:"
    echo "  1. Slurm ì„¤ì¹˜ ê³„ì† ì§„í–‰"
    echo "  2. ë˜ëŠ”: ./setup_cluster_full.sh"
else
    echo "âš ï¸  ì¼ë¶€ ë…¸ë“œì—ì„œ Munge ì„¤ì • ì‹¤íŒ¨"
    echo "================================================================================"
    echo ""
    echo "ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤:"
    echo "  1. ê° ë…¸ë“œì—ì„œ: systemctl status munge"
    echo "  2. ê° ë…¸ë“œì—ì„œ: munge -n | unmunge"
    echo "  3. ë¡œê·¸ í™•ì¸: journalctl -u munge -n 50"
fi

echo ""
