#!/bin/bash
################################################################################
# í†µí•© ìžë™í™” ìŠ¤í¬ë¦½íŠ¸ - Slurm 23.11.x + cgroup v2 ì™„ì „ ì§€ì›
# Slurm í´ëŸ¬ìŠ¤í„° + MPI + Apptainer + cgroup v2 ì™„ì „ ìžë™ ì„¤ì¹˜
################################################################################

set -e  # ì—ëŸ¬ ë°œìƒì‹œ ì¤‘ë‹¨

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"


echo ""

################################################################################
# Step 2: ê°€ìƒí™˜ê²½ í™œì„±í™”
################################################################################

echo "ðŸ Step 2/11: Python ê°€ìƒí™˜ê²½ í™•ì¸..."
echo "--------------------------------------------------------------------------------"

if [ ! -d "venv" ]; then
    echo "âš ï¸  ê°€ìƒí™˜ê²½ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
    python3 -m venv venv
fi

source venv/bin/activate
echo "âœ… ê°€ìƒí™˜ê²½ í™œì„±í™” ì™„ë£Œ"
echo ""

################################################################################
# Step 3: ì„¤ì • ê²€ì¦
################################################################################

echo "ðŸ” Step 3/11: ì„¤ì • íŒŒì¼ ê²€ì¦..."
echo "--------------------------------------------------------------------------------"

if [ -f "validate_config.py" ]; then
    python3 validate_config.py my_cluster.yaml
    if [ $? -ne 0 ]; then
        echo "âŒ ì„¤ì • íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨"
        exit 1
    fi
    echo "âœ… ì„¤ì • íŒŒì¼ ê²€ì¦ ì™„ë£Œ"
else
    echo "âš ï¸  validate_config.pyê°€ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
fi

echo ""

################################################################################
# Step 4: SSH ì—°ê²° í…ŒìŠ¤íŠ¸
################################################################################

echo "ðŸ”— Step 4/11: SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
echo "--------------------------------------------------------------------------------"

if [ -f "test_connection.py" ]; then
    python3 test_connection.py my_cluster.yaml
    if [ $? -ne 0 ]; then
        echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
        echo "ðŸ’¡ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:"
        echo "   1. SSH í‚¤ ìƒì„±: ssh-keygen -t rsa -b 4096"
        echo "   2. ê³µê°œí‚¤ ë³µì‚¬: ssh-copy-id koopark@192.168.122.90"
        echo "   3. ì—°ê²° í…ŒìŠ¤íŠ¸: ssh 192.168.122.90 'hostname'"
        exit 1
    fi
    echo "âœ… SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
else
    echo "âš ï¸  test_connection.pyê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ SSH í™•ì¸í•˜ì„¸ìš”."
fi

echo ""

################################################################################
# Step 4.5: RebootProgram ì„¤ì • (YAML ê¸°ë°˜ ìžë™)
################################################################################

# YAMLì— reboot_programì´ ì •ì˜ë˜ì–´ ìžˆìœ¼ë©´ ìžë™ìœ¼ë¡œ ì„¤ì •
if [ -f "my_cluster.yaml" ] && grep -q "reboot_program:" my_cluster.yaml; then
    echo "ðŸ”„ Step 4.5/11: RebootProgram ìžë™ ì„¤ì • (YAML ê¸°ë°˜)..."
    echo "--------------------------------------------------------------------------------"
    echo "âœ… YAMLì— reboot_program ì„¤ì •ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo "   ì›¹ ëŒ€ì‹œë³´ë“œì—ì„œ ë…¸ë“œ ìž¬ë¶€íŒ… ê¸°ëŠ¥ì„ ìœ„í•œ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤."
    echo ""
    
    if [ -f "./setup_reboot_program.sh" ]; then
        ./setup_reboot_program.sh
        
        if [ $? -eq 0 ]; then
            echo "âœ… RebootProgram ì„¤ì • ì™„ë£Œ"
        else
            echo "âš ï¸  RebootProgram ì„¤ì • ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        fi
    else
        echo "âš ï¸  setup_reboot_program.shë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "   ë¨¼ì € ./refactor_reboot_setup_to_yaml_fixed.shë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
    fi
    
    echo ""
else
    echo "â„¹ï¸  YAMLì— reboot_program ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤ (ì›¹ ìž¬ë¶€íŒ… ê¸°ëŠ¥ ë¹„í™œì„±í™”)"
    echo ""
fi


################################################################################
# Step 5: Munge ì„¤ì¹˜
################################################################################

echo "ðŸ” Step 5/11: Munge ì¸ì¦ ì‹œìŠ¤í…œ ì„¤ì¹˜..."
echo "--------------------------------------------------------------------------------"
echo "MungeëŠ” Slurm ë…¸ë“œ ê°„ ì¸ì¦ì— í•„ìˆ˜ìž…ë‹ˆë‹¤."
echo ""

read -p "Mungeë¥¼ ìžë™ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    if [ -f "install_munge_auto.sh" ]; then
        chmod +x install_munge_auto.sh
        ./install_munge_auto.sh
        
        if [ $? -eq 0 ]; then
            echo "âœ… Munge ìžë™ ì„¤ì¹˜ ì™„ë£Œ"
        else
            echo "âš ï¸  Munge ìžë™ ì„¤ì¹˜ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        fi
    else
        echo "âš ï¸  install_munge_auto.shê°€ ì—†ìŠµë‹ˆë‹¤."
        echo "ðŸ’¡ ìˆ˜ë™ìœ¼ë¡œ Mungeë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”."
    fi
else
    echo "â­ï¸  Munge ì„¤ì¹˜ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 6: Slurm 23.11.x + cgroup v2 ì„¤ì¹˜ (ì»¨íŠ¸ë¡¤ëŸ¬)
################################################################################

echo "ðŸš€ Step 6/11: Slurm 23.11.x + cgroup v2 ì„¤ì¹˜ (ì»¨íŠ¸ë¡¤ëŸ¬)..."
echo "--------------------------------------------------------------------------------"
echo "Slurm 23.11.10ì„ cgroup v2 ì™„ì „ ì§€ì›ìœ¼ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤."
echo "(ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤ - ì•½ 15-20ë¶„)"
echo ""

read -p "ì»¨íŠ¸ë¡¤ëŸ¬ì— Slurmì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    chmod +x install_slurm_cgroup_v2.sh
    sudo bash install_slurm_cgroup_v2.sh
    
    if [ $? -eq 0 ]; then
        echo "âœ… ì»¨íŠ¸ë¡¤ëŸ¬ Slurm ì„¤ì¹˜ ì™„ë£Œ"
    else
        echo "âŒ ì»¨íŠ¸ë¡¤ëŸ¬ Slurm ì„¤ì¹˜ ì‹¤íŒ¨"
        exit 1
    fi
else
    echo "â­ï¸  ì»¨íŠ¸ë¡¤ëŸ¬ Slurm ì„¤ì¹˜ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 6.1: systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± (Type=notify)
################################################################################

echo "ðŸ“ Step 6.1/13: systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±..."
echo "--------------------------------------------------------------------------------"
echo "Slurm ê³µì‹ ê¶Œìž¥: Type=notify"
echo ""

if [ -f "create_slurm_systemd_services.sh" ]; then
    chmod +x create_slurm_systemd_services.sh
    sudo bash create_slurm_systemd_services.sh
    
    if [ $? -eq 0 ]; then
        echo "âœ… systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
    else
        echo "âš ï¸  systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
    fi
else
    echo "âš ï¸  create_slurm_systemd_services.shë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "ðŸ’¡ ê¸°ë³¸ systemd ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
fi

echo ""

################################################################################
# Step 6.5: Slurm Accounting (slurmdbd) ì„¤ì¹˜
################################################################################

echo "ðŸ—„ï¸  Step 6.5/13: Slurm Accounting (slurmdbd) ì„¤ì¹˜..."
echo "--------------------------------------------------------------------------------"
echo "slurmdbdëŠ” Slurmì˜ Accounting ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤."
echo "QoS (Quality of Service) ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ëŠ” ê²½ìš° í•„ìˆ˜ìž…ë‹ˆë‹¤."
echo ""
echo "ðŸ“Œ QoS ê¸°ëŠ¥:"
echo "  - ê·¸ë£¹ë³„ CPU/ë©”ëª¨ë¦¬ ì œí•œ"
echo "  - ìž‘ì—… ìš°ì„ ìˆœìœ„ ê´€ë¦¬"
echo "  - ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì¶”ì "
echo "  - Dashboard Apply Configuration ê¸°ëŠ¥"
echo ""
echo "âš ï¸  QoSê°€ í•„ìš”ì—†ë‹¤ë©´ ê±´ë„ˆë›¸ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
echo "   (ê¸°ë³¸ Slurm ê¸°ëŠ¥ì€ ì •ìƒ ìž‘ë™í•©ë‹ˆë‹¤)"
echo ""

read -p "slurmdbdë¥¼ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¶Œìž¥: Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    if [ -f "install_slurm_accounting.sh" ]; then
        chmod +x install_slurm_accounting.sh
        sudo bash install_slurm_accounting.sh
        
        if [ $? -eq 0 ]; then
            echo "âœ… slurmdbd ì„¤ì¹˜ ì™„ë£Œ"
            SLURMDBD_INSTALLED=true
        else
            echo "âš ï¸  slurmdbd ì„¤ì¹˜ ì‹¤íŒ¨"
            echo "   QoS ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì§€ë§Œ, ê¸°ë³¸ Slurmì€ ì •ìƒ ìž‘ë™í•©ë‹ˆë‹¤."
            SLURMDBD_INSTALLED=false
        fi
    else
        echo "âš ï¸  install_slurm_accounting.shë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "ðŸ’¡ ìˆ˜ë™ìœ¼ë¡œ slurmdbdë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”."
        SLURMDBD_INSTALLED=false
    fi
else
    echo "â­ï¸  slurmdbd ì„¤ì¹˜ ê±´ë„ˆë›° (QoS ê¸°ëŠ¥ ë¹„í™œì„±í™”)"
    SLURMDBD_INSTALLED=false
fi

echo ""

################################################################################
# Step 7: ê³„ì‚° ë…¸ë“œì— Slurm ì„¤ì¹˜
################################################################################

echo "ðŸ“¦ Step 7/13: ê³„ì‚° ë…¸ë“œì— Slurm 23.11.x ì„¤ì¹˜..."
echo "--------------------------------------------------------------------------------"

COMPUTE_NODES=("192.168.122.90" "192.168.122.103")
SSH_USER="koopark"

read -p "ê³„ì‚° ë…¸ë“œì— Slurmì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    for node in "${COMPUTE_NODES[@]}"; do
        echo ""
        echo "ðŸ“¦ $node: Slurm ì„¤ì¹˜ ì¤‘..."
        
        # ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
        scp install_slurm_cgroup_v2.sh ${SSH_USER}@${node}:/tmp/
        
        # ì›ê²© ì‹¤í–‰
        ssh ${SSH_USER}@${node} "cd /tmp && sudo bash install_slurm_cgroup_v2.sh"
        
        if [ $? -eq 0 ]; then
            echo "âœ… $node: Slurm ì„¤ì¹˜ ì™„ë£Œ"
        else
            echo "âš ï¸  $node: Slurm ì„¤ì¹˜ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        fi
    done
    
    echo ""
    echo "âœ… ëª¨ë“  ê³„ì‚° ë…¸ë“œ Slurm ì„¤ì¹˜ ì™„ë£Œ"
else
    echo "â­ï¸  ê³„ì‚° ë…¸ë“œ Slurm ì„¤ì¹˜ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 8: Slurm ì„¤ì • íŒŒì¼ ìƒì„± (cgroup v2)
################################################################################

echo "ðŸ”§ Step 8/13: Slurm ì„¤ì • íŒŒì¼ ìƒì„± (cgroup v2 ì§€ì›)..."
echo "--------------------------------------------------------------------------------"

read -p "Slurm ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    chmod +x configure_slurm_from_yaml.py
    python3 configure_slurm_from_yaml.py
        echo "  ðŸ’¡ YAML ê¸°ë°˜ ë™ì  ì„¤ì • ìƒì„± ì‚¬ìš©"
    
    if [ $? -eq 0 ]; then
        echo "âœ… Slurm ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ"
    else
        echo "âŒ ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
        exit 1
    fi
else
    echo "â­ï¸  ì„¤ì • íŒŒì¼ ìƒì„± ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 9: ì„¤ì • íŒŒì¼ì„ ê³„ì‚° ë…¸ë“œì— ë°°í¬
################################################################################

echo "ðŸ“¤ Step 9/13: ì„¤ì • íŒŒì¼ì„ ê³„ì‚° ë…¸ë“œì— ë°°í¬..."
echo "--------------------------------------------------------------------------------"

read -p "ì„¤ì • íŒŒì¼ì„ ê³„ì‚° ë…¸ë“œì— ë°°í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    for node in "${COMPUTE_NODES[@]}"; do
        echo ""
        echo "ðŸ“¤ $node: ì„¤ì • íŒŒì¼ ë³µì‚¬ ì¤‘..."
        
        # slurm.conf ë³µì‚¬
        scp /usr/local/slurm/etc/slurm.conf ${SSH_USER}@${node}:/tmp/
        ssh ${SSH_USER}@${node} "sudo mv /tmp/slurm.conf /usr/local/slurm/etc/ && sudo chown slurm:slurm /usr/local/slurm/etc/slurm.conf"
        
        # cgroup.conf ë³µì‚¬
        scp /usr/local/slurm/etc/cgroup.conf ${SSH_USER}@${node}:/tmp/
        ssh ${SSH_USER}@${node} "sudo mv /tmp/cgroup.conf /usr/local/slurm/etc/ && sudo chown slurm:slurm /usr/local/slurm/etc/cgroup.conf"
        
        # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ë³µì‚¬
        scp /etc/systemd/system/slurmd.service ${SSH_USER}@${node}:/tmp/
        ssh ${SSH_USER}@${node} "sudo mv /tmp/slurmd.service /etc/systemd/system/ && sudo systemctl daemon-reload"
        
        echo "âœ… $node: ì„¤ì • íŒŒì¼ ë°°í¬ ì™„ë£Œ"
    done
    
    echo ""
    echo "âœ… ëª¨ë“  ë…¸ë“œì— ì„¤ì • íŒŒì¼ ë°°í¬ ì™„ë£Œ"
else
    echo "â­ï¸  ì„¤ì • íŒŒì¼ ë°°í¬ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 10: Slurm ì„œë¹„ìŠ¤ ì‹œìž‘
################################################################################

echo "â–¶ï¸  Step 10/13: Slurm ì„œë¹„ìŠ¤ ì‹œìž‘..."
echo "--------------------------------------------------------------------------------"

read -p "Slurm ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    # ì»¨íŠ¸ë¡¤ëŸ¬
    echo ""
    echo "ðŸ”§ ì»¨íŠ¸ë¡¤ëŸ¬: slurmctld ì‹œìž‘ ì¤‘..."
    sudo systemctl enable slurmctld
    sudo systemctl restart slurmctld
    
    sleep 3
    
    if sudo systemctl is-active --quiet slurmctld; then
        echo "âœ… slurmctld ì‹œìž‘ ì„±ê³µ"
    else
        echo "âŒ slurmctld ì‹œìž‘ ì‹¤íŒ¨"
        sudo systemctl status slurmctld --no-pager
    fi
    
    # ê³„ì‚° ë…¸ë“œ
    for node in "${COMPUTE_NODES[@]}"; do
        echo ""
        echo "ðŸ”§ $node: slurmd ì‹œìž‘ ì¤‘..."
        
        ssh ${SSH_USER}@${node} "sudo systemctl enable slurmd && sudo systemctl restart slurmd"
        
        sleep 2
        
        if ssh ${SSH_USER}@${node} "sudo systemctl is-active --quiet slurmd"; then
            echo "âœ… $node: slurmd ì‹œìž‘ ì„±ê³µ"
        else
            echo "âš ï¸  $node: slurmd ì‹œìž‘ ì‹¤íŒ¨"
            ssh ${SSH_USER}@${node} "sudo systemctl status slurmd --no-pager"
        fi
    done
    
    echo ""
    echo "âœ… Slurm ì„œë¹„ìŠ¤ ì‹œìž‘ ì™„ë£Œ"
else
    echo "â­ï¸  ì„œë¹„ìŠ¤ ì‹œìž‘ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# Step 11: PATH ì˜êµ¬ ì„¤ì • ë° í™•ì¸
################################################################################

echo "ðŸ›¤ï¸  Step 11/13: PATH ì˜êµ¬ ì„¤ì • ë° í™•ì¸..."
echo "--------------------------------------------------------------------------------"

# /etc/profile.d/slurm.sh í™•ì¸
if [ -f "/etc/profile.d/slurm.sh" ]; then
    echo "âœ… /etc/profile.d/slurm.sh íŒŒì¼ ì¡´ìž¬"
else
    echo "âš ï¸  /etc/profile.d/slurm.sh íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
    sudo tee /etc/profile.d/slurm.sh > /dev/null << 'SLURM_PATH_EOF'
# Slurm Environment
export PATH=/usr/local/slurm/bin:/usr/local/slurm/sbin:$PATH
export LD_LIBRARY_PATH=/usr/local/slurm/lib:$LD_LIBRARY_PATH
export MANPATH=/usr/local/slurm/share/man:$MANPATH
SLURM_PATH_EOF
    sudo chmod 644 /etc/profile.d/slurm.sh
    echo "âœ… /etc/profile.d/slurm.sh íŒŒì¼ ìƒì„± ì™„ë£Œ"
fi

echo ""

# í˜„ìž¬ í„°ë¯¸ë„ì— PATH ì ìš©
echo "âš¡ í˜„ìž¬ í„°ë¯¸ë„ì— PATH ì ìš© ì¤‘..."
source /etc/profile.d/slurm.sh 2>/dev/null || export PATH=/usr/local/slurm/bin:/usr/local/slurm/sbin:$PATH
echo "âœ… PATH ì ìš© ì™„ë£Œ"

echo ""

# ì‚¬ìš©ìžë³„ .bashrc ì—…ë°ì´íŠ¸ (ì„ íƒ)
if ! grep -q "slurm.sh" ~/.bashrc 2>/dev/null && ! grep -q "/usr/local/slurm/bin" ~/.bashrc 2>/dev/null; then
    echo "ðŸ“ ì‚¬ìš©ìž ~/.bashrc ì—…ë°ì´íŠ¸..."
    read -p "~/.bashrcì— Slurm PATHë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¶Œìž¥) (Y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        echo "" >> ~/.bashrc
        echo "# Slurm PATH (added by setup_cluster_full.sh)" >> ~/.bashrc
        echo "source /etc/profile.d/slurm.sh 2>/dev/null || export PATH=/usr/local/slurm/bin:/usr/local/slurm/sbin:\$PATH" >> ~/.bashrc
        echo "âœ… ~/.bashrc ì—…ë°ì´íŠ¸ ì™„ë£Œ"
    else
        echo "â­ï¸  ~/.bashrc ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€"
    fi
else
    echo "âœ… ~/.bashrcì— ì´ë¯¸ Slurm PATHê°€ ì„¤ì •ë˜ì–´ ìžˆìŠµë‹ˆë‹¤"
fi

echo ""

# ëª…ë ¹ì–´ í™•ì¸
echo "ðŸ§ª Slurm ëª…ë ¹ì–´ í™•ì¸..."
COMMANDS_OK=true

for cmd in sinfo squeue sbatch srun scancel; do
    if command -v "$cmd" &> /dev/null; then
        echo "  âœ… $cmd"
    else
        echo "  âŒ $cmd (not found)"
        COMMANDS_OK=false
    fi
done

echo ""

if [ "$COMMANDS_OK" = true ]; then
    echo "âœ… ëª¨ë“  Slurm ëª…ë ¹ì–´ê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
    
    # ë²„ì „ í™•ì¸
    if command -v sinfo &> /dev/null; then
        VERSION=$(sinfo --version 2>/dev/null | head -1)
        if [ -n "$VERSION" ]; then
            echo "ðŸ“Š $VERSION"
        fi
    fi
else
    echo "âš ï¸  ì¼ë¶€ ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "   í˜„ìž¬ í„°ë¯¸ë„ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´: source /etc/profile.d/slurm.sh"
    echo "   ìƒˆ í„°ë¯¸ë„ì„ ì—´ë©´ ìžë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤."
fi

echo ""

################################################################################
# Step 12: MPI ì„¤ì¹˜ (ì„ íƒ)
################################################################################

echo "ðŸ“¦ Step 12/13: MPI ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì„ íƒ)..."
echo "--------------------------------------------------------------------------------"

read -p "MPI ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [ -f "install_mpi.py" ]; then
        python3 install_mpi.py
        if [ $? -eq 0 ]; then
            echo "âœ… MPI ì„¤ì¹˜ ì™„ë£Œ"
        else
            echo "âš ï¸  MPI ì„¤ì¹˜ ì‹¤íŒ¨"
        fi
    else
        echo "âš ï¸  install_mpi.pyê°€ ì—†ìŠµë‹ˆë‹¤."
    fi
else
    echo "â­ï¸  MPI ì„¤ì¹˜ ê±´ë„ˆëœ€"
fi

echo ""

################################################################################
# ì™„ë£Œ ë° ê²€ì¦
################################################################################


echo "================================================================================"
echo "ðŸŽ‰ Slurm 23.11.x + cgroup v2 ì„¤ì¹˜ ì™„ë£Œ!"

echo "================================================================================"
echo ""

sleep 3

# PATH ì„¤ì •
export PATH=/usr/local/slurm/bin:$PATH

echo "ðŸ” í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸..."
echo ""

if command -v sinfo &> /dev/null; then
    echo "ðŸ“Š ë…¸ë“œ ìƒíƒœ:"
    sinfo || true
    echo ""
    
    echo "ðŸ“‹ ë…¸ë“œ ìƒì„¸ ì •ë³´:"
    sinfo -N || true
    echo ""
else
    echo "âš ï¸  sinfo ëª…ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    echo "   PATHë¥¼ ì„¤ì •í•˜ì„¸ìš”: source /etc/profile.d/slurm.sh"
fi

echo ""

echo "================================================================================"
echo "ðŸ“‹ ë‹¤ìŒ ë‹¨ê³„"

echo "================================================================================"
echo ""
echo "ðŸš€ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë¼ë©´:"
echo "   ./start_slurm_cluster.sh"
echo ""
echo "ðŸ›‘ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•˜ë ¤ë©´:"
echo "   ./stop_slurm_cluster.sh"
echo ""
echo "1ï¸âƒ£  Slurm ëª…ë ¹ì–´ ì‚¬ìš© (ì´ë¯¸ ì„¤ì •ë¨):"
echo "   sinfo              # í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸"
echo "   squeue             # ìž‘ì—… í í™•ì¸"
echo "   sbatch test.sh     # ìž‘ì—… ì œì¶œ"
echo ""
echo "   ë§Œì•½ ëª…ë ¹ì–´ê°€ ì•ˆ ë˜ë©´:"
echo "   source /etc/profile.d/slurm.sh"
echo "   ë˜ëŠ” ìƒˆ í„°ë¯¸ë„ì„ ì—¬ì„¸ìš”"
echo ""
echo "2ï¸âƒ£  ë…¸ë“œê°€ DOWN ìƒíƒœë¼ë©´ í™œì„±í™”:"
echo "   scontrol update NodeName=node001 State=RESUME"
echo "   scontrol update NodeName=node002 State=RESUME"
echo ""
echo "3ï¸âƒ£  cgroup v2 ìž‘ë™ í™•ì¸:"
echo "   mount | grep cgroup2"
echo "   /usr/local/slurm/sbin/slurmd -V | grep systemd"
echo ""
echo "4ï¸âƒ£  í…ŒìŠ¤íŠ¸ Job ì œì¶œ:"
echo "   cat > test_job.sh <<'EOF'"
echo "   #!/bin/bash"
echo "   #SBATCH --job-name=cgroup_test"
echo "   #SBATCH --output=test_%j.out"
echo "   #SBATCH --cpus-per-task=2"
echo "   #SBATCH --mem=1G"
echo "   echo 'Testing cgroup v2...'"
echo "   echo 'CPUs: '\$SLURM_CPUS_PER_TASK"
echo "   echo 'Memory: '\$SLURM_MEM_PER_NODE' MB'"
echo "   cat /proc/self/cgroup"
echo "   EOF"
echo ""
echo "   sbatch test_job.sh"
echo "   squeue"
echo ""
echo "5ï¸âƒ£  ë¦¬ì†ŒìŠ¤ ì œí•œ í…ŒìŠ¤íŠ¸ (ë©”ëª¨ë¦¬):"
echo "   cat > mem_test.sh <<'EOF'"
echo "   #!/bin/bash"
echo "   #SBATCH --mem=512M"
echo "   # 1GB í• ë‹¹ ì‹œë„ (512MB ì œí•œì— ê±¸ë ¤ ì¢…ë£Œë¨)"
echo "   python3 -c 'x=[0]*(1024**3//8); import time; time.sleep(5)'"
echo "   EOF"
echo ""
echo "   sbatch mem_test.sh  # cgroupì´ ì •ìƒì´ë©´ ë©”ëª¨ë¦¬ ì´ˆê³¼ë¡œ ì¢…ë£Œ"
echo ""
echo "6ï¸âƒ£  Dashboard ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§:"
echo "   cd dashboard/backend"
echo "   export MOCK_MODE=false"
echo "   python app.py"
echo ""
echo "   # ë¸Œë¼ìš°ì €: http://localhost:3000"
echo "   # Save/Load â†’ Sync Nodes from Slurm"
echo ""

echo "================================================================================"
echo ""
echo "âœ¨ cgroup v2 ì£¼ìš” ê¸°ëŠ¥:"
echo "  âœ… CPU ì½”ì–´ ì œí•œ - í• ë‹¹ëœ CPUë§Œ ì‚¬ìš©"
echo "  âœ… ë©”ëª¨ë¦¬ ì œí•œ - ì´ˆê³¼ ì‹œ ìžë™ ì¢…ë£Œ"
echo "  âœ… CPU ì¹œí™”ì„± - íŠ¹ì • ì½”ì–´ì— ê³ ì •"
echo "  âœ… ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ - Dashboard ì—°ë™"
echo ""
echo "ðŸ“š ìƒì„¸ ê°€ì´ë“œ:"
echo "  cat CGROUP_V2_INSTALLATION_GUIDE.md"
echo ""
echo "ðŸ”— ë¬¸ì„œ:"
echo "  - Slurm cgroup: https://slurm.schedmd.com/cgroup.html"
echo "  - Dashboard: cat dashboard/SLURM_INTEGRATION_GUIDE.md"
echo ""

echo "================================================================================"
echo ""
echo "ðŸŽŠ ì™„ë£Œ! Happy Computing with cgroup v2! ðŸš€"
echo ""
