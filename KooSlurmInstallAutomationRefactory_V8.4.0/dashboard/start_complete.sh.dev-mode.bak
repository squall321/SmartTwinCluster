#!/bin/bash
# ì „ì²´ ì‹œìŠ¤í…œ í†µí•© ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ (Phase 1-5)
# Phase 1: Auth Portal (4430, 4431)
# Phase 2-4: Dashboard + Monitoring (3010, 5010, 5011, 9090, 9100)
# Phase 5: VNC Service (8002)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "=========================================="
echo "ğŸš€ HPC Cluster ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘"
echo "=========================================="
echo ""

# ==================== 1. ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¢…ë£Œ ====================
echo -e "${BLUE}[1/4] ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘...${NC}"

# Phase 1 ì¢…ë£Œ
if [ -f "./stop_phase1.sh" ]; then
    ./stop_phase1.sh > /dev/null 2>&1
fi

# Phase 2-4 ì¢…ë£Œ
if [ -f "./stop_all.sh" ]; then
    ./stop_all.sh > /dev/null 2>&1
fi

# VNC Service ì¢…ë£Œ
if [ -f "vnc_service_8002/.vnc_service.pid" ]; then
    kill $(cat vnc_service_8002/.vnc_service.pid) 2>/dev/null
    rm -f vnc_service_8002/.vnc_service.pid
fi

# ì¶”ê°€ ì •ë¦¬: ëª¨ë“  ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
pkill -f "auth_portal_4430.*app.py" 2>/dev/null
pkill -f "auth_portal_4431.*vite" 2>/dev/null
pkill -f "backend_5010.*app.py" 2>/dev/null
pkill -f "websocket_5011.*python" 2>/dev/null
pkill -f "frontend_3010.*vite" 2>/dev/null
pkill -f "vnc_service_8002.*vite" 2>/dev/null
pkill -f "prometheus.*9090" 2>/dev/null
pkill -f "node_exporter.*9100" 2>/dev/null

sleep 3
echo -e "${GREEN}âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¢…ë£Œ ì™„ë£Œ${NC}"
echo ""

# ==================== 2. Phase 1 ì‹œì‘ (Auth Portal) ====================
echo -e "${BLUE}[2/4] Phase 1: Auth Portal ì‹œì‘ ì¤‘...${NC}"

if [ -f "./start_phase1.sh" ]; then
    ./start_phase1.sh
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Phase 1 ì‹œì‘ ì™„ë£Œ${NC}"
    else
        echo -e "${RED}âŒ Phase 1 ì‹œì‘ ì‹¤íŒ¨${NC}"
    fi
else
    echo -e "${RED}âŒ start_phase1.sh ì—†ìŒ${NC}"
fi
echo ""

# ==================== 3. Phase 2-4 ì‹œì‘ (Dashboard) ====================
echo -e "${BLUE}[3/4] Phase 2-4: Dashboard + Monitoring ì‹œì‘ ì¤‘...${NC}"

if [ -f "./start_all.sh" ]; then
    ./start_all.sh
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Phase 2-4 ì‹œì‘ ì™„ë£Œ${NC}"
    else
        echo -e "${RED}âŒ Phase 2-4 ì‹œì‘ ì‹¤íŒ¨${NC}"
    fi
else
    echo -e "${RED}âŒ start_all.sh ì—†ìŒ${NC}"
fi
echo ""

# ==================== 4. Phase 5 ì‹œì‘ (VNC Service) ====================
echo -e "${BLUE}[4/7] Phase 5: VNC Service ì‹œì‘ ì¤‘...${NC}"

if [ -f "vnc_service_8002/start.sh" ]; then
    cd vnc_service_8002
    ./start.sh
    cd "$SCRIPT_DIR"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Phase 5 ì‹œì‘ ì™„ë£Œ${NC}"
    else
        echo -e "${RED}âŒ Phase 5 ì‹œì‘ ì‹¤íŒ¨${NC}"
    fi
else
    echo -e "${RED}âŒ vnc_service_8002/start.sh ì—†ìŒ${NC}"
fi
echo ""

# ==================== 5. CAE Backend 5000 ì‹œì‘ ====================
echo -e "${BLUE}[5/7] CAE Backend (5000) ì‹œì‘ ì¤‘...${NC}"

if [ -d "kooCAEWebServer_5000" ]; then
    cd kooCAEWebServer_5000

    # venv í™œì„±í™” ë° ì•± ì‹œì‘
    if [ -d "venv" ]; then
        nohup venv/bin/python app.py > /tmp/cae_backend_5000.log 2>&1 &
        CAE_BACKEND_PID=$!
        echo $CAE_BACKEND_PID > .cae_backend.pid
        echo -e "${GREEN}âœ… CAE Backend ì‹œì‘ (PID: $CAE_BACKEND_PID)${NC}"
    else
        echo -e "${YELLOW}âš ï¸  venv ì—†ìŒ, python3 ì§ì ‘ ì‹¤í–‰${NC}"
        nohup python3 app.py > /tmp/cae_backend_5000.log 2>&1 &
        CAE_BACKEND_PID=$!
        echo $CAE_BACKEND_PID > .cae_backend.pid
        echo -e "${GREEN}âœ… CAE Backend ì‹œì‘ (PID: $CAE_BACKEND_PID)${NC}"
    fi

    cd "$SCRIPT_DIR"
else
    echo -e "${RED}âŒ kooCAEWebServer_5000 ë””ë ‰í† ë¦¬ ì—†ìŒ${NC}"
fi
echo ""

# ==================== 6. CAE Automation 5001 ì‹œì‘ ====================
echo -e "${BLUE}[6/7] CAE Automation Server (5001) ì‹œì‘ ì¤‘...${NC}"

if [ -d "kooCAEWebAutomationServer_5001" ]; then
    cd kooCAEWebAutomationServer_5001

    # venv í™œì„±í™” ë° ì•± ì‹œì‘
    if [ -d "venv" ]; then
        nohup venv/bin/python app.py > /tmp/cae_automation_5001.log 2>&1 &
        CAE_AUTO_PID=$!
        echo $CAE_AUTO_PID > .cae_automation.pid
        echo -e "${GREEN}âœ… CAE Automation ì‹œì‘ (PID: $CAE_AUTO_PID)${NC}"
    else
        echo -e "${YELLOW}âš ï¸  venv ì—†ìŒ, python3 ì§ì ‘ ì‹¤í–‰${NC}"
        nohup python3 app.py > /tmp/cae_automation_5001.log 2>&1 &
        CAE_AUTO_PID=$!
        echo $CAE_AUTO_PID > .cae_automation.pid
        echo -e "${GREEN}âœ… CAE Automation ì‹œì‘ (PID: $CAE_AUTO_PID)${NC}"
    fi

    cd "$SCRIPT_DIR"
else
    echo -e "${RED}âŒ kooCAEWebAutomationServer_5001 ë””ë ‰í† ë¦¬ ì—†ìŒ${NC}"
fi
echo ""

# ==================== 7. CAE Frontend 5173 ì‹œì‘ ====================
echo -e "${BLUE}[7/7] CAE Frontend (5173) ì‹œì‘ ì¤‘...${NC}"

if [ -d "kooCAEWeb_5173" ]; then
    cd kooCAEWeb_5173

    # npm dev ì„œë²„ ì‹œì‘
    if [ -f "package.json" ]; then
        nohup npm run dev > /tmp/cae_frontend_5173.log 2>&1 &
        CAE_FRONTEND_PID=$!
        echo $CAE_FRONTEND_PID > .cae_frontend.pid
        echo -e "${GREEN}âœ… CAE Frontend ì‹œì‘ (PID: $CAE_FRONTEND_PID)${NC}"
    else
        echo -e "${RED}âŒ package.json ì—†ìŒ${NC}"
    fi

    cd "$SCRIPT_DIR"
else
    echo -e "${RED}âŒ kooCAEWeb_5173 ë””ë ‰í† ë¦¬ ì—†ìŒ${NC}"
fi
echo ""

# ==================== ìµœì¢… ìƒíƒœ í™•ì¸ ====================
echo "=========================================="
echo -e "${GREEN}âœ… ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘ ì™„ë£Œ!${NC}"
echo "=========================================="
echo ""
echo "ğŸ”— ì ‘ì† ì •ë³´:"
echo ""
echo "  ğŸ“± Phase 1: Auth Portal"
echo "     Auth Frontend:  http://localhost:4431"
echo "     Auth Backend:   http://localhost:4430"
echo ""
echo "  ğŸ“Š Phase 2-4: Dashboard"
echo "     Dashboard:      http://localhost:3010"
echo "     Backend API:    http://localhost:5010"
echo "     WebSocket:      ws://localhost:5011/ws"
echo ""
echo "  ğŸ“ˆ Monitoring"
echo "     Prometheus:     http://localhost:9090"
echo "     Node Exporter:  http://localhost:9100/metrics"
echo ""
echo "  ğŸ–¥ï¸  Phase 5: VNC Service"
echo "     VNC Service:    http://localhost:8002"
echo ""
echo "  ğŸ”§ CAE Services (Computer-Aided Engineering)"
echo "     CAE Backend:    http://localhost:5000"
echo "     CAE Automation: http://localhost:5001"
echo "     CAE Frontend:   http://localhost:5173"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ ì‚¬ìš© ë°©ë²•:"
echo "   1. http://localhost:4431 ì—ì„œ ë¡œê·¸ì¸"
echo "   2. ì„œë¹„ìŠ¤ ì¹´ë“œì—ì„œ ì›í•˜ëŠ” ì„œë¹„ìŠ¤ ì„ íƒ"
echo "   3. VNC ServiceëŠ” í† í°ê³¼ í•¨ê»˜ ìë™ ì—°ê²°"
echo "   4. CAE ì‹œë®¬ë ˆì´ì…˜: http://localhost:5173"
echo ""
echo "ğŸ”´ ì „ì²´ ì¢…ë£Œ: ./stop_complete.sh"
echo ""
