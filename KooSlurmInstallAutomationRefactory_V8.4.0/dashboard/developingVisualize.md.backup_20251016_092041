# GPU ì›ê²© ë°ìŠ¤í¬í†± ì‹œê°í™” ì„œë²„ ê°œë°œ ê³„íš (Apptainer ìƒŒë“œë°•ìŠ¤ ê¸°ë°˜)

**ì‘ì„±ì¼**: 2025-10-16  
**í”„ë¡œì íŠ¸**: Slurm Cluster Dashboard - Remote Desktop Visualization with Apptainer  
**ëª©ì **: Slurm + Apptainer ìƒŒë“œë°•ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ GPU ì„œë²„ì— ì›¹ìœ¼ë¡œ ì ‘ì†í•˜ì—¬ Ubuntu ë°ìŠ¤í¬í†±ì„ ë„ìš°ëŠ” ê¸°ëŠ¥ êµ¬í˜„

---

## ğŸ“‹ ëª©ì°¨

1. [í˜„í™© ë¶„ì„](#1-í˜„í™©-ë¶„ì„)
2. [ê¸°ìˆ  ìŠ¤íƒ ì„ íƒ](#2-ê¸°ìˆ -ìŠ¤íƒ-ì„ íƒ)
3. [Apptainer ìƒŒë“œë°•ìŠ¤ ì•„í‚¤í…ì²˜](#3-apptainer-ìƒŒë“œë°•ìŠ¤-ì•„í‚¤í…ì²˜)
4. [ì‹œìŠ¤í…œ ì„¤ê³„](#4-ì‹œìŠ¤í…œ-ì„¤ê³„)
5. [ê°œë°œ ê³„íš](#5-ê°œë°œ-ê³„íš)
6. [Apptainer ì´ë¯¸ì§€ êµ¬ì„±](#6-apptainer-ì´ë¯¸ì§€-êµ¬ì„±)
7. [Slurm í†µí•©](#7-slurm-í†µí•©)
8. [API ì„¤ê³„](#8-api-ì„¤ê³„)
9. [í”„ë¡ íŠ¸ì—”ë“œ í†µí•©](#9-í”„ë¡ íŠ¸ì—”ë“œ-í†µí•©)
10. [ë³´ì•ˆ ë° ì„±ëŠ¥](#10-ë³´ì•ˆ-ë°-ì„±ëŠ¥)
11. [í…ŒìŠ¤íŠ¸ ê³„íš](#11-í…ŒìŠ¤íŠ¸-ê³„íš)
12. [êµ¬í˜„ ë¡œë“œë§µ](#12-êµ¬í˜„-ë¡œë“œë§µ)

---

## 0. í†µí•© ì•„í‚¤í…ì²˜ ë° ADFS SSO ì¸ì¦ ì‹œìŠ¤í…œ (ìµœìš°ì„  êµ¬í˜„) â­â­â­

### 0.0 ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

#### ìƒˆë¡œìš´ ì„œë²„ êµ¬ì¡° ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   User Browser   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ HTTPS
                                   â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Main Auth Portal (443)  â”‚ â† ğŸ”¥ ìƒˆ í”„ë¡œì íŠ¸
                    â”‚  auth_portal_443/        â”‚
                    â”‚  - SSO ë¡œê·¸ì¸            â”‚
                    â”‚  - ì„œë¹„ìŠ¤ ì„ íƒ ë©”ë‰´       â”‚
                    â”‚  - í† í° ë°œê¸‰             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                             â”‚
                â†“                             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ (3010)   â”‚    â”‚ ìë™í™” ì‹œìŠ¤í…œ (5173)   â”‚
    â”‚ frontend_3010/        â”‚    â”‚ frontend_5173/        â”‚
    â”‚ - í´ëŸ¬ìŠ¤í„° ê´€ë¦¬        â”‚    â”‚ - ìë™í™”ëœ Job Submit â”‚
    â”‚ - ìˆ˜ë™ Job Submit     â”‚    â”‚ - Workflow ê´€ë¦¬       â”‚
    â”‚ - VNC Visualization   â”‚    â”‚ - Batch Processing    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                            â”‚
                â†“                            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Backend API (5010)    â”‚    â”‚ Backend API (5000)    â”‚
    â”‚ - Slurm ëª…ë ¹          â”‚    â”‚ - ìë™í™” ì›Œí¬í”Œë¡œìš°     â”‚
    â”‚ - VNC ì„¸ì…˜ ê´€ë¦¬        â”‚    â”‚ - 5010 í”„ë¡ì‹œ         â”‚
    â”‚ - ëª¨ë‹ˆí„°ë§            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                â”‚                            â†“
                â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                â”‚ Backend Proxy (5001)  â”‚
                â”‚                â”‚ - 5000 í”„ë¡ì‹œ         â”‚
                â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WebSocket (5011)      â”‚
    â”‚ - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§      â”‚
    â”‚ - VNC í”„ë¡ì‹œ          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Slurm Cluster       â”‚
    â”‚   + Apptainer         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ì„œë²„ êµ¬ì„± ìƒì„¸

| í¬íŠ¸ | ì„œë¹„ìŠ¤ëª… | ì—­í•  | í”„ë¡œì íŠ¸ ê²½ë¡œ | ë¹„ê³  |
|------|---------|------|--------------|------|
| **443** | **ë©”ì¸ ì¸ì¦ í¬í„¸** | SSO ë¡œê·¸ì¸, ì„œë¹„ìŠ¤ ì„ íƒ ë©”ë‰´ | `auth_portal_443/` | **ğŸ”¥ ì‹ ê·œ í”„ë¡œì íŠ¸** |
| **3010** | ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ (Frontend) | í´ëŸ¬ìŠ¤í„° ê´€ë¦¬, ìˆ˜ë™ Job, VNC | `frontend_3010/` | ê¸°ì¡´ |
| **5010** | ê´€ë¦¬ Backend | Slurm API, VNC ì„¸ì…˜, ëª¨ë‹ˆí„°ë§ | `backend_5010/` | ê¸°ì¡´ |
| **5011** | WebSocket | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§, VNC í”„ë¡ì‹œ | `websocket_5011/` | ê¸°ì¡´ |
| **5173** | ìë™í™” Frontend | ìë™í™” ì›Œí¬í”Œë¡œìš°, Batch Job | `frontend_5173/` | **ğŸ”¥ ì‹ ê·œ** |
| **5000** | ìë™í™” Backend | ì›Œí¬í”Œë¡œìš° ì—”ì§„, 5010 í”„ë¡ì‹œ | `backend_5000/` | **ğŸ”¥ ì‹ ê·œ** |
| **5001** | ìë™í™” Proxy | 5000 í”„ë¡ì‹œ | `backend_5001/` | **ğŸ”¥ ì‹ ê·œ** |

---

### 0.1 ì¸ì¦ ìš”êµ¬ì‚¬í•­ (ì—…ë°ì´íŠ¸)

#### í•µì‹¬ ìš”êµ¬ì‚¬í•­
1. **ì¤‘ì•™ ì¸ì¦ í¬í„¸ (443)**: ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ì§„ì…ì 
2. **ADFS SSO ì—°ë™**: Active Directory Federation Servicesë¥¼ í†µí•œ Single Sign-On
3. **ê°œë°œ í™˜ê²½**: saml-idpë¥¼ ì´ìš©í•œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•
4. **í”„ë¡œë•ì…˜ í™˜ê²½**: ì‹¤ì œ ADFS ì„œë²„ì™€ ì—°ë™
5. **JWT í† í° ê¸°ë°˜ ì¸ì¦**: ì¤‘ì•™ì—ì„œ ë°œê¸‰, ê° ì„œë¹„ìŠ¤ì—ì„œ ê²€ì¦
6. **ê¶Œí•œ ê´€ë¦¬**: ADFS ê·¸ë£¹ ê¸°ë°˜ ì„œë¹„ìŠ¤ë³„ ì ‘ê·¼ ì œì–´
   - `HPC-Admins`: ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼
   - `HPC-Users`: ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ (3010) ì ‘ê·¼
   - `Automation-Users`: ìë™í™” ì‹œìŠ¤í…œ (5173) ì ‘ê·¼
   - `GPU-Users`: VNC Visualization ì ‘ê·¼

#### ê¸°ìˆ  ìŠ¤íƒ
- **ë©”ì¸ í¬í„¸**: React (Vite) + Flask (Auth ì„œë²„)
- **ì¸ì¦**: SAML 2.0 (python3-saml) + JWT (PyJWT)
- **ê°œë°œìš© IdP**: saml-idp (Node.js)
- **í”„ë¡œë•ì…˜ IdP**: ADFS (Active Directory Federation Services)
- **ì„¸ì…˜ ì €ì¥ì†Œ**: Redis (SSO ì„¸ì…˜ + JWT í† í°)
- **API Gateway**: Nginx (ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)

### 0.2 í†µí•© ì¸ì¦ í”Œë¡œìš° (ì—…ë°ì´íŠ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ì¤‘ì•™ ì¸ì¦ í¬í„¸ ê¸°ë°˜ SSO ì¸ì¦ í”Œë¡œìš°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User (Browser)
   â†“ [HTTPS] https://your-domain.com (í¬íŠ¸ 443)

2. Main Auth Portal (443)
   â†“ ì„¸ì…˜ í™•ì¸ â†’ ì—†ìŒ
   â†“ [Redirect] /sso/login (SAML AuthnRequest ìƒì„±)

3. ADFS / saml-idp
   â†“ ì‚¬ìš©ì ì¸ì¦ (AD ê³„ì • ë˜ëŠ” í…ŒìŠ¤íŠ¸ ê³„ì •)
   â†“ [POST] /sso/acs (SAML Response + Assertion)

4. Auth Portal Backend (í¬íŠ¸ 4430, Flask)
   â†“ SAML Response ê²€ì¦
   â†“ Assertionì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
   â”‚   - nameID: ì‚¬ìš©ì ID (ì˜ˆ: user01)
   â”‚   - email: user01@hpc.local
   â”‚   - displayName: Test User 1
   â”‚   - groups: ['HPC-Users', 'GPU-Users', 'Automation-Users']
   â†“ Redisì— SSO ì„¸ì…˜ ìƒì„± (TTL: 8ì‹œê°„)
   â†“ JWT í† í° ë°œê¸‰ (HS256)
   â”‚   {
   â”‚     "user_id": "user01",
   â”‚     "email": "user01@hpc.local",
   â”‚     "groups": ["HPC-Users", "GPU-Users"],
   â”‚     "exp": <8ì‹œê°„ í›„>,
   â”‚     "iat": <í˜„ì¬ ì‹œê°>
   â”‚   }
   â†“ [Redirect] / (ì„œë¹„ìŠ¤ ì„ íƒ ë©”ë‰´)

5. Main Portal (443) - ì„œë¹„ìŠ¤ ì„ íƒ í™”ë©´
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Welcome, Test User 1!             â”‚
   â”‚                                    â”‚
   â”‚  ì‚¬ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤:                â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚  â”‚ ğŸ–¥ï¸  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ             â”‚ â”‚ â† HPC-Users ê·¸ë£¹ í•„ìš”
   â”‚  â”‚     í´ëŸ¬ìŠ¤í„° ê´€ë¦¬, Job ì œì¶œ    â”‚ â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚  â”‚ ğŸ¤–  ìë™í™” ì‹œìŠ¤í…œ             â”‚ â”‚ â† Automation-Users ê·¸ë£¹ í•„ìš”
   â”‚  â”‚     ì›Œí¬í”Œë¡œìš°, Batch Job     â”‚ â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6-A. ì‚¬ìš©ìê°€ "ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ" ì„ íƒ
   â†“ JWT í† í°ê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸
   â†“ http://localhost:3010?token=<JWT>
   â†“ frontend_3010ì´ í† í° ê²€ì¦ (Auth Portal 4430ì˜ /verify ì—”ë“œí¬ì¸íŠ¸)
   â†“ localStorageì— í† í° ì €ì¥
   â†“ ì´í›„ ëª¨ë“  API ìš”ì²­ì— Authorization: Bearer <JWT> í—¤ë” í¬í•¨
   â†“ backend_5010ì´ í† í° ê²€ì¦ (ê³µìœ  ë¹„ë°€í‚¤ ë˜ëŠ” ê³µê°œí‚¤)
   âœ“ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ ì„±ê³µ

6-B. ì‚¬ìš©ìê°€ "ìë™í™” ì‹œìŠ¤í…œ" ì„ íƒ
   â†“ JWT í† í°ê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸
   â†“ http://localhost:5173?token=<JWT>
   â†“ frontend_5173ì´ í† í° ê²€ì¦
   â†“ localStorageì— í† í° ì €ì¥
   â†“ ì´í›„ ëª¨ë“  API ìš”ì²­ì— Authorization: Bearer <JWT> í—¤ë” í¬í•¨
   â†“ backend_5000ì´ í† í° ê²€ì¦
   âœ“ ìë™í™” ì‹œìŠ¤í…œ ì ‘ê·¼ ì„±ê³µ

7. í† í° ê°±ì‹ 
   â†“ JWT ë§Œë£Œ 1ì‹œê°„ ì „ ìë™ ê°±ì‹  ìš”ì²­
   â†“ Auth Portal /refresh ì—”ë“œí¬ì¸íŠ¸
   â†“ ìƒˆ JWT ë°œê¸‰ (ê¸°ì¡´ ì„¸ì…˜ ìœ íš¨í•œ ê²½ìš°)
   âœ“ 8ì‹œê°„ ë™ì•ˆ seamless ì‚¬ìš© ê°€ëŠ¥
```

---

### 0.3 Auth Portal í”„ë¡œì íŠ¸ êµ¬ì¡° (ğŸ”¥ ì‹ ê·œ)

```
dashboard/
â”œâ”€â”€ auth_portal_443/                    # ì¤‘ì•™ ì¸ì¦ í¬í„¸ (ì‹ ê·œ í”„ë¡œì íŠ¸)
â”‚   â”œâ”€â”€ frontend/                       # React + Vite
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx                 # ë©”ì¸ ì•±
â”‚   â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Login.tsx           # SSO ë¡œê·¸ì¸ í˜ì´ì§€
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ServiceMenu.tsx     # ì„œë¹„ìŠ¤ ì„ íƒ ë©”ë‰´
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Callback.tsx        # SAML ACS ì½œë°±
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ServiceCard.tsx     # ì„œë¹„ìŠ¤ ì¹´ë“œ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserProfile.tsx     # ì‚¬ìš©ì ì •ë³´
â”‚   â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â”‚       â””â”€â”€ api.ts              # Auth API í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”‚   â””â”€â”€ nginx.conf                  # Nginx ì„¤ì • (443 â†’ í”„ë¡ì‹œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ backend/                        # Flask Auth ì„œë²„ (í¬íŠ¸ 4430)
â”‚   â”‚   â”œâ”€â”€ app.py                      # ë©”ì¸ Flask ì•±
â”‚   â”‚   â”œâ”€â”€ sso/                        # SAML SSO ëª¨ë“ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ saml_config.py          # SAML ì„¤ì • (dev/prod)
â”‚   â”‚   â”‚   â”œâ”€â”€ saml_auth.py            # SAMLAuthManager
â”‚   â”‚   â”‚   â””â”€â”€ routes.py               # /sso/* ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ jwt_manager/                # JWT í† í° ê´€ë¦¬
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ token_issuer.py         # í† í° ë°œê¸‰
â”‚   â”‚   â”‚   â””â”€â”€ token_validator.py      # í† í° ê²€ì¦
â”‚   â”‚   â”œâ”€â”€ api/                        # REST API
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py                 # ì¸ì¦ API
â”‚   â”‚   â”‚   â””â”€â”€ services.py             # ì„œë¹„ìŠ¤ ëª©ë¡ API
â”‚   â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”‚   â””â”€â”€ sessions.db             # Redis + SQLite (ë°±ì—…)
â”‚   â”‚   â”œâ”€â”€ saml_certs/                 # SAML ì¸ì¦ì„œ
â”‚   â”‚   â”‚   â”œâ”€â”€ sp-cert.pem
â”‚   â”‚   â”‚   â”œâ”€â”€ sp-key.pem
â”‚   â”‚   â”‚   â””â”€â”€ idp-cert.pem
â”‚   â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚   â”œâ”€â”€ .env.development
â”‚   â”‚   â”œâ”€â”€ .env.production
â”‚   â”‚   â”œâ”€â”€ start.sh
â”‚   â”‚   â””â”€â”€ stop.sh
â”‚   â”‚
â”‚   â””â”€â”€ docker-compose.yml              # Redis + Auth Backend

â”œâ”€â”€ frontend_3010/                      # ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ (ê¸°ì¡´)
â”‚   â””â”€â”€ (JWT í† í° ê²€ì¦ ë¡œì§ ì¶”ê°€)

â”œâ”€â”€ backend_5010/                       # ê´€ë¦¬ Backend (ê¸°ì¡´)
â”‚   â””â”€â”€ (JWT í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€)

â”œâ”€â”€ frontend_5173/                      # ìë™í™” Frontend (ì‹ ê·œ)
â”‚   â””â”€â”€ (JWT í† í° ê²€ì¦ ë¡œì§ ì¶”ê°€)

â”œâ”€â”€ backend_5000/                       # ìë™í™” Backend (ì‹ ê·œ)
â”‚   â”œâ”€â”€ (JWT í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´)
â”‚   â””â”€â”€ (5010 í”„ë¡ì‹œ ì„¤ì •)

â””â”€â”€ backend_5001/                       # ìë™í™” Proxy (ì‹ ê·œ)
    â””â”€â”€ (5000 í”„ë¡ì‹œ)
```

### 0.4 ê°œë°œ í™˜ê²½ êµ¬ì¶• (saml-idp) - ì—…ë°ì´íŠ¸

#### Step 1: saml-idp ì„¤ì¹˜ ë° ì„¤ì •

```bash
# dashboard/saml_idp/ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp

# saml-idp ì„¤ì¹˜ (Node.js í•„ìš”)
npm install -g saml-idp

# ì„¤ì • íŒŒì¼ ìƒì„± (ì—…ë°ì´íŠ¸: Auth Portal 4430ìœ¼ë¡œ ë³€ê²½)
cat > config.js << 'EOF'
module.exports = {
  // Service Provider (Auth Portal)
  sp: {
    entityId: 'http://localhost:4430/sso/metadata',
    assertionConsumerService: 'http://localhost:4430/sso/acs'
  },

  // Identity Provider (saml-idp)
  idp: {
    entityId: 'http://localhost:7000/metadata',
    ssoUrl: 'http://localhost:7000/saml/sso',
    sloUrl: 'http://localhost:7000/saml/slo',
    cert: './idp-cert.pem',
    key: './idp-key.pem'
  },

  // í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì (ê·¸ë£¹ ì—…ë°ì´íŠ¸)
  users: [
    {
      nameID: 'user01',
      email: 'user01@hpc.local',
      displayName: 'Test User 1',
      groups: ['HPC-Users', 'GPU-Users', 'Automation-Users']  // ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼
    },
    {
      nameID: 'user02',
      email: 'user02@hpc.local',
      displayName: 'Test User 2',
      groups: ['HPC-Users']  // ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë§Œ ì ‘ê·¼
    },
    {
      nameID: 'automation_user',
      email: 'automation@hpc.local',
      displayName: 'Automation User',
      groups: ['Automation-Users']  // ìë™í™” ì‹œìŠ¤í…œë§Œ ì ‘ê·¼
    },
    {
      nameID: 'admin',
      email: 'admin@hpc.local',
      displayName: 'Administrator',
      groups: ['HPC-Admins', 'HPC-Users', 'GPU-Users', 'Automation-Users']  // ëª¨ë“  ê¶Œí•œ
    }
  ]
};
EOF

# ì¸ì¦ì„œ ìƒì„± (ìì²´ ì„œëª…)
openssl req -x509 -newkey rsa:2048 -keyout idp-key.pem -out idp-cert.pem -days 365 -nodes \
  -subj "/C=KR/ST=Seoul/L=Seoul/O=HPC Lab/CN=localhost"

# saml-idp ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
cat > start.sh << 'EOF'
#!/bin/bash
saml-idp \
  --port 7000 \
  --config config.js \
  --cert idp-cert.pem \
  --key idp-key.pem \
  --issuer "http://localhost:7000" \
  --acsUrl "http://localhost:4430/sso/acs" \
  --audience "hpc-auth-portal"
EOF

chmod +x start.sh

# saml-idp ì‹¤í–‰
./start.sh
```

#### Step 2: Backend SAML í†µí•©

```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010
source venv/bin/activate

# SAML ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
pip install python3-saml redis flask-session

# Redis ì„¤ì¹˜ (ì„¸ì…˜ ì €ì¥ìš©)
# Ubuntu/Debian
sudo apt install redis-server -y
# CentOS/RHEL
sudo yum install redis -y

sudo systemctl start redis
sudo systemctl enable redis
```

### 0.5 Auth Portal Backend êµ¬í˜„ (ğŸ”¥ ì‹ ê·œ)

#### JWT í† í° ê´€ë¦¬ì

```python
# auth_portal_443/backend/jwt_manager/token_issuer.py
import jwt
import time
import os
from datetime import datetime, timedelta

class JWTTokenIssuer:
    """JWT í† í° ë°œê¸‰"""

    def __init__(self):
        # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¹„ë°€í‚¤ ë¡œë“œ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ ë³€ê²½!)
        self.secret_key = os.getenv('JWT_SECRET_KEY', 'change-this-secret-key-in-production')
        self.algorithm = 'HS256'
        self.token_ttl = 28800  # 8ì‹œê°„ (ì´ˆ)

    def issue_token(self, user_data):
        """ì‚¬ìš©ì ì •ë³´ë¡œë¶€í„° JWT í† í° ë°œê¸‰"""
        now = datetime.utcnow()
        payload = {
            'user_id': user_data['nameID'],
            'email': user_data.get('email', ''),
            'display_name': user_data.get('displayName', ''),
            'groups': user_data.get('groups', []),
            'iat': now,  # Issued At
            'exp': now + timedelta(seconds=self.token_ttl),  # Expiration
            'iss': 'hpc-auth-portal',  # Issuer
        }

        token = jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
        return token

    def refresh_token(self, old_token):
        """ê¸°ì¡´ í† í° ê°±ì‹  (ë§Œë£Œ 1ì‹œê°„ ì „ë¶€í„° ê°€ëŠ¥)"""
        try:
            # í† í° ê²€ì¦ (ë§Œë£Œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
            payload = jwt.decode(old_token, self.secret_key, algorithms=[self.algorithm])

            # ë§Œë£Œ ì‹œê°„ í™•ì¸
            exp = datetime.fromtimestamp(payload['exp'])
            now = datetime.utcnow()

            # ë§Œë£Œ 1ì‹œê°„ ì „ë¶€í„° ê°±ì‹  ê°€ëŠ¥
            if (exp - now).total_seconds() > 3600:
                return {'error': 'Token is still valid, no refresh needed'}, None

            # ìƒˆ í† í° ë°œê¸‰
            user_data = {
                'nameID': payload['user_id'],
                'email': payload['email'],
                'displayName': payload['display_name'],
                'groups': payload['groups']
            }

            new_token = self.issue_token(user_data)
            return None, new_token

        except jwt.ExpiredSignatureError:
            return {'error': 'Token has expired'}, None
        except jwt.InvalidTokenError as e:
            return {'error': f'Invalid token: {str(e)}'}, None
```

```python
# auth_portal_443/backend/jwt_manager/token_validator.py
import jwt
import os

class JWTTokenValidator:
    """JWT í† í° ê²€ì¦ (ëª¨ë“  ì„œë¹„ìŠ¤ì—ì„œ ê³µìœ )"""

    def __init__(self):
        self.secret_key = os.getenv('JWT_SECRET_KEY', 'change-this-secret-key-in-production')
        self.algorithm = 'HS256'

    def validate_token(self, token):
        """í† í° ê²€ì¦"""
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=[self.algorithm])
            return payload, None
        except jwt.ExpiredSignatureError:
            return None, {'error': 'Token has expired', 'code': 'TOKEN_EXPIRED'}
        except jwt.InvalidTokenError as e:
            return None, {'error': f'Invalid token: {str(e)}', 'code': 'INVALID_TOKEN'}

    def check_permission(self, token, required_groups):
        """ê¶Œí•œ í™•ì¸"""
        payload, error = self.validate_token(token)
        if error:
            return False, error

        user_groups = set(payload.get('groups', []))
        required = set(required_groups)

        # HPC-AdminsëŠ” ëª¨ë“  ê¶Œí•œ ê°€ì§
        if 'HPC-Admins' in user_groups:
            return True, None

        # í•„ìš”í•œ ê·¸ë£¹ê³¼ êµì§‘í•© í™•ì¸
        if user_groups & required:
            return True, None

        return False, {'error': 'Insufficient permissions', 'code': 'PERMISSION_DENIED'}
```

#### SAML SSO ë¼ìš°íŠ¸ (ë³„ë„ Blueprint)

```python
# auth_portal_443/backend/sso/routes.py
from flask import Blueprint, request, jsonify, redirect, session as flask_session
from sso.saml_auth import SAMLAuthManager
from sso.saml_config import get_saml_settings
from jwt_manager.token_issuer import JWTTokenIssuer
import os

sso_bp = Blueprint('sso', __name__, url_prefix='/sso')

# SAML ë§¤ë‹ˆì € ì´ˆê¸°í™”
ENVIRONMENT = os.getenv('SAML_ENV', 'dev')
saml_settings = get_saml_settings(ENVIRONMENT)
saml_auth = SAMLAuthManager(saml_settings)
jwt_issuer = JWTTokenIssuer()

@sso_bp.route('/login')
def login():
    """SSO ë¡œê·¸ì¸ ì‹œì‘"""
    try:
        return_url = saml_auth.login()
        return redirect(return_url)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@sso_bp.route('/acs', methods=['POST'])
def acs():
    """SAML Assertion Consumer Service"""
    try:
        # SAML Response ì²˜ë¦¬
        user_data = saml_auth.acs()

        # Redis ì„¸ì…˜ ìƒì„±
        session_id = saml_auth.create_session(user_data)

        # JWT í† í° ë°œê¸‰
        token = jwt_issuer.issue_token(user_data)

        # Flask ì„¸ì…˜ì— ì €ì¥
        flask_session['session_id'] = session_id
        flask_session['jwt_token'] = token

        # ì„œë¹„ìŠ¤ ì„ íƒ ë©”ë‰´ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (Frontend ì½œë°± í˜ì´ì§€)
        return redirect('/callback')

    except Exception as e:
        return jsonify({'error': f'Authentication failed: {str(e)}'}), 401

@sso_bp.route('/metadata')
def metadata():
    """SAML SP Metadata"""
    try:
        metadata_xml = saml_auth.get_metadata()
        return metadata_xml, 200, {'Content-Type': 'application/xml'}
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@sso_bp.route('/logout')
def logout():
    """SSO ë¡œê·¸ì•„ì›ƒ"""
    session_id = flask_session.get('session_id')
    if session_id:
        saml_auth.delete_session(session_id)

    flask_session.clear()
    return redirect('/')
```

#### Auth Portal API

```python
# auth_portal_443/backend/api/auth.py
from flask import Blueprint, request, jsonify, session as flask_session
from jwt_manager.token_issuer import JWTTokenIssuer
from jwt_manager.token_validator import JWTTokenValidator
from sso.saml_auth import SAMLAuthManager
from sso.saml_config import get_saml_settings
import os

auth_bp = Blueprint('auth', __name__, url_prefix='/api/auth')

# JWT ë§¤ë‹ˆì € ì´ˆê¸°í™”
jwt_issuer = JWTTokenIssuer()
jwt_validator = JWTTokenValidator()

# SAML ë§¤ë‹ˆì € ì´ˆê¸°í™”
ENVIRONMENT = os.getenv('SAML_ENV', 'dev')
saml_settings = get_saml_settings(ENVIRONMENT)
saml_auth = SAMLAuthManager(saml_settings)

@auth_bp.route('/verify', methods=['POST'])
def verify_token():
    """JWT í† í° ê²€ì¦ (ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œ í˜¸ì¶œ)"""
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({'valid': False, 'error': 'No token provided'}), 401

    token = auth_header.split(' ')[1]
    payload, error = jwt_validator.validate_token(token)

    if error:
        return jsonify({'valid': False, **error}), 401

    return jsonify({'valid': True, 'user': payload})

@auth_bp.route('/refresh', methods=['POST'])
def refresh_token():
    """JWT í† í° ê°±ì‹ """
    auth_header = request.headers.get('Authorization')
    if not auth_header or not auth_header.startswith('Bearer '):
        return jsonify({'error': 'No token provided'}), 401

    old_token = auth_header.split(' ')[1]
    error, new_token = jwt_issuer.refresh_token(old_token)

    if error:
        return jsonify(error), 401

    return jsonify({'token': new_token})

@auth_bp.route('/session')
def get_session():
    """í˜„ì¬ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ"""
    session_id = flask_session.get('session_id')
    if not session_id:
        return jsonify({'authenticated': False}), 401

    session_data = saml_auth.get_session(session_id)
    if not session_data:
        return jsonify({'authenticated': False}), 401

    return jsonify({
        'authenticated': True,
        'user': {
            'user_id': session_data['user_id'],
            'email': session_data['email'],
            'display_name': session_data['display_name'],
            'groups': session_data['groups']
        },
        'token': flask_session.get('jwt_token')
    })
```

```python
# auth_portal_443/backend/api/services.py
from flask import Blueprint, jsonify, session as flask_session
from jwt_manager.token_validator import JWTTokenValidator

services_bp = Blueprint('services', __name__, url_prefix='/api/services')
jwt_validator = JWTTokenValidator()

# ì„œë¹„ìŠ¤ ì •ì˜
SERVICES = [
    {
        'id': 'admin_dashboard',
        'name': 'ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ',
        'description': 'í´ëŸ¬ìŠ¤í„° ê´€ë¦¬, Job ì œì¶œ, VNC Visualization',
        'url': 'http://localhost:3010',
        'icon': 'ğŸ–¥ï¸',
        'required_groups': ['HPC-Users'],
        'color': 'blue'
    },
    {
        'id': 'automation_system',
        'name': 'ìë™í™” ì‹œìŠ¤í…œ',
        'description': 'ì›Œí¬í”Œë¡œìš° ê´€ë¦¬, ìë™í™”ëœ Batch Job ì‹¤í–‰',
        'url': 'http://localhost:5173',
        'icon': 'ğŸ¤–',
        'required_groups': ['Automation-Users'],
        'color': 'green'
    }
]

@services_bp.route('/')
def list_services():
    """ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ ëª©ë¡ ë°˜í™˜"""
    token = flask_session.get('jwt_token')
    if not token:
        return jsonify({'error': 'Not authenticated'}), 401

    payload, error = jwt_validator.validate_token(token)
    if error:
        return jsonify(error), 401

    user_groups = set(payload.get('groups', []))

    # HPC-AdminsëŠ” ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼
    is_admin = 'HPC-Admins' in user_groups

    # ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ í•„í„°ë§
    accessible_services = []
    for service in SERVICES:
        required = set(service['required_groups'])
        if is_admin or (user_groups & required):
            accessible_services.append(service)

    return jsonify({
        'services': accessible_services,
        'user': {
            'user_id': payload['user_id'],
            'display_name': payload['display_name'],
            'groups': payload['groups']
        }
    })

@services_bp.route('/<service_id>/access')
def get_service_access_url(service_id):
    """íŠ¹ì • ì„œë¹„ìŠ¤ ì ‘ê·¼ URL ë°˜í™˜ (JWT í† í° í¬í•¨)"""
    token = flask_session.get('jwt_token')
    if not token:
        return jsonify({'error': 'Not authenticated'}), 401

    # ì„œë¹„ìŠ¤ ì°¾ê¸°
    service = next((s for s in SERVICES if s['id'] == service_id), None)
    if not service:
        return jsonify({'error': 'Service not found'}), 404

    # ê¶Œí•œ í™•ì¸
    has_permission, error = jwt_validator.check_permission(token, service['required_groups'])
    if not has_permission:
        return jsonify(error), 403

    # ì„œë¹„ìŠ¤ URLì— í† í° ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
    access_url = f"{service['url']}?token={token}"

    return jsonify({
        'service': service,
        'access_url': access_url,
        'token': token
    })
```

#### Auth Portal ë©”ì¸ ì•±

```python
# auth_portal_443/backend/app.py
from flask import Flask, session
from flask_session import Session
from flask_cors import CORS
import redis
import os

app = Flask(__name__)

# CORS ì„¤ì • (ê°œë°œ í™˜ê²½)
CORS(app, supports_credentials=True, origins=[
    'http://localhost:443',
    'http://localhost:3010',
    'http://localhost:5173'
])

# Flask-Session ì„¤ì • (Redis)
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'change-this-in-production')
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.Redis(host='localhost', port=6379, db=0)
app.config['SESSION_COOKIE_SECURE'] = False  # HTTPS ì‚¬ìš© ì‹œ True
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['PERMANENT_SESSION_LIFETIME'] = 28800  # 8ì‹œê°„

Session(app)

# Blueprint ë“±ë¡
from sso.routes import sso_bp
from api.auth import auth_bp
from api.services import services_bp

app.register_blueprint(sso_bp)
app.register_blueprint(auth_bp)
app.register_blueprint(services_bp)

# í—¬ìŠ¤ì²´í¬
@app.route('/health')
def health():
    return {'status': 'ok', 'service': 'auth-portal'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=4430, debug=True)
```

---

### 0.6 ê¸°ì¡´ ì„œë¹„ìŠ¤ì— JWT ê²€ì¦ ì¶”ê°€

#### backend_5010 (ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ)

```python
# backend_5010/jwt_middleware.py (ì‹ ê·œ)
from functools import wraps
from flask import request, jsonify
import jwt
import os

JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'change-this-secret-key-in-production')

def jwt_required(f):
    """JWT í† í° ê²€ì¦ ë°ì½”ë ˆì´í„°"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_header = request.headers.get('Authorization')
        if not auth_header or not auth_header.startswith('Bearer '):
            return jsonify({'error': 'No token provided'}), 401

        token = auth_header.split(' ')[1]

        try:
            payload = jwt.decode(token, JWT_SECRET_KEY, algorithms=['HS256'])
            request.user = payload  # ì‚¬ìš©ì ì •ë³´ë¥¼ request ê°ì²´ì— ì¶”ê°€
        except jwt.ExpiredSignatureError:
            return jsonify({'error': 'Token has expired'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'error': 'Invalid token'}), 401

        return f(*args, **kwargs)
    return decorated_function

def permission_required(required_groups):
    """ê¶Œí•œ í™•ì¸ ë°ì½”ë ˆì´í„°"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not hasattr(request, 'user'):
                return jsonify({'error': 'Not authenticated'}), 401

            user_groups = set(request.user.get('groups', []))
            required = set(required_groups)

            # HPC-AdminsëŠ” ëª¨ë“  ê¶Œí•œ
            if 'HPC-Admins' in user_groups:
                return f(*args, **kwargs)

            if not (user_groups & required):
                return jsonify({'error': 'Permission denied'}), 403

            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

```python
# backend_5010/visualization/__init__.py ì—…ë°ì´íŠ¸
from flask import Blueprint, request, jsonify
from jwt_middleware import jwt_required, permission_required

visualization_bp = Blueprint('visualization', __name__, url_prefix='/api/visualization')

@visualization_bp.route('/sessions', methods=['POST'])
@jwt_required
@permission_required(['GPU-Users'])
def create_session():
    """VNC ì„¸ì…˜ ìƒì„± (JWT ì¸ì¦ + GPU ê¶Œí•œ í•„ìš”)"""
    user_id = request.user['user_id']  # JWTì—ì„œ ì¶”ì¶œ

    # ... (ê¸°ì¡´ ì„¸ì…˜ ìƒì„± ë¡œì§)

    return jsonify({'session': session_data})
```

#### backend_5000 (ìë™í™” ì‹œìŠ¤í…œ)

```python
# backend_5000/app.py (ì‹ ê·œ)
from flask import Flask, request, jsonify
from flask_cors import CORS
import jwt
import os
import requests

app = Flask(__name__)
CORS(app)

JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'change-this-secret-key-in-production')
BACKEND_5010_URL = 'http://localhost:5010'

# JWT ê²€ì¦ (backend_5010ê³¼ ë™ì¼)
def jwt_required(f):
    # ... (ìœ„ì™€ ë™ì¼)

@app.route('/api/workflows', methods=['GET'])
@jwt_required
@permission_required(['Automation-Users'])
def list_workflows():
    """ì›Œí¬í”Œë¡œìš° ëª©ë¡ (ìë™í™” ê¶Œí•œ í•„ìš”)"""
    user_id = request.user['user_id']

    # ... ì›Œí¬í”Œë¡œìš° ëª©ë¡ ë°˜í™˜

    return jsonify({'workflows': workflows})

@app.route('/api/slurm/<path:subpath>', methods=['GET', 'POST', 'DELETE'])
@jwt_required
def proxy_to_5010(subpath):
    """backend_5010 í”„ë¡ì‹œ"""
    # JWT í† í°ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬
    auth_header = request.headers.get('Authorization')

    # 5010ìœ¼ë¡œ ìš”ì²­ ì „ë‹¬
    url = f'{BACKEND_5010_URL}/api/{subpath}'
    headers = {'Authorization': auth_header}

    if request.method == 'GET':
        resp = requests.get(url, headers=headers)
    elif request.method == 'POST':
        resp = requests.post(url, headers=headers, json=request.json)
    elif request.method == 'DELETE':
        resp = requests.delete(url, headers=headers)

    return jsonify(resp.json()), resp.status_code

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
```

---

### 0.7 Frontend JWT ì²˜ë¦¬

#### frontend_3010 (ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ)

```typescript
// frontend_3010/src/utils/auth.ts (ì‹ ê·œ)
export class AuthService {
  private static TOKEN_KEY = 'jwt_token';

  // URLì—ì„œ í† í° ì¶”ì¶œ ë° ì €ì¥
  static initializeFromURL() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    if (token) {
      this.setToken(token);
      // URLì—ì„œ í† í° ì œê±°
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  static setToken(token: string) {
    localStorage.setItem(this.TOKEN_KEY, token);
  }

  static getToken(): string | null {
    return localStorage.getItem(this.TOKEN_KEY);
  }

  static clearToken() {
    localStorage.removeItem(this.TOKEN_KEY);
  }

  static async verifyToken(): Promise<boolean> {
    const token = this.getToken();
    if (!token) return false;

    try {
      const response = await fetch('http://localhost:4430/api/auth/verify', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      return response.ok;
    } catch {
      return false;
    }
  }

  static getAuthHeader() {
    const token = this.getToken();
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  }
}
```

```typescript
// frontend_3010/src/App.tsx ì—…ë°ì´íŠ¸
import { useEffect, useState } from 'react';
import { AuthService } from './utils/auth';

function App() {
  const [authenticated, setAuthenticated] = useState(false);

  useEffect(() => {
    // URLì—ì„œ í† í° ì¶”ì¶œ
    AuthService.initializeFromURL();

    // í† í° ê²€ì¦
    AuthService.verifyToken().then(valid => {
      if (!valid) {
        // ì¸ì¦ ì‹¤íŒ¨ ì‹œ Auth Portalë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = 'http://localhost:443';
      } else {
        setAuthenticated(true);
      }
    });
  }, []);

  if (!authenticated) {
    return <div>Authenticating...</div>;
  }

  return (
    // ... ê¸°ì¡´ ì•± ì»´í¬ë„ŒíŠ¸
  );
}
```

```typescript
// frontend_3010/src/utils/api.ts ì—…ë°ì´íŠ¸
import { AuthService } from './auth';

export async function fetchAPI(url: string, options: RequestInit = {}) {
  const headers = {
    'Content-Type': 'application/json',
    ...AuthService.getAuthHeader(),  // JWT í† í° ìë™ ì¶”ê°€
    ...options.headers
  };

  const response = await fetch(url, { ...options, headers });

  if (response.status === 401) {
    // í† í° ë§Œë£Œ ì‹œ Auth Portalë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    AuthService.clearToken();
    window.location.href = 'http://localhost:443';
  }

  return response;
}
```

```python
# backend_5010/sso/saml_config.py
import os

# SAML ì„¤ì •
SAML_SETTINGS = {
    # Service Provider (SP) ì„¤ì •
    'sp': {
        'entityId': os.getenv('SAML_SP_ENTITY_ID', 'http://localhost:5010/sso/metadata'),
        'assertionConsumerService': {
            'url': os.getenv('SAML_ACS_URL', 'http://localhost:5010/sso/acs'),
            'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST'
        },
        'singleLogoutService': {
            'url': os.getenv('SAML_SLS_URL', 'http://localhost:5010/sso/sls'),
            'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect'
        },
        'NameIDFormat': 'urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified',
        'x509cert': '',
        'privateKey': ''
    },

    # Identity Provider (IdP) ì„¤ì •
    'idp': {
        # ê°œë°œ í™˜ê²½: saml-idp
        'dev': {
            'entityId': 'http://localhost:7000/metadata',
            'singleSignOnService': {
                'url': 'http://localhost:7000/saml/sso',
                'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect'
            },
            'singleLogoutService': {
                'url': 'http://localhost:7000/saml/slo',
                'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect'
            },
            'x509cert': open('saml_certs/idp-cert.pem').read()
        },

        # í”„ë¡œë•ì…˜ í™˜ê²½: ADFS
        'prod': {
            'entityId': os.getenv('ADFS_ENTITY_ID', 'http://adfs.your-domain.com/adfs/services/trust'),
            'singleSignOnService': {
                'url': os.getenv('ADFS_SSO_URL', 'https://adfs.your-domain.com/adfs/ls/'),
                'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect'
            },
            'singleLogoutService': {
                'url': os.getenv('ADFS_SLO_URL', 'https://adfs.your-domain.com/adfs/ls/'),
                'binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect'
            },
            'x509cert': os.getenv('ADFS_CERT', '')
        }
    },

    'security': {
        'nameIdEncrypted': False,
        'authnRequestsSigned': True,
        'logoutRequestSigned': True,
        'logoutResponseSigned': True,
        'signMetadata': True,
        'wantMessagesSigned': True,
        'wantAssertionsSigned': True,
        'wantNameId': True,
        'wantNameIdEncrypted': False,
        'wantAssertionsEncrypted': False,
        'signatureAlgorithm': 'http://www.w3.org/2001/04/xmldsig-more#rsa-sha256',
        'digestAlgorithm': 'http://www.w3.org/2001/04/xmlenc#sha256'
    }
}

def get_saml_settings(environment='dev'):
    """í™˜ê²½ì— ë”°ë¥¸ SAML ì„¤ì • ë°˜í™˜"""
    settings = SAML_SETTINGS.copy()
    settings['idp'] = SAML_SETTINGS['idp'][environment]
    return settings
```

```python
# backend_5010/sso/saml_auth.py
from onelogin.saml2.auth import OneLogin_Saml2_Auth
from onelogin.saml2.utils import OneLogin_Saml2_Utils
from flask import request, session
import redis

class SAMLAuthManager:
    """SAML ì¸ì¦ ê´€ë¦¬"""

    def __init__(self, saml_settings):
        self.saml_settings = saml_settings
        self.redis_client = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)

    def init_saml_auth(self, req):
        """SAML Auth ê°ì²´ ì´ˆê¸°í™”"""
        auth = OneLogin_Saml2_Auth(req, self.saml_settings)
        return auth

    def prepare_flask_request(self):
        """Flask requestë¥¼ SAML í˜•ì‹ìœ¼ë¡œ ë³€í™˜"""
        url_data = {
            'https': 'on' if request.scheme == 'https' else 'off',
            'http_host': request.host,
            'server_port': request.environ.get('SERVER_PORT'),
            'script_name': request.path,
            'get_data': request.args.copy(),
            'post_data': request.form.copy()
        }
        return url_data

    def login(self):
        """SSO ë¡œê·¸ì¸ ì‹œì‘ (SAML AuthnRequest ìƒì„±)"""
        req = self.prepare_flask_request()
        auth = self.init_saml_auth(req)

        # SAML AuthnRequest ìƒì„± ë° IdPë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        return auth.login(return_to=request.args.get('return_to', '/visualization'))

    def acs(self):
        """Assertion Consumer Service (SAML Response ì²˜ë¦¬)"""
        req = self.prepare_flask_request()
        auth = self.init_saml_auth(req)

        # SAML Response ì²˜ë¦¬
        auth.process_response()

        errors = auth.get_errors()
        if errors:
            raise Exception(f"SAML authentication failed: {', '.join(errors)}")

        if not auth.is_authenticated():
            raise Exception("User not authenticated")

        # ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        user_data = {
            'nameID': auth.get_nameid(),
            'email': auth.get_attribute('email')[0] if auth.get_attribute('email') else '',
            'displayName': auth.get_attribute('displayName')[0] if auth.get_attribute('displayName') else '',
            'groups': auth.get_attribute('groups') or [],
            'sessionIndex': auth.get_session_index()
        }

        return user_data

    def create_session(self, user_data):
        """ì‚¬ìš©ì ì„¸ì…˜ ìƒì„± (Redis)"""
        import uuid
        import time

        session_id = str(uuid.uuid4())
        session_data = {
            'session_id': session_id,
            'user_id': user_data['nameID'],
            'email': user_data['email'],
            'display_name': user_data['displayName'],
            'groups': ','.join(user_data['groups']),
            'saml_session_index': user_data['sessionIndex'],
            'created_at': int(time.time()),
            'expires_at': int(time.time()) + 28800  # 8ì‹œê°„
        }

        # Redisì— ì„¸ì…˜ ì €ì¥ (TTL: 8ì‹œê°„)
        self.redis_client.hmset(f"session:{session_id}", session_data)
        self.redis_client.expire(f"session:{session_id}", 28800)

        # ì‚¬ìš©ìë³„ ì„¸ì…˜ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        self.redis_client.sadd(f"user_sessions:{user_data['nameID']}", session_id)

        return session_id

    def get_session(self, session_id):
        """ì„¸ì…˜ ì •ë³´ ì¡°íšŒ"""
        session_data = self.redis_client.hgetall(f"session:{session_id}")
        if not session_data:
            return None

        # groupsë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
        session_data['groups'] = session_data.get('groups', '').split(',') if session_data.get('groups') else []
        return session_data

    def logout(self, session_id):
        """SSO ë¡œê·¸ì•„ì›ƒ"""
        session_data = self.get_session(session_id)
        if not session_data:
            return None

        req = self.prepare_flask_request()
        auth = self.init_saml_auth(req)

        # SAML LogoutRequest ìƒì„±
        return auth.logout(
            name_id=session_data['user_id'],
            session_index=session_data.get('saml_session_index')
        )

    def check_permission(self, session_id, required_groups):
        """ê¶Œí•œ í™•ì¸"""
        session_data = self.get_session(session_id)
        if not session_data:
            return False

        user_groups = set(session_data['groups'])
        required = set(required_groups)

        # ì‚¬ìš©ì ê·¸ë£¹ì´ í•„ìš”í•œ ê·¸ë£¹ê³¼ êµì§‘í•©ì´ ìˆëŠ”ì§€ í™•ì¸
        return bool(user_groups & required)
```

```python
# backend_5010/sso/routes.py
from flask import render_template, redirect, request, session as flask_session, jsonify, url_for
from . import sso_bp
from .saml_auth import SAMLAuthManager
from .saml_config import get_saml_settings
import os

# í™˜ê²½ ë³€ìˆ˜ë¡œ ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ ì„ íƒ
ENVIRONMENT = os.getenv('SAML_ENV', 'dev')  # dev ë˜ëŠ” prod
saml_settings = get_saml_settings(ENVIRONMENT)
saml_auth = SAMLAuthManager(saml_settings)

@sso_bp.route('/login')
def login():
    """SSO ë¡œê·¸ì¸ ì‹œì‘"""
    try:
        return_url = saml_auth.login()
        return redirect(return_url)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@sso_bp.route('/acs', methods=['POST'])
def acs():
    """Assertion Consumer Service (SAML Response ìˆ˜ì‹ )"""
    try:
        # SAML Response ì²˜ë¦¬
        user_data = saml_auth.acs()

        # ì„¸ì…˜ ìƒì„±
        session_id = saml_auth.create_session(user_data)

        # Flask ì„¸ì…˜ì— ì„¸ì…˜ ID ì €ì¥
        flask_session['session_id'] = session_id
        flask_session['user_id'] = user_data['nameID']

        # ì›ë˜ ìš”ì²­í–ˆë˜ URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        return_to = request.form.get('RelayState', '/visualization')
        return redirect(return_to)

    except Exception as e:
        return jsonify({'error': f'Authentication failed: {str(e)}'}), 401

@sso_bp.route('/logout')
def logout():
    """SSO ë¡œê·¸ì•„ì›ƒ"""
    session_id = flask_session.get('session_id')
    if session_id:
        try:
            logout_url = saml_auth.logout(session_id)
            flask_session.clear()
            return redirect(logout_url)
        except Exception as e:
            flask_session.clear()
            return redirect('/login')

    return redirect('/login')

@sso_bp.route('/metadata')
def metadata():
    """SAML Metadata (SP) ì œê³µ"""
    req = saml_auth.prepare_flask_request()
    auth = saml_auth.init_saml_auth(req)
    settings = auth.get_settings()
    metadata = settings.get_sp_metadata()
    errors = settings.validate_metadata(metadata)

    if errors:
        return jsonify({'errors': errors}), 500

    return metadata, 200, {'Content-Type': 'text/xml'}

@sso_bp.route('/session')
def get_session_info():
    """í˜„ì¬ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ (ë””ë²„ê¹…ìš©)"""
    session_id = flask_session.get('session_id')
    if not session_id:
        return jsonify({'authenticated': False}), 401

    session_data = saml_auth.get_session(session_id)
    if not session_data:
        return jsonify({'authenticated': False}), 401

    return jsonify({
        'authenticated': True,
        'user': {
            'user_id': session_data['user_id'],
            'email': session_data['email'],
            'display_name': session_data['display_name'],
            'groups': session_data['groups']
        }
    })
```

### 0.5 App.py í†µí•©

```python
# backend_5010/app.py ì—…ë°ì´íŠ¸
from flask import Flask, session
from flask_session import Session
import redis

app = Flask(__name__)

# Flask-Session ì„¤ì • (Redis ë°±ì—”ë“œ)
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'your-secret-key-change-this')
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.Redis(host='localhost', port=6379, db=0)
app.config['SESSION_COOKIE_SECURE'] = True  # HTTPS ì‚¬ìš© ì‹œ
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['PERMANENT_SESSION_LIFETIME'] = 28800  # 8ì‹œê°„

Session(app)

# SSO Blueprint ë“±ë¡
from sso import sso_bp
app.register_blueprint(sso_bp)

# ê¸°ì¡´ Blueprintë“¤
# ... (ê¸°ì¡´ ì½”ë“œ)

# ì¸ì¦ ë°ì½”ë ˆì´í„°
from functools import wraps
from flask import redirect, url_for

def login_required(f):
    """ë¡œê·¸ì¸ í•„ìˆ˜ ë°ì½”ë ˆì´í„°"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'session_id' not in session:
            return redirect(url_for('sso.login', return_to=request.url))
        return f(*args, **kwargs)
    return decorated_function

def permission_required(groups):
    """ê¶Œí•œ í™•ì¸ ë°ì½”ë ˆì´í„°"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            from sso.routes import saml_auth

            session_id = session.get('session_id')
            if not session_id:
                return redirect(url_for('sso.login', return_to=request.url))

            if not saml_auth.check_permission(session_id, groups):
                return jsonify({'error': 'Permission denied'}), 403

            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### 0.6 Visualization APIì— ì¸ì¦ ì ìš©

```python
# backend_5010/visualization/__init__.py
from flask import Blueprint, session, jsonify
from app import login_required, permission_required

visualization_bp = Blueprint('visualization', __name__, url_prefix='/api/visualization')

@visualization_bp.route('/sessions', methods=['POST'])
@login_required
@permission_required(['HPC-Users', 'GPU-Users'])  # GPU ì‚¬ìš© ê¶Œí•œ í•„ìš”
def create_session():
    """VNC ì„¸ì…˜ ìƒì„± (ë¡œê·¸ì¸ + GPU ê¶Œí•œ í•„ìš”)"""
    user_id = session.get('user_id')

    # ... (ê¸°ì¡´ ì„¸ì…˜ ìƒì„± ë¡œì§)

    return jsonify({'session': session_data})

@visualization_bp.route('/sessions', methods=['GET'])
@login_required
def list_sessions():
    """ì‚¬ìš©ì ì„¸ì…˜ ëª©ë¡ (ë¡œê·¸ì¸ë§Œ í•„ìš”)"""
    user_id = session.get('user_id')

    # ... (ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ)

    return jsonify({'sessions': sessions})
```

### 0.7 í”„ë¡œë•ì…˜ ADFS ì—°ë™ ì¤€ë¹„

#### ADFS ì„œë²„ ì„¤ì • (ê´€ë¦¬ì ì‘ì—…)

```powershell
# ADFS ì„œë²„ì—ì„œ ì‹¤í–‰ (PowerShell)

# 1. Relying Party Trust ì¶”ê°€
Add-ADFSRelyingPartyTrust `
    -Name "Slurm Dashboard" `
    -MetadataUrl "http://your-dashboard-host:5010/sso/metadata" `
    -IssuanceAuthorizationRulesFile "permit-all.txt" `
    -Identifier "http://your-dashboard-host:5010/sso/metadata"

# 2. Claim Rules ì„¤ì •
$ruleSet = @'
@RuleName = "Send LDAP Attributes"
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]
 => issue(store = "Active Directory",
    types = ("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",
             "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname",
             "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname",
             "http://schemas.xmlsoap.org/claims/Group"),
    query = ";mail,givenName,sn,tokenGroups;{0}",
    param = c.Value);

@RuleName = "Transform to NameID"
c:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"]
 => issue(Type = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier",
    Issuer = c.Issuer,
    OriginalIssuer = c.OriginalIssuer,
    Value = c.Value,
    ValueType = c.ValueType);
'@

Set-ADFSRelyingPartyTrust `
    -TargetName "Slurm Dashboard" `
    -IssuanceTransformRules $ruleSet
```

#### Backend í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í”„ë¡œë•ì…˜)

```bash
# backend_5010/.env.production
SAML_ENV=prod
ADFS_ENTITY_ID=http://adfs.your-domain.com/adfs/services/trust
ADFS_SSO_URL=https://adfs.your-domain.com/adfs/ls/
ADFS_SLO_URL=https://adfs.your-domain.com/adfs/ls/
ADFS_CERT="<ADFS ì¸ì¦ì„œ ë‚´ìš©>"
SECRET_KEY="<ê°•ë ¥í•œ ë¹„ë°€í‚¤ ìƒì„±>"
```

---

## 1. í˜„í™© ë¶„ì„

### 1.1 ê¸°ì¡´ ì‹œìŠ¤í…œ êµ¬ì¡°

#### Slurm + Apptainer ì¸í”„ë¼ (ì´ë¯¸ êµ¬ì¶•ë¨)
```
KooSlurmInstallAutomationRefactory/
â”œâ”€â”€ apptainers/                      # Apptainer ì´ë¯¸ì§€ ì €ì¥ì†Œ
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ ubuntu_python.def
â”‚   â””â”€â”€ *.sif íŒŒì¼ë“¤
â”œâ”€â”€ sync_apptainers_to_nodes.sh      # ë…¸ë“œ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ my_cluster.yaml                  # Apptainer ì„¤ì • í¬í•¨
â””â”€â”€ dashboard/
    â”œâ”€â”€ backend_5010/
    â”œâ”€â”€ frontend_3010/
    â”œâ”€â”€ websocket_5011/
    â”œâ”€â”€ node_exporter_9100/
    â””â”€â”€ prometheus_9090/
```

#### ê³„ì‚° ë…¸ë“œ Apptainer ê²½ë¡œ
- **ê³µìœ  ì´ë¯¸ì§€**: `/scratch/apptainers/` (read-only .sif íŒŒì¼)
- **ì‚¬ìš©ì ìƒŒë“œë°•ìŠ¤**: `/scratch/apptainer_sandboxes/` (writable)
- **ë°”ì¸ë“œ ê²½ë¡œ**: `/home`, `/share`, `/scratch`, `/tmp`

#### ê¸°ì¡´ Apptainer ì„¤ì • (my_cluster.yaml)
```yaml
container_support:
  apptainer:
    enabled: true
    version: 1.2.5
    install_path: /usr/local
    image_path: /share/apptainer/images
    cache_path: /tmp/apptainer
    scratch_image_path: /scratch/apptainer/images
    bind_paths:
      - /home
      - /share
      - /scratch
      - /tmp
    auto_sync_images: true
```

### 1.2 ìš”êµ¬ì‚¬í•­ ì •ë¦¬

#### í•µì‹¬ ìš”êµ¬ì‚¬í•­
1. **Slurm Jobìœ¼ë¡œ ì‹¤í–‰**: `sbatch`ë¡œ Apptainer ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰
2. **ìƒŒë“œë°•ìŠ¤ ëª¨ë“œ**: Writable filesystem (ì‚¬ìš©ì ì„¤ì • ì €ì¥)
3. **GPU ì ‘ê·¼**: `--nv` ì˜µì…˜ìœ¼ë¡œ NVIDIA GPU ì ‘ê·¼
4. **VNC ì„œë²„**: ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ì—ì„œ TurboVNC ì‹¤í–‰
5. **ì›¹ ì ‘ì†**: noVNCë¡œ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†
6. **ë‹¤ì¤‘ ì‚¬ìš©ì**: ì‚¬ìš©ìë³„ ë…ë¦½ì ì¸ ìƒŒë“œë°•ìŠ¤

#### ê¸°ìˆ ì  ìš”êµ¬ì‚¬í•­
- Apptainer 1.2.5+ (already installed)
- TurboVNC (ì»¨í…Œì´ë„ˆ ë‚´ë¶€)
- VirtualGL (ì»¨í…Œì´ë„ˆ ë‚´ë¶€)
- XFCE4 ë°ìŠ¤í¬í†± (ì»¨í…Œì´ë„ˆ ë‚´ë¶€)
- WebSocket í”„ë¡ì‹œ (ì™¸ë¶€)

---

## 2. ê¸°ìˆ  ìŠ¤íƒ ì„ íƒ

### 2.1 ìµœì¢… ì„ íƒ: **Apptainer ìƒŒë“œë°•ìŠ¤ + TurboVNC + React**

#### ì„ íƒ ê·¼ê±°

| í•­ëª© | Open onDemand | Apptainer ìƒŒë“œë°•ìŠ¤ ë°©ì‹ |
|------|---------------|-------------------------|
| ì•„í‚¤í…ì²˜ ì¼ê´€ì„± | âŒ ë³„ë„ ì„œë²„ | âœ… ê¸°ì¡´ Slurm/Apptainer í™œìš© |
| Apptainer í†µí•© | âš ï¸ ì œí•œì  | âœ… ì™„ë²½í•œ í†µí•© |
| GPU ì ‘ê·¼ | âš ï¸ ì¶”ê°€ ì„¤ì • | âœ… `--nv` í”Œë˜ê·¸ë¡œ ê°„ë‹¨ |
| ìƒŒë“œë°•ìŠ¤ ì§€ì› | âŒ ì—†ìŒ | âœ… ë„¤ì´í‹°ë¸Œ ì§€ì› |
| ê¸°ì¡´ ì¸í”„ë¼ í™œìš© | âŒ ìƒˆ ì¸í”„ë¼ | âœ… 100% ì¬ì‚¬ìš© |
| ìœ ì§€ë³´ìˆ˜ | âš ï¸ Ruby/Rails | âœ… Python/React (ì¼ê´€ì„±) |

**ê²°ë¡ **: Apptainer ìƒŒë“œë°•ìŠ¤ ë°©ì‹ì´ ê¸°ì¡´ ì¸í”„ë¼ì™€ ì™„ë²½í•˜ê²Œ í†µí•©ë˜ë©°, GPU ì ‘ê·¼ì´ ê°„ë‹¨í•˜ê³ , ìƒŒë“œë°•ìŠ¤ ëª¨ë“œë¥¼ ë„¤ì´í‹°ë¸Œë¡œ ì§€ì›í•©ë‹ˆë‹¤.

---

## 3. Apptainer ìƒŒë“œë°•ìŠ¤ ì•„í‚¤í…ì²˜

### 3.1 ì „ì²´ ë°ì´í„° íë¦„

```
User Browser (React)
    â†“ (1) Create Session Request
Backend API (5010)
    â†“ (2) Submit Slurm Job
Slurm Controller
    â†“ (3) Schedule to GPU Node
GPU Node (node001)
    â†“ (4) Create/Run Apptainer Sandbox
Apptainer Sandbox (/scratch/apptainer_sandboxes/user_sessionid/)
    â”œâ”€ TurboVNC Server (Display :1)  â† (5) Start VNC
    â”œâ”€ VirtualGL
    â”œâ”€ XFCE4 Desktop
    â””â”€ GPU Applications
    â†“ (6) VNC Port (5901)
WebSocket Proxy (6001)
    â†“ (7) WebSocket â†” TCP
User Browser (noVNC)
    â†“ (8) Display Desktop
```

### 3.2 ìƒŒë“œë°•ìŠ¤ ìƒì„± í”Œë¡œìš°

```bash
# 1. Master .sif ì´ë¯¸ì§€ (read-only)
/scratch/apptainers/ubuntu_vnc_gpu.sif

# 2. ì„¸ì…˜ë³„ ìƒŒë“œë°•ìŠ¤ ìƒì„± (writable)
apptainer build --sandbox \
    /scratch/apptainer_sandboxes/user_session123/ \
    /scratch/apptainers/ubuntu_vnc_gpu.sif

# 3. ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰ (GPU í¬í•¨)
apptainer exec --nv --writable \
    --bind /home:/home \
    --bind /scratch:/scratch \
    /scratch/apptainer_sandboxes/user_session123/ \
    /opt/TurboVNC/bin/vncserver :1

# 4. ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ êµ¬ì¡°
/scratch/apptainer_sandboxes/user_session123/
â”œâ”€â”€ bin/, usr/, etc/ (OS íŒŒì¼ ì‹œìŠ¤í…œ)
â”œâ”€â”€ opt/TurboVNC/
â”œâ”€â”€ opt/VirtualGL/
â”œâ”€â”€ home/user/.vnc/        # VNC ì„¤ì • (persistent)
â”œâ”€â”€ tmp/                   # ì„ì‹œ íŒŒì¼
â””â”€â”€ var/log/               # ë¡œê·¸
```

### 3.3 Slurm Job ìŠ¤í¬ë¦½íŠ¸ êµ¬ì¡°

```bash
#!/bin/bash
#SBATCH --job-name=vnc_session_{{SESSION_ID}}
#SBATCH --nodelist={{NODE_ID}}
#SBATCH --gres=gpu:1
#SBATCH --mem=8G
#SBATCH --time=08:00:00
#SBATCH --output=/scratch/vnc_logs/%j.out

# í™˜ê²½ ë³€ìˆ˜
export SESSION_ID={{SESSION_ID}}
export DISPLAY=:{{DISPLAY_NUM}}
export SANDBOX_PATH=/scratch/apptainer_sandboxes/${USER}_${SESSION_ID}

# 1. ìƒŒë“œë°•ìŠ¤ ìƒì„± (ì²« ì‹¤í–‰ ì‹œ)
if [ ! -d "$SANDBOX_PATH" ]; then
    echo "Creating sandbox..."
    apptainer build --sandbox \
        $SANDBOX_PATH \
        /scratch/apptainers/ubuntu_vnc_gpu.sif
fi

# 2. VNC ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
echo "Setting VNC password..."
apptainer exec --nv --writable $SANDBOX_PATH \
    bash -c "mkdir -p ~/.vnc && echo '{{VNC_PASSWORD}}' | vncpasswd -f > ~/.vnc/passwd && chmod 600 ~/.vnc/passwd"

# 3. TurboVNC ì„œë²„ ì‹œì‘
echo "Starting TurboVNC server..."
apptainer exec --nv --writable \
    --bind /home:/home \
    --bind /scratch:/scratch \
    $SANDBOX_PATH \
    /opt/TurboVNC/bin/vncserver $DISPLAY \
        -geometry {{RESOLUTION}} \
        -depth 24 \
        -securitytypes none

# 4. VNC ì„œë²„ PID ì €ì¥
VNC_PID=$(apptainer exec $SANDBOX_PATH pgrep -f "Xvnc $DISPLAY")
echo "VNC Server PID: $VNC_PID"
echo $VNC_PID > /scratch/vnc_pids/${SESSION_ID}.pid

# 5. ì„¸ì…˜ ìœ ì§€ (Jobì´ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡)
echo "VNC session started on $HOSTNAME$DISPLAY"
echo "Waiting for session termination signal..."
while [ -f /scratch/vnc_pids/${SESSION_ID}.pid ]; do
    sleep 10
done

# 6. ì •ë¦¬ ì‘ì—…
echo "Terminating VNC server..."
apptainer exec --nv --writable $SANDBOX_PATH \
    /opt/TurboVNC/bin/vncserver -kill $DISPLAY

echo "Session terminated."
```

---

## 4. ì‹œìŠ¤í…œ ì„¤ê³„

### 4.1 í´ë” êµ¬ì¡°

```
dashboard/
â”œâ”€â”€ visualization_6000/              # ì„¸ì…˜ ê´€ë¦¬ ë°±ì—”ë“œ
â”‚   â”œâ”€â”€ app.py                       # Flask API
â”‚   â”œâ”€â”€ session_manager.py           # ì„¸ì…˜ ìƒì„±/ê´€ë¦¬
â”‚   â”œâ”€â”€ slurm_apptainer.py           # Slurm + Apptainer í†µí•© â­
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ start.sh / stop.sh
â”‚   â”œâ”€â”€ venv/
â”‚   â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ sessions.db
â”‚   â””â”€â”€ job_templates/               # Slurm Job í…œí”Œë¦¿ â­
â”‚       â”œâ”€â”€ vnc_session.sh.j2        # Jinja2 í…œí”Œë¦¿
â”‚       â””â”€â”€ cleanup_sandbox.sh.j2
â”‚
â”œâ”€â”€ visualization_6001/              # WebSocket í”„ë¡ì‹œ
â”‚   â”œâ”€â”€ websocket_proxy.py
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ start.sh / stop.sh
â”‚   â””â”€â”€ venv/
â”‚
â”œâ”€â”€ frontend_3010/
â”‚   â””â”€â”€ src/components/Visualization/
â”‚       â”œâ”€â”€ index.tsx
â”‚       â”œâ”€â”€ VNCViewer.tsx
â”‚       â”œâ”€â”€ SessionManager.tsx
â”‚       â””â”€â”€ ApptainerStatus.tsx      # ìƒŒë“œë°•ìŠ¤ ìƒíƒœ í‘œì‹œ â­
â”‚
â””â”€â”€ apptainer_images/                # Apptainer ì´ë¯¸ì§€ â­
    â”œâ”€â”€ ubuntu_vnc_gpu.def           # Definition íŒŒì¼
    â”œâ”€â”€ build_image.sh               # ì´ë¯¸ì§€ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸
    â””â”€â”€ sync_to_nodes.sh             # ë…¸ë“œ ë™ê¸°í™”
```

### 4.2 ì»´í¬ë„ŒíŠ¸ ì„¤ê³„

#### visualization_6000/slurm_apptainer.py
```python
"""
Slurm + Apptainer í†µí•© ëª¨ë“ˆ
- Apptainer ìƒŒë“œë°•ìŠ¤ ìƒì„±
- Slurm Job ì œì¶œ (ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰)
- VNC ì„œë²„ ì‹œì‘ ë° ëª¨ë‹ˆí„°ë§
"""

import subprocess
import os
from jinja2 import Template

class ApptainerSandboxManager:
    def __init__(self):
        self.master_image = "/scratch/apptainers/ubuntu_vnc_gpu.sif"
        self.sandbox_base = "/scratch/apptainer_sandboxes"
    
    def create_sandbox(self, user_id, session_id):
        """ì‚¬ìš©ìë³„ ìƒŒë“œë°•ìŠ¤ ìƒì„±"""
        sandbox_path = f"{self.sandbox_base}/{user_id}_{session_id}"
        
        # ìƒŒë“œë°•ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¬ì‚¬ìš©
        if os.path.exists(sandbox_path):
            return sandbox_path
        
        # ìƒˆ ìƒŒë“œë°•ìŠ¤ ìƒì„±
        cmd = [
            "apptainer", "build", "--sandbox",
            sandbox_path,
            self.master_image
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        if result.returncode != 0:
            raise Exception(f"Failed to create sandbox: {result.stderr}")
        
        return sandbox_path
    
    def submit_vnc_job(self, session_id, user_id, node_id, 
                       display_num, resolution, vnc_password):
        """VNC ì„¸ì…˜ Job ì œì¶œ"""
        # Job ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Jinja2 í…œí”Œë¦¿)
        with open("job_templates/vnc_session.sh.j2") as f:
            template = Template(f.read())
        
        job_script = template.render(
            SESSION_ID=session_id,
            NODE_ID=node_id,
            DISPLAY_NUM=display_num,
            RESOLUTION=resolution,
            VNC_PASSWORD=vnc_password,
            USER=user_id
        )
        
        # sbatchë¡œ Job ì œì¶œ
        result = subprocess.run(
            ["sbatch", "--parsable"],
            input=job_script.encode(),
            capture_output=True
        )
        
        if result.returncode != 0:
            raise Exception(f"Failed to submit job: {result.stderr}")
        
        job_id = result.stdout.decode().strip()
        return job_id
    
    def cleanup_sandbox(self, session_id, user_id):
        """ìƒŒë“œë°•ìŠ¤ ì •ë¦¬ (ì˜µì…˜)"""
        sandbox_path = f"{self.sandbox_base}/{user_id}_{session_id}"
        
        # ì£¼ì˜: ìƒŒë“œë°•ìŠ¤ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ë©´ ë‹¤ìŒ ì„¸ì…˜ì—ì„œ ì¬ìƒì„± í•„ìš”
        # ì„ íƒ 1: ì‚­ì œ
        # subprocess.run(["rm", "-rf", sandbox_path])
        
        # ì„ íƒ 2: ë³´ê´€ (ë‹¤ìŒ ì„¸ì…˜ì—ì„œ ì¬ì‚¬ìš©)
        # pass
        
        # ì„ íƒ 3: ì„ì‹œ íŒŒì¼ë§Œ ì •ë¦¬
        subprocess.run([
            "apptainer", "exec", "--writable", sandbox_path,
            "bash", "-c", "rm -rf /tmp/* /var/tmp/*"
        ])
```

---

## 5. ê°œë°œ ê³„íš

### 5.1 Phase 1: Apptainer ì´ë¯¸ì§€ êµ¬ì¶• (1ì£¼)

#### ì‘ì—… í•­ëª©
1. **Apptainer Definition íŒŒì¼ ì‘ì„±** (2ì¼)
   - [ ] `ubuntu_vnc_gpu.def` ì‘ì„±
   - [ ] TurboVNC 3.0.3 ì„¤ì¹˜
   - [ ] VirtualGL 3.1 ì„¤ì¹˜
   - [ ] XFCE4 ë°ìŠ¤í¬í†± í™˜ê²½
   - [ ] GPU ë“œë¼ì´ë²„ í˜¸í™˜ì„± í™•ì¸
   - [ ] ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ (ParaView, Blender ë“±)

2. **ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸** (2ì¼)
   - [ ] ë¡œì»¬ì—ì„œ ì´ë¯¸ì§€ ë¹Œë“œ
   - [ ] GPU ë…¸ë“œì—ì„œ í…ŒìŠ¤íŠ¸ (`--nv` í”Œë˜ê·¸)
   - [ ] VNC ì„œë²„ ì‹œì‘/ì¢…ë£Œ í…ŒìŠ¤íŠ¸
   - [ ] VirtualGL ë™ì‘ í™•ì¸ (`vglrun glxgears`)

3. **ìƒŒë“œë°•ìŠ¤ ëª¨ë“œ ê²€ì¦** (2ì¼)
   - [ ] Read-only .sif â†’ Writable sandbox ë³€í™˜
   - [ ] ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ ìˆ˜ì • í…ŒìŠ¤íŠ¸
   - [ ] ì‚¬ìš©ì ì„¤ì • persistence í™•ì¸
   - [ ] ìƒŒë“œë°•ìŠ¤ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

4. **ë…¸ë“œ ë°°í¬** (1ì¼)
   - [ ] ëª¨ë“  GPU ë…¸ë“œì— .sif ì´ë¯¸ì§€ ë³µì‚¬
   - [ ] `/scratch/apptainers/` ê¶Œí•œ ì„¤ì •
   - [ ] `/scratch/apptainer_sandboxes/` ë””ë ‰í† ë¦¬ ìƒì„±

#### ê²€ì¦ ê¸°ì¤€
```bash
# 1. ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ
apptainer build ubuntu_vnc_gpu.sif ubuntu_vnc_gpu.def

# 2. ìƒŒë“œë°•ìŠ¤ ìƒì„± ì„±ê³µ
apptainer build --sandbox test_sandbox/ ubuntu_vnc_gpu.sif

# 3. GPU ì ‘ê·¼ í™•ì¸
apptainer exec --nv test_sandbox/ nvidia-smi

# 4. VNC ì„œë²„ ì‹œì‘ ì„±ê³µ
apptainer exec --nv --writable test_sandbox/ \
    /opt/TurboVNC/bin/vncserver :1

# 5. VNC ì—°ê²° í™•ì¸
vncviewer localhost:5901
```

### 5.2 Phase 2: Slurm í†µí•© ë°±ì—”ë“œ (2ì£¼)

#### ì‘ì—… í•­ëª©
1. **slurm_apptainer.py ëª¨ë“ˆ êµ¬í˜„** (4ì¼)
   - [ ] ApptainerSandboxManager í´ë˜ìŠ¤
   - [ ] create_sandbox() - ìƒŒë“œë°•ìŠ¤ ìƒì„±
   - [ ] submit_vnc_job() - Job ì œì¶œ
   - [ ] cleanup_sandbox() - ì •ë¦¬
   - [ ] monitor_job_status() - Job ìƒíƒœ ì¶”ì 

2. **Job í…œí”Œë¦¿ ì‘ì„±** (2ì¼)
   - [ ] vnc_session.sh.j2 (Jinja2 í…œí”Œë¦¿)
   - [ ] íŒŒë¼ë¯¸í„°: session_id, node_id, display, resolution, password
   - [ ] ìƒŒë“œë°•ìŠ¤ ìƒì„±/ì¬ì‚¬ìš© ë¡œì§
   - [ ] VNC ì„œë²„ ì‹œì‘
   - [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…

3. **session_manager.py ì—…ë°ì´íŠ¸** (3ì¼)
   - [ ] create_session() - Apptainer í†µí•©
   - [ ] DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ (sandbox_path ì»¬ëŸ¼ ì¶”ê°€)
   - [ ] ì„¸ì…˜ ìƒì„± í”Œë¡œìš° ìˆ˜ì •
   - [ ] ì„¸ì…˜ ì¢…ë£Œ ì‹œ ìƒŒë“œë°•ìŠ¤ ì •ë¦¬

4. **REST API êµ¬í˜„** (3ì¼)
   - [ ] POST /api/visualization/sessions
   - [ ] GET /api/visualization/sessions
   - [ ] DELETE /api/visualization/sessions/:id
   - [ ] GET /api/visualization/nodes (GPU ì •ë³´ í¬í•¨)
   - [ ] GET /api/visualization/sandboxes/:id (ìƒŒë“œë°•ìŠ¤ ìƒíƒœ)

#### ê²€ì¦ ê¸°ì¤€
- [ ] API í˜¸ì¶œë¡œ ìƒŒë“œë°•ìŠ¤ ìƒì„± ì„±ê³µ
- [ ] Slurm Jobì´ ì •ìƒì ìœ¼ë¡œ ì œì¶œë¨
- [ ] VNC ì„œë²„ê°€ ìƒŒë“œë°•ìŠ¤ ë‚´ë¶€ì—ì„œ ì‹œì‘ë¨
- [ ] ì„¸ì…˜ DBì— sandbox_path ì €ì¥ë¨

### 5.3 Phase 3: WebSocket í”„ë¡ì‹œ + í”„ë¡ íŠ¸ì—”ë“œ (1ì£¼)

#### ì‘ì—… í•­ëª©
1. **WebSocket í”„ë¡ì‹œ** (2ì¼)
   - [ ] websocket_proxy.py (ê¸°ì¡´ ê³„íš ë™ì¼)
   - [ ] WebSocket â†” TCP ë³€í™˜
   - [ ] ì„¸ì…˜ë³„ ì—°ê²° ë¼ìš°íŒ…

2. **React ì»´í¬ë„ŒíŠ¸** (3ì¼)
   - [ ] Visualization/index.tsx
   - [ ] VNCViewer.tsx (noVNC)
   - [ ] SessionManager.tsx
   - [ ] ApptainerStatus.tsx (ìƒŒë“œë°•ìŠ¤ ìƒíƒœ)
   - [ ] NodeSelector.tsx (GPU ë…¸ë“œ ì„ íƒ)

3. **ëŒ€ì‹œë³´ë“œ í†µí•©** (2ì¼)
   - [ ] Dashboard.tsxì— 'visualization' íƒ­ ì¶”ê°€
   - [ ] Sidebar ë©”ë‰´ ì¶”ê°€
   - [ ] API ì—°ë™

#### ê²€ì¦ ê¸°ì¤€
- [ ] ë¸Œë¼ìš°ì €ì—ì„œ ì„¸ì…˜ ìƒì„± ê°€ëŠ¥
- [ ] noVNCë¡œ ë°ìŠ¤í¬í†± í‘œì‹œë¨
- [ ] GPU ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ê°€ëŠ¥ (glxgears)

### 5.4 Phase 4: ìµœì í™” ë° í…ŒìŠ¤íŠ¸ (1ì£¼)

#### ì‘ì—… í•­ëª©
1. **ì„±ëŠ¥ ìµœì í™”** (2ì¼)
   - [ ] ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš© ì „ëµ
   - [ ] VNC ì••ì¶• ì„¤ì •
   - [ ] WebSocket ë²„í¼ë§

2. **ì—ëŸ¬ ì²˜ë¦¬** (2ì¼)
   - [ ] Job ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
   - [ ] ìƒŒë“œë°•ìŠ¤ ìƒì„± ì‹¤íŒ¨ ì²˜ë¦¬
   - [ ] VNC ì—°ê²° ëŠê¹€ ë³µêµ¬

3. **E2E í…ŒìŠ¤íŠ¸** (2ì¼)
   - [ ] ì„¸ì…˜ ìƒì„± â†’ VNC ì—°ê²° â†’ ì¢…ë£Œ
   - [ ] ë‹¤ì¤‘ ì„¸ì…˜ ë™ì‹œ ìƒì„±
   - [ ] GPU ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸

4. **ë¬¸ì„œí™”** (1ì¼)
   - [ ] ì‚¬ìš©ì ê°€ì´ë“œ
   - [ ] ê´€ë¦¬ì ê°€ì´ë“œ
   - [ ] API ë¬¸ì„œ

---

## 6. Apptainer ì´ë¯¸ì§€ êµ¬ì„±

### 6.1 ubuntu_vnc_gpu.def

```singularity
Bootstrap: docker
From: ubuntu:22.04

%post
    # ê¸°ë³¸ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
    apt-get update && apt-get upgrade -y
    
    # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    apt-get install -y \
        wget curl vim git \
        build-essential \
        xorg xfce4 xfce4-terminal \
        dbus-x11 \
        mesa-utils \
        python3 python3-pip \
        net-tools

    # TurboVNC ì„¤ì¹˜
    cd /tmp
    wget https://sourceforge.net/projects/turbovnc/files/3.0.3/turbovnc_3.0.3_amd64.deb
    dpkg -i turbovnc_3.0.3_amd64.deb
    apt-get install -f -y
    rm turbovnc_3.0.3_amd64.deb

    # VirtualGL ì„¤ì¹˜
    wget https://sourceforge.net/projects/virtualgl/files/3.1/virtualgl_3.1_amd64.deb
    dpkg -i virtualgl_3.1_amd64.deb
    apt-get install -f -y
    rm virtualgl_3.1_amd64.deb

    # GPU ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜
    apt-get install -y \
        paraview \
        blender \
        gimp

    # ì •ë¦¬
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export PATH=/opt/TurboVNC/bin:$PATH
    export PATH=/opt/VirtualGL/bin:$PATH
    export VGL_DISPLAY=:0
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%startscript
    # XFCE4 ì‹œì‘
    startxfce4

%runscript
    echo "Ubuntu VNC GPU Container"
    echo "TurboVNC: /opt/TurboVNC/bin/vncserver"
    echo "VirtualGL: vglrun <command>"
    exec /bin/bash "$@"

%labels
    Author koopark
    Version 1.0
    Description Ubuntu 22.04 with TurboVNC, VirtualGL, XFCE4 for GPU visualization
```

### 6.2 ì´ë¯¸ì§€ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# apptainer_images/build_image.sh

set -e

IMAGE_NAME="ubuntu_vnc_gpu"
DEF_FILE="${IMAGE_NAME}.def"
SIF_FILE="${IMAGE_NAME}.sif"

echo "Building Apptainer image..."
sudo apptainer build $SIF_FILE $DEF_FILE

echo "Testing image..."
apptainer exec $SIF_FILE /opt/TurboVNC/bin/vncserver -version
apptainer exec $SIF_FILE vglrun glxinfo | grep "OpenGL renderer"

echo "Image built successfully: $SIF_FILE"
echo "Next step: ./sync_to_nodes.sh"
```

### 6.3 ë…¸ë“œ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# apptainer_images/sync_to_nodes.sh

IMAGE_FILE="ubuntu_vnc_gpu.sif"
TARGET_DIR="/scratch/apptainers"
NODES="node001 node002"

for node in $NODES; do
    echo "Syncing to $node..."
    ssh $node "mkdir -p $TARGET_DIR"
    scp $IMAGE_FILE $node:$TARGET_DIR/
    ssh $node "chmod 755 $TARGET_DIR/$IMAGE_FILE"
    echo "âœ“ $node done"
done

echo "All nodes synced!"
```

---

## 7. Slurm í†µí•©

### 7.1 Job í…œí”Œë¦¿ (vnc_session.sh.j2)

```bash
#!/bin/bash
#SBATCH --job-name=vnc_{{SESSION_ID}}
#SBATCH --nodelist={{NODE_ID}}
#SBATCH --gres=gpu:1
#SBATCH --mem=8G
#SBATCH --cpus-per-task=4
#SBATCH --time=08:00:00
#SBATCH --output=/scratch/vnc_logs/{{SESSION_ID}}_%j.out
#SBATCH --error=/scratch/vnc_logs/{{SESSION_ID}}_%j.err

# ========================================
# VNC Session in Apptainer Sandbox
# Session ID: {{SESSION_ID}}
# Node: {{NODE_ID}}
# Display: :{{DISPLAY_NUM}}
# ========================================

set -e

# í™˜ê²½ ë³€ìˆ˜
export SESSION_ID="{{SESSION_ID}}"
export USER_ID="{{USER}}"
export DISPLAY=":{{DISPLAY_NUM}}"
export VNC_PORT=$((5900 + {{DISPLAY_NUM}}))
export SANDBOX_PATH="/scratch/apptainer_sandboxes/${USER_ID}_${SESSION_ID}"
export MASTER_IMAGE="/scratch/apptainers/ubuntu_vnc_gpu.sif"
export VNC_PASSWORD="{{VNC_PASSWORD}}"
export RESOLUTION="{{RESOLUTION}}"

echo "=========================================="
echo "Starting VNC Session"
echo "Session ID: $SESSION_ID"
echo "User: $USER_ID"
echo "Node: $HOSTNAME"
echo "Display: $DISPLAY"
echo "VNC Port: $VNC_PORT"
echo "Sandbox: $SANDBOX_PATH"
echo "=========================================="

# 1. ìƒŒë“œë°•ìŠ¤ ìƒì„± (ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´)
if [ ! -d "$SANDBOX_PATH" ]; then
    echo "[1/5] Creating sandbox from master image..."
    apptainer build --sandbox \
        "$SANDBOX_PATH" \
        "$MASTER_IMAGE"
    echo "âœ“ Sandbox created"
else
    echo "[1/5] Sandbox already exists, reusing..."
fi

# 2. VNC ë””ë ‰í† ë¦¬ ë° ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
echo "[2/5] Configuring VNC password..."
apptainer exec --nv --writable \
    --bind /scratch:/scratch \
    "$SANDBOX_PATH" \
    bash -c "
        mkdir -p ~/.vnc
        echo '$VNC_PASSWORD' | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        echo 'âœ“ VNC password set'
    "

# 3. VNC ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
echo "[3/5] Creating VNC startup script..."
apptainer exec --nv --writable \
    --bind /scratch:/scratch \
    "$SANDBOX_PATH" \
    bash -c "
        cat > ~/.vnc/xstartup << 'EOF'
#!/bin/bash
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
export VGL_DISPLAY=:0
startxfce4 &
EOF
        chmod +x ~/.vnc/xstartup
        echo 'âœ“ Startup script created'
    "

# 4. TurboVNC ì„œë²„ ì‹œì‘
echo "[4/5] Starting TurboVNC server..."
apptainer exec --nv --writable \
    --bind /home:/home \
    --bind /scratch:/scratch \
    "$SANDBOX_PATH" \
    /opt/TurboVNC/bin/vncserver "$DISPLAY" \
        -geometry "$RESOLUTION" \
        -depth 24 \
        -securitytypes none

# VNC PID í™•ì¸ ë° ì €ì¥
sleep 2
VNC_PID=$(apptainer exec "$SANDBOX_PATH" pgrep -f "Xvnc $DISPLAY" || echo "")
if [ -z "$VNC_PID" ]; then
    echo "âœ— Failed to start VNC server"
    exit 1
fi

echo "âœ“ VNC server started (PID: $VNC_PID)"
mkdir -p /scratch/vnc_pids
echo "$VNC_PID" > /scratch/vnc_pids/${SESSION_ID}.pid

# 5. ì„¸ì…˜ ì •ë³´ ì¶œë ¥
echo "[5/5] Session ready!"
echo "=========================================="
echo "VNC Server Information:"
echo "  Display: $DISPLAY"
echo "  Port: $VNC_PORT"
echo "  Node: $HOSTNAME"
echo "  PID: $VNC_PID"
echo "  Sandbox: $SANDBOX_PATH"
echo "=========================================="

# ì„¸ì…˜ ìœ ì§€ (PID íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ë™ì•ˆ)
echo "Waiting for termination signal..."
while [ -f /scratch/vnc_pids/${SESSION_ID}.pid ]; do
    # VNC í”„ë¡œì„¸ìŠ¤ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸
    if ! apptainer exec "$SANDBOX_PATH" ps -p "$VNC_PID" > /dev/null 2>&1; then
        echo "âœ— VNC process died unexpectedly"
        break
    fi
    sleep 10
done

# 6. ì •ë¦¬ ì‘ì—…
echo "Terminating VNC server..."
apptainer exec --nv --writable \
    --bind /scratch:/scratch \
    "$SANDBOX_PATH" \
    /opt/TurboVNC/bin/vncserver -kill "$DISPLAY" || true

# PID íŒŒì¼ ì‚­ì œ
rm -f /scratch/vnc_pids/${SESSION_ID}.pid

echo "Session terminated cleanly."
```

### 7.2 ìƒŒë“œë°•ìŠ¤ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ (cleanup_sandbox.sh.j2)

```bash
#!/bin/bash
# ìƒŒë“œë°•ìŠ¤ ì •ë¦¬ (ì„ íƒì )

SESSION_ID="{{SESSION_ID}}"
USER_ID="{{USER}}"
SANDBOX_PATH="/scratch/apptainer_sandboxes/${USER_ID}_${SESSION_ID}"

echo "Cleaning up sandbox: $SANDBOX_PATH"

# ì˜µì…˜ 1: ì„ì‹œ íŒŒì¼ë§Œ ì •ë¦¬ (ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš©)
apptainer exec --writable "$SANDBOX_PATH" \
    bash -c "rm -rf /tmp/* /var/tmp/* ~/.vnc/*.log"

# ì˜µì…˜ 2: ìƒŒë“œë°•ìŠ¤ ì™„ì „ ì‚­ì œ (ë‹¤ìŒ ì„¸ì…˜ì—ì„œ ì¬ìƒì„±)
# rm -rf "$SANDBOX_PATH"

echo "Cleanup complete."
```

---

## 8. API ì„¤ê³„

### 8.1 POST /api/visualization/sessions - ì„¸ì…˜ ìƒì„±

**Request:**
```json
{
  "user_id": "koopark",
  "node_id": "node001",
  "resolution": "1920x1080",
  "quality": "high"
}
```

**Response (201):**
```json
{
  "success": true,
  "session": {
    "session_id": "abc123",
    "node_id": "node001",
    "display": 1,
    "port": 5901,
    "job_id": "12345",
    "sandbox_path": "/scratch/apptainer_sandboxes/koopark_abc123",
    "websocket_url": "ws://localhost:6001/ws/abc123",
    "status": "starting"
  }
}
```

### 8.2 GET /api/visualization/sandboxes/:id - ìƒŒë“œë°•ìŠ¤ ìƒíƒœ

**Response (200):**
```json
{
  "success": true,
  "sandbox": {
    "session_id": "abc123",
    "path": "/scratch/apptainer_sandboxes/koopark_abc123",
    "size_mb": 2048,
    "created_at": "2025-10-16T10:00:00Z",
    "status": "active",
    "vnc_running": true,
    "gpu_available": true
  }
}
```

---

## 9. í”„ë¡ íŠ¸ì—”ë“œ í†µí•©

### 9.1 ApptainerStatus.tsx (ìƒˆ ì»´í¬ë„ŒíŠ¸)

```typescript
import React, { useState, useEffect } from 'react';
import { Box, HardDrive, Cpu, CheckCircle } from 'lucide-react';

interface SandboxStatus {
  session_id: string;
  path: string;
  size_mb: number;
  status: 'active' | 'creating' | 'error';
  vnc_running: boolean;
  gpu_available: boolean;
}

interface ApptainerStatusProps {
  sessionId: string;
}

const ApptainerStatus: React.FC<ApptainerStatusProps> = ({ sessionId }) => {
  const [status, setStatus] = useState<SandboxStatus | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchStatus = async () => {
      try {
        const response = await fetch(`/api/visualization/sandboxes/${sessionId}`);
        const data = await response.json();
        setStatus(data.sandbox);
      } catch (error) {
        console.error('Failed to fetch sandbox status:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchStatus();
    const interval = setInterval(fetchStatus, 5000);
    return () => clearInterval(interval);
  }, [sessionId]);

  if (loading) return <div>Loading sandbox status...</div>;
  if (!status) return <div>Sandbox not found</div>;

  return (
    <div className="bg-white dark:bg-gray-800 p-4 rounded shadow">
      <h3 className="text-lg font-bold mb-2 flex items-center">
        <Box className="mr-2" size={20} />
        Apptainer Sandbox Status
      </h3>
      
      <div className="space-y-2">
        <div className="flex items-center">
          <HardDrive className="mr-2" size={16} />
          <span>Path: {status.path}</span>
        </div>
        
        <div className="flex items-center">
          <span className="mr-2">Size: {status.size_mb} MB</span>
        </div>
        
        <div className="flex items-center">
          <Cpu className="mr-2" size={16} />
          <span>GPU: {status.gpu_available ? 'âœ“ Available' : 'âœ— Not Available'}</span>
        </div>
        
        <div className="flex items-center">
          {status.vnc_running ? (
            <CheckCircle className="mr-2 text-green-500" size={16} />
          ) : (
            <span className="mr-2 text-red-500">âœ—</span>
          )}
          <span>VNC Server: {status.vnc_running ? 'Running' : 'Stopped'}</span>
        </div>
        
        <div className={`px-2 py-1 rounded inline-block ${
          status.status === 'active' ? 'bg-green-100 text-green-800' :
          status.status === 'creating' ? 'bg-yellow-100 text-yellow-800' :
          'bg-red-100 text-red-800'
        }`}>
          {status.status.toUpperCase()}
        </div>
      </div>
    </div>
  );
};

export default ApptainerStatus;
```

---

## 10. ë³´ì•ˆ ë° ì„±ëŠ¥

### 10.1 ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

#### Apptainer ìƒŒë“œë°•ìŠ¤ ê²©ë¦¬
- **ì‚¬ìš©ìë³„ ìƒŒë“œë°•ìŠ¤**: `/scratch/apptainer_sandboxes/USER_SESSION/`
- **ê¶Œí•œ ì œí•œ**: ìƒŒë“œë°•ìŠ¤ëŠ” ì‚¬ìš©ì ì†Œìœ , 700 ê¶Œí•œ
- **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬**: í•„ìš” ì‹œ `--net` ì˜µì…˜ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ì œí•œ
- **ë£¨íŠ¸ ê¶Œí•œ ì—†ìŒ**: `--fakeroot` ì—†ì´ ì‹¤í–‰ (ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œ)

#### VNC ë³´ì•ˆ
- **ë¹„ë°€ë²ˆí˜¸**: ì„¸ì…˜ë³„ ëœë¤ ìƒì„±
- **ë¡œì»¬ ì ‘ì†ë§Œ**: VNCëŠ” localhostì—ë§Œ ë°”ì¸ë“œ
- **WebSocket í”„ë¡ì‹œ**: ì™¸ë¶€ ì ‘ì†ì€ í”„ë¡ì‹œë¥¼ í†µí•´ì„œë§Œ

### 10.2 ì„±ëŠ¥ ìµœì í™”

#### ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš© ì „ëµ
```python
def get_or_create_sandbox(user_id, session_id, reuse=True):
    """ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš© ì „ëµ"""
    sandbox_path = f"/scratch/apptainer_sandboxes/{user_id}_{session_id}"
    
    if reuse:
        # ê¸°ì¡´ ìƒŒë“œë°•ìŠ¤ ê²€ìƒ‰ (ì‚¬ìš©ìë³„ë¡œ 1ê°œë§Œ ìœ ì§€)
        user_sandboxes = glob(f"/scratch/apptainer_sandboxes/{user_id}_*")
        if user_sandboxes:
            # ê°€ì¥ ìµœê·¼ ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš©
            latest_sandbox = max(user_sandboxes, key=os.path.getmtime)
            return latest_sandbox
    
    # ìƒˆ ìƒŒë“œë°•ìŠ¤ ìƒì„±
    create_sandbox(sandbox_path)
    return sandbox_path
```

#### ìƒŒë“œë°•ìŠ¤ ìƒì„± ì‹œê°„ ë‹¨ì¶•
- **Overlay ì‚¬ìš©**: `--overlay` ì˜µì…˜ìœ¼ë¡œ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ê³µìœ 
- **ë³‘ë ¬ ìƒì„±**: ì—¬ëŸ¬ ì„¸ì…˜ ë™ì‹œ ìƒì„± ì‹œ ë¹„ë™ê¸° ì²˜ë¦¬
- **ìºì‹œ í™œìš©**: Apptainer ìºì‹œ ë””ë ‰í† ë¦¬ ì„¤ì •

---

## 11. í…ŒìŠ¤íŠ¸ ê³„íš

### 11.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

#### Apptainer í†µí•© í…ŒìŠ¤íŠ¸
```python
# tests/test_apptainer_sandbox.py
def test_create_sandbox():
    manager = ApptainerSandboxManager()
    sandbox_path = manager.create_sandbox("testuser", "test123")
    assert os.path.exists(sandbox_path)
    assert os.path.isdir(sandbox_path)

def test_vnc_in_sandbox():
    # ìƒŒë“œë°•ìŠ¤ì—ì„œ VNC ì„œë²„ ì‹œì‘
    cmd = ["apptainer", "exec", "--nv", "--writable", sandbox_path,
           "/opt/TurboVNC/bin/vncserver", ":1"]
    result = subprocess.run(cmd, capture_output=True)
    assert result.returncode == 0
```

### 11.2 í†µí•© í…ŒìŠ¤íŠ¸

#### E2E í”Œë¡œìš° í…ŒìŠ¤íŠ¸
```python
@pytest.mark.asyncio
async def test_full_session_lifecycle():
    # 1. ì„¸ì…˜ ìƒì„±
    response = await create_session_api(
        user_id="testuser",
        node_id="node001"
    )
    session_id = response['session']['session_id']
    
    # 2. Job ìƒíƒœ í™•ì¸ (RUNNINGê¹Œì§€ ëŒ€ê¸°)
    await wait_for_job_running(session_id, timeout=60)
    
    # 3. ìƒŒë“œë°•ìŠ¤ ìƒíƒœ í™•ì¸
    sandbox_status = await get_sandbox_status(session_id)
    assert sandbox_status['vnc_running'] == True
    assert sandbox_status['gpu_available'] == True
    
    # 4. WebSocket ì—°ê²°
    async with websockets.connect(f"ws://localhost:6001/ws/{session_id}") as ws:
        # VNC í•¸ë“œì…°ì´í¬
        await ws.send(b'RFB 003.008\n')
        response = await ws.recv()
        assert b'RFB' in response
    
    # 5. ì„¸ì…˜ ì¢…ë£Œ
    await terminate_session(session_id)
    
    # 6. ì •ë¦¬ í™•ì¸
    await asyncio.sleep(5)
    assert not os.path.exists(f"/scratch/vnc_pids/{session_id}.pid")
```

---

## 12. êµ¬í˜„ ë¡œë“œë§µ

| ì£¼ì°¨ | ì‘ì—… ë‚´ìš© | ì£¼ìš” ì‚°ì¶œë¬¼ | ê²€ì¦ |
|------|-----------|-------------|------|
| **Week 1** | Apptainer ì´ë¯¸ì§€ êµ¬ì¶• | ubuntu_vnc_gpu.sif, ìƒŒë“œë°•ìŠ¤ í…ŒìŠ¤íŠ¸ | GPU ì ‘ê·¼, VNC ì‹œì‘ í™•ì¸ |
| **Week 2-3** | Slurm í†µí•© ë°±ì—”ë“œ | slurm_apptainer.py, Job í…œí”Œë¦¿, REST API | APIë¡œ ìƒŒë“œë°•ìŠ¤ ìƒì„± ê°€ëŠ¥ |
| **Week 4** | WebSocket + í”„ë¡ íŠ¸ì—”ë“œ | websocket_proxy.py, React ì»´í¬ë„ŒíŠ¸ | ë¸Œë¼ìš°ì €ì—ì„œ ë°ìŠ¤í¬í†± í‘œì‹œ |
| **Week 5** | ìµœì í™” + í…ŒìŠ¤íŠ¸ | ì„±ëŠ¥ íŠœë‹, E2E í…ŒìŠ¤íŠ¸, ë¬¸ì„œ | 24ì‹œê°„ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸ |

---

## 13. ê¸°ì¡´ Dashboard ì¸í”„ë¼ì™€ì˜ í†µí•© â­ (ì‹ ê·œ ì¶”ê°€)

### 13.1 í˜„ì¬ Dashboard êµ¬ì¡° ë¶„ì„

```
dashboard/
â”œâ”€â”€ backend_5010/           # ë©”ì¸ ë°±ì—”ë“œ API (Flask)
â”‚   â”œâ”€â”€ app.py             # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚   â”œâ”€â”€ database/          # SQLite DB
â”‚   â”œâ”€â”€ slurm_commands.py  # Slurm ëª…ë ¹ ë˜í¼
â”‚   â””â”€â”€ websocket_server.py
â”œâ”€â”€ frontend_3010/          # React í”„ë¡ íŠ¸ì—”ë“œ
â”‚   â””â”€â”€ src/components/    # ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ë“¤
â”œâ”€â”€ websocket_5011/         # WebSocket ì„œë²„
â”‚   â””â”€â”€ database/          # ì„¸ì…˜ DB
â”œâ”€â”€ prometheus_9090/        # ë©”íŠ¸ë¦­ ìˆ˜ì§‘
â””â”€â”€ node_exporter_9100/     # ë…¸ë“œ ë©”íŠ¸ë¦­
```

### 13.2 í†µí•© ì „ëµ

#### ì˜µì…˜ A: backend_5010 í™•ì¥ ë°©ì‹ (ê¶Œì¥ â­)

**ì¥ì **:
- ë‹¨ì¼ ë°±ì—”ë“œë¡œ ê´€ë¦¬ ê°„ì†Œí™”
- ê¸°ì¡´ ì¸ì¦/ì„¸ì…˜ ì‹œìŠ¤í…œ ì¬ì‚¬ìš©
- í”„ë¡ íŠ¸ì—”ë“œ í†µí•© ìš©ì´

**êµ¬í˜„ ë°©ë²•**:
```python
# backend_5010/app.pyì— ìƒˆ Blueprint ì¶”ê°€
from visualization_api import visualization_bp

app.register_blueprint(visualization_bp, url_prefix='/api/visualization')
```

**í´ë” êµ¬ì¡°**:
```
backend_5010/
â”œâ”€â”€ app.py                          # ê¸°ì¡´ ë©”ì¸ ì•±
â”œâ”€â”€ visualization/                  # ìƒˆë¡œìš´ ëª¨ë“ˆ â­
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ session_manager.py          # VNC ì„¸ì…˜ ê´€ë¦¬
â”‚   â”œâ”€â”€ apptainer_manager.py        # Apptainer í†µí•© â­
â”‚   â”œâ”€â”€ vnc_proxy.py                # VNC WebSocket í”„ë¡ì‹œ
â”‚   â””â”€â”€ job_templates/              # Slurm Job í…œí”Œë¦¿
â”‚       â”œâ”€â”€ vnc_session.sh.j2
â”‚       â””â”€â”€ cleanup_sandbox.sh.j2
â”œâ”€â”€ database/
â”‚   â””â”€â”€ sessions.db                 # VNC ì„¸ì…˜ í…Œì´ë¸” ì¶”ê°€
â””â”€â”€ static/apptainer_images/        # Apptainer Definition íŒŒì¼
```

#### ì˜µì…˜ B: ë…ë¦½ ì„œë¹„ìŠ¤ ë°©ì‹ (visualization_6000)

**ì¥ì **:
- ì„œë¹„ìŠ¤ ê²©ë¦¬ë¡œ ì•ˆì •ì„± í–¥ìƒ
- ë…ë¦½ì ì¸ ìŠ¤ì¼€ì¼ë§ ê°€ëŠ¥

**ë‹¨ì **:
- ì¸ì¦ ì‹œìŠ¤í…œ ì¤‘ë³µ
- ê´€ë¦¬ ë³µì¡ë„ ì¦ê°€

### 13.3 Database í†µí•©

#### VNC ì„¸ì…˜ í…Œì´ë¸” ì¶”ê°€
```sql
-- backend_5010/database/sessions.db
CREATE TABLE IF NOT EXISTS vnc_sessions (
    session_id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    node_id TEXT NOT NULL,
    slurm_job_id TEXT,
    sandbox_path TEXT,
    display_num INTEGER,
    vnc_port INTEGER,
    websocket_port INTEGER,
    status TEXT,  -- 'creating', 'starting', 'running', 'stopped', 'error'
    resolution TEXT,
    quality TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    stopped_at TIMESTAMP,
    error_message TEXT,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE INDEX idx_vnc_user_status ON vnc_sessions(user_id, status);
CREATE INDEX idx_vnc_job_id ON vnc_sessions(slurm_job_id);
```

#### ì„¸ì…˜ ë¦¬ì†ŒìŠ¤ ì¿¼í„° í…Œì´ë¸”
```sql
CREATE TABLE IF NOT EXISTS vnc_quotas (
    user_id TEXT PRIMARY KEY,
    max_concurrent_sessions INTEGER DEFAULT 2,
    max_session_duration_hours INTEGER DEFAULT 8,
    allowed_nodes TEXT,  -- JSON array: ["node001", "node002"]
    gpu_allowed BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 13.4 WebSocket í†µí•©

#### WebSocket ë¼ìš°íŒ… í™•ì¥
```python
# websocket_5011/websocket_server.py í™•ì¥

import asyncio
import websockets
from vnc_proxy import VNCProxyHandler

class WebSocketRouter:
    def __init__(self):
        self.routes = {
            '/ws/slurm': self.handle_slurm_ws,
            '/ws/vnc/{session_id}': self.handle_vnc_ws,  # â­ ì‹ ê·œ
        }

    async def handle_vnc_ws(self, websocket, session_id):
        """VNC WebSocket í”„ë¡ì‹œ"""
        proxy = VNCProxyHandler(session_id)
        await proxy.start(websocket)

# backend_5010/visualization/vnc_proxy.py
class VNCProxyHandler:
    """WebSocket â†” TCP VNC í”„ë¡ì‹œ"""

    def __init__(self, session_id):
        self.session_id = session_id
        self.vnc_socket = None

    async def start(self, websocket):
        # 1. ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
        session = get_session_from_db(self.session_id)
        vnc_host = session['node_id']
        vnc_port = session['vnc_port']

        # 2. VNC ì„œë²„ TCP ì—°ê²°
        reader, writer = await asyncio.open_connection(vnc_host, vnc_port)

        # 3. ì–‘ë°©í–¥ í”„ë¡ì‹œ
        await asyncio.gather(
            self.ws_to_tcp(websocket, writer),
            self.tcp_to_ws(reader, websocket)
        )
```

---

## 14. ë³´ì•ˆ ë° ì¸ì¦ ì‹œìŠ¤í…œ â­ (ì‹ ê·œ ì¶”ê°€)

### 14.1 ì‚¬ìš©ì ì¸ì¦ í”Œë¡œìš°

```
1. User Login (frontend_3010)
   â†“
2. JWT Token ë°œê¸‰ (backend_5010/auth)
   â†“
3. VNC ì„¸ì…˜ ìƒì„± ìš”ì²­ + JWT Token
   â†“
4. Token ê²€ì¦ â†’ User ID ì¶”ì¶œ
   â†“
5. ì‚¬ìš©ìë³„ ì¿¼í„° í™•ì¸
   â†“
6. Slurm Job ì œì¶œ (ì‚¬ìš©ì ê¶Œí•œìœ¼ë¡œ)
   â†“
7. VNC ì ‘ì† URL ë°˜í™˜ (ì„¸ì…˜ë³„ í† í° í¬í•¨)
```

### 14.2 VNC ì„¸ì…˜ ë³´ì•ˆ

#### ì„¸ì…˜ë³„ ì¼íšŒìš© í† í°
```python
import secrets
import hashlib
import time

class VNCSessionAuth:
    """VNC ì„¸ì…˜ ì¸ì¦"""

    @staticmethod
    def generate_session_token(session_id, user_id):
        """ì„¸ì…˜ë³„ ì¼íšŒìš© í† í° ìƒì„±"""
        secret = secrets.token_urlsafe(32)
        timestamp = int(time.time())

        # í† í° = SHA256(session_id + user_id + secret + timestamp)
        token_data = f"{session_id}:{user_id}:{secret}:{timestamp}"
        token = hashlib.sha256(token_data.encode()).hexdigest()

        # DBì— ì €ì¥ (TTL: 1ì‹œê°„)
        save_session_token(session_id, token, expires_in=3600)

        return token

    @staticmethod
    def validate_session_token(session_id, token):
        """í† í° ê²€ì¦"""
        stored_token = get_session_token(session_id)

        if not stored_token:
            return False

        if stored_token['token'] != token:
            return False

        if time.time() > stored_token['expires_at']:
            return False

        return True
```

#### VNC ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬
```python
class VNCPasswordManager:
    """VNC ë¹„ë°€ë²ˆí˜¸ ìƒì„± ë° ê´€ë¦¬"""

    @staticmethod
    def generate_vnc_password(length=8):
        """ê°•ë ¥í•œ VNC ë¹„ë°€ë²ˆí˜¸ ìƒì„±"""
        import string
        alphabet = string.ascii_letters + string.digits + "!@#$%^&*"
        password = ''.join(secrets.choice(alphabet) for _ in range(length))
        return password

    @staticmethod
    def store_encrypted_password(session_id, password):
        """ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì €ì¥"""
        from cryptography.fernet import Fernet

        key = get_encryption_key()  # í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œ
        fernet = Fernet(key)
        encrypted = fernet.encrypt(password.encode())

        save_to_db(session_id, encrypted)
```

### 14.3 ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ

#### VNC í¬íŠ¸ ë°©í™”ë²½ ê·œì¹™
```bash
# ê³„ì‚° ë…¸ë“œì—ì„œ VNC í¬íŠ¸ëŠ” localhostì—ë§Œ ë°”ì¸ë“œ
# WebSocket í”„ë¡ì‹œë§Œ ì™¸ë¶€ ì ‘ì† í—ˆìš©

# node001: VNC ì„œë²„ (localhost:5901)
vncserver :1 -localhost yes

# head01: WebSocket í”„ë¡ì‹œ (0.0.0.0:6001)
# í”„ë¡ì‹œë§Œ ì™¸ë¶€ ì ‘ì† ê°€ëŠ¥, VNC ì§ì ‘ ì ‘ì† ì°¨ë‹¨
```

#### SSH í„°ë„ ë°©ì‹ (ì¶”ê°€ ë³´ì•ˆ)
```python
def create_ssh_tunnel(session_id, node_id, vnc_port):
    """SSH í„°ë„ì„ í†µí•œ VNC ì ‘ì†"""
    import paramiko

    ssh = paramiko.SSHClient()
    ssh.connect(node_id, username='slurm')

    # ë¡œì»¬ í¬íŠ¸ í¬ì›Œë”©: localhost:local_port â†’ node:vnc_port
    local_port = allocate_local_port()

    transport = ssh.get_transport()
    tunnel = transport.open_channel(
        'direct-tcpip',
        (node_id, vnc_port),
        ('localhost', local_port)
    )

    return tunnel, local_port
```

---

## 15. ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤ â­ (ì‹ ê·œ ì¶”ê°€)

### 15.1 ì—ëŸ¬ ë¶„ë¥˜ ë° ì²˜ë¦¬

| ì—ëŸ¬ ìœ í˜• | ì›ì¸ | ë³µêµ¬ ì „ëµ |
|----------|------|----------|
| **ìƒŒë“œë°•ìŠ¤ ìƒì„± ì‹¤íŒ¨** | ë””ìŠ¤í¬ ë¶€ì¡±, ê¶Œí•œ ë¬¸ì œ | ìë™ ì¬ì‹œë„ (3íšŒ), ë‹¤ë¥¸ ë…¸ë“œë¡œ ì¬í• ë‹¹ |
| **VNC ì„œë²„ ì‹œì‘ ì‹¤íŒ¨** | í¬íŠ¸ ì¶©ëŒ, X11 ì˜¤ë¥˜ | Display ë²ˆí˜¸ ìë™ ë³€ê²½, ì¬ì‹œì‘ |
| **Slurm Job ì‹¤íŒ¨** | ë¦¬ì†ŒìŠ¤ ë¶€ì¡±, ë…¸ë“œ ë‹¤ìš´ | íì—ì„œ ëŒ€ê¸°, ë‹¤ë¥¸ ë…¸ë“œë¡œ ì¬ìŠ¤ì¼€ì¤„ë§ |
| **WebSocket ì—°ê²° ëŠê¹€** | ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ | ìë™ ì¬ì—°ê²° (í´ë¼ì´ì–¸íŠ¸), ì„¸ì…˜ ìœ ì§€ |
| **GPU ì ‘ê·¼ ì‹¤íŒ¨** | ë“œë¼ì´ë²„ ì˜¤ë¥˜, ë‹¤ë¥¸ Job ì‚¬ìš© ì¤‘ | Job ì¬ì‹œì‘, ë‹¤ë¥¸ GPUë¡œ ì¬í• ë‹¹ |

### 15.2 ìë™ ë³µêµ¬ ë¡œì§

```python
class VNCSessionRecovery:
    """VNC ì„¸ì…˜ ìë™ ë³µêµ¬"""

    async def monitor_sessions(self):
        """ì„¸ì…˜ í—¬ìŠ¤ì²´í¬ ë° ìë™ ë³µêµ¬"""
        while True:
            sessions = get_active_sessions()

            for session in sessions:
                health = await self.check_session_health(session)

                if health['status'] == 'unhealthy':
                    await self.recover_session(session, health['error'])

            await asyncio.sleep(30)  # 30ì´ˆë§ˆë‹¤ ì²´í¬

    async def check_session_health(self, session):
        """ì„¸ì…˜ ìƒíƒœ í™•ì¸"""
        checks = {
            'slurm_job': self.check_slurm_job(session['slurm_job_id']),
            'vnc_process': self.check_vnc_process(session),
            'sandbox': self.check_sandbox_exists(session['sandbox_path']),
            'network': self.check_vnc_connection(session)
        }

        for check_name, result in checks.items():
            if not result['ok']:
                return {
                    'status': 'unhealthy',
                    'error': check_name,
                    'details': result
                }

        return {'status': 'healthy'}

    async def recover_session(self, session, error_type):
        """ì„¸ì…˜ ë³µêµ¬"""
        recovery_strategies = {
            'slurm_job': self.recover_slurm_job,
            'vnc_process': self.recover_vnc_process,
            'sandbox': self.recover_sandbox,
            'network': self.recover_network
        }

        strategy = recovery_strategies.get(error_type)
        if strategy:
            try:
                await strategy(session)
                log_recovery_success(session['session_id'], error_type)
            except Exception as e:
                log_recovery_failure(session['session_id'], error_type, str(e))
                # 3íšŒ ì‹¤íŒ¨ ì‹œ ì„¸ì…˜ ì¢…ë£Œ
                if session['recovery_attempts'] >= 3:
                    await self.terminate_session(session['session_id'])
```

### 15.3 ì—ëŸ¬ ì•Œë¦¼ ì‹œìŠ¤í…œ

```python
class VNCAlertManager:
    """VNC ì„¸ì…˜ ì•Œë¦¼ ê´€ë¦¬"""

    def send_session_alert(self, session_id, alert_type, message):
        """ì‚¬ìš©ìì—ê²Œ ì„¸ì…˜ ì•Œë¦¼ ì „ì†¡"""
        session = get_session(session_id)
        user_id = session['user_id']

        # 1. WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼
        websocket_notify(user_id, {
            'type': 'vnc_session_alert',
            'session_id': session_id,
            'alert_type': alert_type,
            'message': message,
            'timestamp': datetime.now().isoformat()
        })

        # 2. DBì— ì•Œë¦¼ ê¸°ë¡
        save_notification(user_id, 'vnc_session', message)

        # 3. ì‹¬ê°í•œ ì˜¤ë¥˜ëŠ” ì´ë©”ì¼ ë°œì†¡
        if alert_type == 'critical':
            send_email(get_user_email(user_id), message)
```

---

## 16. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… â­ (ì‹ ê·œ ì¶”ê°€)

### 16.1 Prometheus ë©”íŠ¸ë¦­ ì¶”ê°€

```python
# backend_5010/visualization/metrics.py
from prometheus_client import Counter, Gauge, Histogram

# VNC ì„¸ì…˜ ë©”íŠ¸ë¦­
vnc_sessions_total = Counter(
    'vnc_sessions_total',
    'Total VNC sessions created',
    ['user_id', 'node_id']
)

vnc_sessions_active = Gauge(
    'vnc_sessions_active',
    'Number of active VNC sessions',
    ['node_id']
)

vnc_session_duration = Histogram(
    'vnc_session_duration_seconds',
    'VNC session duration',
    ['user_id'],
    buckets=[300, 1800, 3600, 7200, 28800]  # 5m, 30m, 1h, 2h, 8h
)

# ìƒŒë“œë°•ìŠ¤ ë©”íŠ¸ë¦­
apptainer_sandbox_build_time = Histogram(
    'apptainer_sandbox_build_seconds',
    'Apptainer sandbox build time',
    ['node_id'],
    buckets=[5, 10, 20, 30, 60, 120]
)

# VNC ì„œë²„ ë©”íŠ¸ë¦­
vnc_server_start_failures = Counter(
    'vnc_server_start_failures_total',
    'VNC server start failures',
    ['node_id', 'error_type']
)
```

### 16.2 Grafana ëŒ€ì‹œë³´ë“œ ì¶”ê°€

```json
// prometheus_9090/grafana_vnc_dashboard.json
{
  "dashboard": {
    "title": "VNC Visualization Sessions",
    "panels": [
      {
        "title": "Active VNC Sessions",
        "targets": [{
          "expr": "sum(vnc_sessions_active) by (node_id)"
        }]
      },
      {
        "title": "Session Creation Rate",
        "targets": [{
          "expr": "rate(vnc_sessions_total[5m])"
        }]
      },
      {
        "title": "Sandbox Build Time",
        "targets": [{
          "expr": "histogram_quantile(0.95, apptainer_sandbox_build_seconds)"
        }]
      }
    ]
  }
}
```

### 16.3 ìƒì„¸ ë¡œê¹…

```python
# backend_5010/visualization/logging_config.py
import logging
from logging.handlers import RotatingFileHandler

def setup_vnc_logging():
    """VNC ì„¸ì…˜ ì „ìš© ë¡œê¹… ì„¤ì •"""

    # ì„¸ì…˜ ìƒì„±/ì¢…ë£Œ ë¡œê·¸
    session_logger = logging.getLogger('vnc.session')
    session_handler = RotatingFileHandler(
        '/var/log/dashboard/vnc_sessions.log',
        maxBytes=100*1024*1024,  # 100MB
        backupCount=10
    )
    session_logger.addHandler(session_handler)

    # Apptainer ê´€ë ¨ ë¡œê·¸
    apptainer_logger = logging.getLogger('vnc.apptainer')
    apptainer_handler = RotatingFileHandler(
        '/var/log/dashboard/apptainer.log',
        maxBytes=50*1024*1024,
        backupCount=5
    )
    apptainer_logger.addHandler(apptainer_handler)

    # ì—ëŸ¬ ì „ìš© ë¡œê·¸
    error_logger = logging.getLogger('vnc.errors')
    error_handler = RotatingFileHandler(
        '/var/log/dashboard/vnc_errors.log',
        maxBytes=50*1024*1024,
        backupCount=5
    )
    error_logger.addHandler(error_handler)

# ì‚¬ìš© ì˜ˆì‹œ
session_logger.info(f"Session created: {session_id}, user={user_id}, node={node_id}")
apptainer_logger.info(f"Sandbox built: {sandbox_path}, duration={duration}s")
error_logger.error(f"VNC start failed: {session_id}, error={error_msg}")
```

---

## 17. ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ ë° ì¿¼í„° ì •ì±… â­ (ì‹ ê·œ ì¶”ê°€)

### 17.1 ì‚¬ìš©ìë³„ ë¦¬ì†ŒìŠ¤ ì œí•œ

```python
class VNCResourceManager:
    """VNC ì„¸ì…˜ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬"""

    def check_user_quota(self, user_id):
        """ì‚¬ìš©ì ì¿¼í„° í™•ì¸"""
        quota = get_user_quota(user_id)
        current_sessions = count_active_sessions(user_id)

        if current_sessions >= quota['max_concurrent_sessions']:
            raise QuotaExceededException(
                f"User {user_id} has reached max sessions limit: {quota['max_concurrent_sessions']}"
            )

        return True

    def allocate_resources(self, user_id, session_request):
        """ë¦¬ì†ŒìŠ¤ í• ë‹¹"""
        # 1. GPU ê°€ìš©ì„± í™•ì¸
        if session_request['gpu_required']:
            available_nodes = get_nodes_with_available_gpu()
            if not available_nodes:
                raise ResourceUnavailableException("No GPU available")

        # 2. Display ë²ˆí˜¸ í• ë‹¹
        node_id = session_request['node_id']
        display_num = self.allocate_display_number(node_id)

        # 3. í¬íŠ¸ í• ë‹¹
        vnc_port = 5900 + display_num
        websocket_port = 6000 + display_num

        return {
            'display_num': display_num,
            'vnc_port': vnc_port,
            'websocket_port': websocket_port
        }

    def allocate_display_number(self, node_id):
        """ë…¸ë“œë³„ Display ë²ˆí˜¸ í• ë‹¹"""
        # ë…¸ë“œë³„ ì‚¬ìš© ì¤‘ì¸ Display ë²ˆí˜¸ ì¡°íšŒ
        used_displays = get_used_display_numbers(node_id)

        # 1-99 ë²”ìœ„ì—ì„œ ë¯¸ì‚¬ìš© ë²ˆí˜¸ ì°¾ê¸°
        for display_num in range(1, 100):
            if display_num not in used_displays:
                return display_num

        raise ResourceUnavailableException("No available display number")
```

### 17.2 ë””ìŠ¤í¬ ê³µê°„ ê´€ë¦¬

```python
class SandboxDiskManager:
    """ìƒŒë“œë°•ìŠ¤ ë””ìŠ¤í¬ ê´€ë¦¬"""

    def cleanup_old_sandboxes(self, threshold_days=7):
        """ì˜¤ë˜ëœ ìƒŒë“œë°•ìŠ¤ ìë™ ì •ë¦¬"""
        import os
        import shutil
        from datetime import datetime, timedelta

        sandbox_base = "/scratch/apptainer_sandboxes"
        threshold_date = datetime.now() - timedelta(days=threshold_days)

        for sandbox_dir in os.listdir(sandbox_base):
            sandbox_path = os.path.join(sandbox_base, sandbox_dir)

            # ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°„ í™•ì¸
            last_access = datetime.fromtimestamp(os.path.getatime(sandbox_path))

            if last_access < threshold_date:
                # í™œì„± ì„¸ì…˜ì¸ì§€ í™•ì¸
                if not is_active_sandbox(sandbox_path):
                    print(f"Removing old sandbox: {sandbox_path}")
                    shutil.rmtree(sandbox_path)

    def enforce_disk_quota(self, user_id, max_size_gb=50):
        """ì‚¬ìš©ìë³„ ìƒŒë“œë°•ìŠ¤ ë””ìŠ¤í¬ ì¿¼í„°"""
        user_sandboxes = get_user_sandboxes(user_id)
        total_size = sum(get_dir_size(s) for s in user_sandboxes)

        if total_size > max_size_gb * 1024**3:
            # ê°€ì¥ ì˜¤ë˜ëœ ìƒŒë“œë°•ìŠ¤ ì‚­ì œ
            oldest_sandbox = min(user_sandboxes, key=os.path.getatime)
            remove_sandbox(oldest_sandbox)
```

### 17.3 GPU í• ë‹¹ ì •ì±…

```python
class GPUAllocationPolicy:
    """GPU í• ë‹¹ ì •ì±…"""

    def select_gpu_node(self, user_id, gpu_type=None):
        """ìµœì ì˜ GPU ë…¸ë“œ ì„ íƒ"""
        available_nodes = get_nodes_with_gpu(gpu_type)

        # 1. ì‚¬ìš©ë¥ ì´ ê°€ì¥ ë‚®ì€ ë…¸ë“œ ì„ íƒ
        node_loads = {
            node: get_gpu_utilization(node)
            for node in available_nodes
        }

        # 2. Fair-share: ì‚¬ìš©ìê°€ ìµœê·¼ì— ì‚¬ìš©í•œ ë…¸ë“œ ì œì™¸
        recent_nodes = get_recent_used_nodes(user_id, hours=24)
        for node in recent_nodes:
            if node in node_loads:
                node_loads[node] += 50  # íŒ¨ë„í‹° ë¶€ì—¬

        # 3. ê°€ì¥ ë‚®ì€ ë¶€í•˜ì˜ ë…¸ë“œ ë°˜í™˜
        selected_node = min(node_loads, key=node_loads.get)
        return selected_node
```

---

## 18. ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ì‘ì—… (ì—…ë°ì´íŠ¸)

### Step 1: Backend í™•ì¥ ì¤€ë¹„
```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010

# Visualization ëª¨ë“ˆ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p visualization/job_templates
mkdir -p static/apptainer_images

# Python ê°€ìƒí™˜ê²½ í™œì„±í™”
source venv/bin/activate

# ì¶”ê°€ ì˜ì¡´ì„± ì„¤ì¹˜
pip install jinja2 cryptography paramiko
```

### Step 2: Apptainer Definition íŒŒì¼ ì‘ì„±
```bash
cd static/apptainer_images

# ubuntu_vnc_gpu.def ì‘ì„±
cat > ubuntu_vnc_gpu.def << 'EOF'
Bootstrap: docker
From: ubuntu:22.04
# ... (Section 6.1ì˜ ë‚´ìš©)
EOF
```

### Step 3: Database ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸
```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010

# SQLiteì— VNC í…Œì´ë¸” ì¶”ê°€
sqlite3 database/sessions.db << 'EOF'
-- Section 13.3ì˜ SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
EOF
```

### Step 4: Slurm Job í…œí”Œë¦¿ ì‘ì„±
```bash
cd visualization/job_templates

# vnc_session.sh.j2 ì‘ì„±
cat > vnc_session.sh.j2 << 'EOF'
# Section 7.1ì˜ í…œí”Œë¦¿ ë‚´ìš©
EOF
```

---

## 19. Frontend React ì»´í¬ë„ŒíŠ¸ í†µí•© ìƒì„¸ â­ (ì‹ ê·œ ì¶”ê°€)

### 19.1 ê¸°ì¡´ Frontend êµ¬ì¡° í™œìš©

```typescript
// frontend_3010/src/App.tsxì— ìƒˆ ë¼ìš°íŠ¸ ì¶”ê°€
import Visualization from './components/Visualization';

function App() {
  return (
    <Routes>
      {/* ê¸°ì¡´ ë¼ìš°íŠ¸ë“¤ */}
      <Route path="/jobs" element={<Jobs />} />
      <Route path="/nodes" element={<Nodes />} />

      {/* ìƒˆë¡œìš´ Visualization ë¼ìš°íŠ¸ â­ */}
      <Route path="/visualization" element={<Visualization />} />
    </Routes>
  );
}
```

### 19.2 Visualization ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```
frontend_3010/src/components/Visualization/
â”œâ”€â”€ index.tsx                    # ë©”ì¸ Visualization í˜ì´ì§€
â”œâ”€â”€ SessionManager.tsx           # ì„¸ì…˜ ìƒì„±/ê´€ë¦¬ UI
â”œâ”€â”€ VNCViewer.tsx                # noVNC í†µí•©
â”œâ”€â”€ NodeSelector.tsx             # GPU ë…¸ë“œ ì„ íƒ
â”œâ”€â”€ ApptainerStatus.tsx          # ìƒŒë“œë°•ìŠ¤ ìƒíƒœ (ê¸°ì¡´)
â”œâ”€â”€ SessionList.tsx              # ì‚¬ìš©ì ì„¸ì…˜ ëª©ë¡
â”œâ”€â”€ SessionControls.tsx          # ì„¸ì…˜ ì œì–´ (ì¤‘ì§€, ì¬ì‹œì‘)
â””â”€â”€ hooks/
    â”œâ”€â”€ useVNCSession.ts         # ì„¸ì…˜ ê´€ë¦¬ í›…
    â”œâ”€â”€ useWebSocket.ts          # WebSocket ì—°ê²° í›…
    â””â”€â”€ useNoVNC.ts              # noVNC ì´ˆê¸°í™” í›…
```

### 19.3 SessionManager êµ¬í˜„ ì˜ˆì‹œ

```typescript
// frontend_3010/src/components/Visualization/SessionManager.tsx
import React, { useState } from 'react';
import { Monitor, Cpu, HardDrive } from 'lucide-react';
import { useVNCSession } from './hooks/useVNCSession';
import NodeSelector from './NodeSelector';

const SessionManager: React.FC = () => {
  const { createSession, sessions, loading } = useVNCSession();
  const [selectedNode, setSelectedNode] = useState<string>('');
  const [resolution, setResolution] = useState('1920x1080');

  const handleCreateSession = async () => {
    if (!selectedNode) {
      alert('Please select a GPU node');
      return;
    }

    try {
      const session = await createSession({
        node_id: selectedNode,
        resolution: resolution,
        quality: 'high',
        gpu_required: true
      });

      console.log('Session created:', session);
    } catch (error) {
      console.error('Failed to create session:', error);
    }
  };

  return (
    <div className="p-6 bg-white dark:bg-gray-800 rounded-lg shadow">
      <h2 className="text-2xl font-bold mb-4 flex items-center">
        <Monitor className="mr-2" />
        Remote Desktop Visualization
      </h2>

      <div className="space-y-4">
        {/* ë…¸ë“œ ì„ íƒ */}
        <NodeSelector
          onSelect={setSelectedNode}
          selectedNode={selectedNode}
        />

        {/* í•´ìƒë„ ì„ íƒ */}
        <div>
          <label className="block text-sm font-medium mb-2">
            Resolution
          </label>
          <select
            value={resolution}
            onChange={(e) => setResolution(e.target.value)}
            className="w-full p-2 border rounded"
          >
            <option value="1920x1080">1920x1080 (Full HD)</option>
            <option value="2560x1440">2560x1440 (2K)</option>
            <option value="3840x2160">3840x2160 (4K)</option>
          </select>
        </div>

        {/* ì„¸ì…˜ ìƒì„± ë²„íŠ¼ */}
        <button
          onClick={handleCreateSession}
          disabled={loading || !selectedNode}
          className="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700 disabled:bg-gray-400"
        >
          {loading ? 'Creating Session...' : 'Launch Desktop'}
        </button>
      </div>

      {/* í™œì„± ì„¸ì…˜ ëª©ë¡ */}
      <SessionList sessions={sessions} />
    </div>
  );
};
```

### 19.4 VNCViewer ì»´í¬ë„ŒíŠ¸ (noVNC í†µí•©)

```typescript
// frontend_3010/src/components/Visualization/VNCViewer.tsx
import React, { useEffect, useRef } from 'react';
import RFB from '@novnc/novnc/core/rfb';
import { useNoVNC } from './hooks/useNoVNC';

interface VNCViewerProps {
  sessionId: string;
  websocketUrl: string;
  onDisconnect?: () => void;
}

const VNCViewer: React.FC<VNCViewerProps> = ({
  sessionId,
  websocketUrl,
  onDisconnect
}) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const { rfb, connect, disconnect, connected } = useNoVNC();

  useEffect(() => {
    if (containerRef.current && websocketUrl) {
      connect(containerRef.current, websocketUrl);
    }

    return () => {
      disconnect();
    };
  }, [websocketUrl]);

  return (
    <div className="vnc-viewer-container">
      <div className="vnc-toolbar bg-gray-800 text-white p-2 flex justify-between">
        <span>Session: {sessionId}</span>
        <span>{connected ? 'ğŸŸ¢ Connected' : 'ğŸ”´ Disconnected'}</span>
      </div>

      <div
        ref={containerRef}
        className="vnc-screen bg-black"
        style={{ width: '100%', height: 'calc(100vh - 200px)' }}
      />
    </div>
  );
};

export default VNCViewer;
```

### 19.5 Custom Hooks

```typescript
// frontend_3010/src/components/Visualization/hooks/useVNCSession.ts
import { useState, useEffect } from 'react';

interface VNCSession {
  session_id: string;
  node_id: string;
  status: string;
  websocket_url: string;
  created_at: string;
}

export const useVNCSession = () => {
  const [sessions, setSessions] = useState<VNCSession[]>([]);
  const [loading, setLoading] = useState(false);

  const fetchSessions = async () => {
    const response = await fetch('/api/visualization/sessions');
    const data = await response.json();
    setSessions(data.sessions);
  };

  const createSession = async (options: any) => {
    setLoading(true);
    try {
      const response = await fetch('/api/visualization/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(options)
      });
      const data = await response.json();

      await fetchSessions();
      return data.session;
    } finally {
      setLoading(false);
    }
  };

  const terminateSession = async (sessionId: string) => {
    await fetch(`/api/visualization/sessions/${sessionId}`, {
      method: 'DELETE'
    });
    await fetchSessions();
  };

  useEffect(() => {
    fetchSessions();
    const interval = setInterval(fetchSessions, 5000);
    return () => clearInterval(interval);
  }, []);

  return { sessions, createSession, terminateSession, loading };
};
```

---

## 20. ìš´ì˜ ë° ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ â­ (ì‹ ê·œ ì¶”ê°€)

### 20.1 ì¼ì¼ ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
#!/bin/bash
# dashboard/backend_5010/visualization/daily_check.sh

# 1. í™œì„± VNC ì„¸ì…˜ í™•ì¸
echo "=== Active VNC Sessions ==="
sqlite3 database/sessions.db "SELECT session_id, user_id, node_id, status FROM vnc_sessions WHERE status='running';"

# 2. ìƒŒë“œë°•ìŠ¤ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
echo -e "\n=== Sandbox Disk Usage ==="
du -sh /scratch/apptainer_sandboxes/*

# 3. VNC ë¡œê·¸ ì—ëŸ¬ í™•ì¸
echo -e "\n=== Recent VNC Errors ==="
tail -n 50 /var/log/dashboard/vnc_errors.log

# 4. Slurm Job ìƒíƒœ
echo -e "\n=== VNC Slurm Jobs ==="
squeue -o "%.18i %.9P %.30j %.8u %.2t %.10M %.6D %R" | grep "vnc_"

# 5. ì¢€ë¹„ ìƒŒë“œë°•ìŠ¤ ì •ë¦¬
echo -e "\n=== Cleaning Zombie Sandboxes ==="
python3 /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010/visualization/cleanup_sandboxes.py
```

### 20.2 ì„±ëŠ¥ íŠœë‹ ê°€ì´ë“œ

#### TurboVNC ìµœì í™”
```bash
# vncserver ì˜µì…˜ ìµœì í™”
vncserver :1 \
  -geometry 1920x1080 \
  -depth 24 \
  -SecurityTypes None \
  -AlwaysShared \
  -AcceptPointerEvents=1 \
  -SendCutText=0 \
  -AcceptCutText=0 \
  -MaxIdleTime=28800  # 8ì‹œê°„
```

#### Apptainer ìºì‹œ ìµœì í™”
```yaml
# my_cluster.yaml ì—…ë°ì´íŠ¸
container_support:
  apptainer:
    enabled: true
    cache_path: /scratch/apptainer_cache  # SSD ìŠ¤í† ë¦¬ì§€ ê¶Œì¥
    tmp_dir: /scratch/tmp                 # ë¹ ë¥¸ ì„ì‹œ ë””ë ‰í† ë¦¬
    parallel_builds: 4                    # ë³‘ë ¬ ë¹Œë“œ ìˆ˜
```

### 20.3 ë°±ì—… ë° ë³µêµ¬

```bash
#!/bin/bash
# ë°±ì—… ìŠ¤í¬ë¦½íŠ¸
BACKUP_DIR="/backup/vnc_system/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 1. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
sqlite3 /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010/database/sessions.db ".backup $BACKUP_DIR/sessions.db"

# 2. Apptainer Definition íŒŒì¼ ë°±ì—…
cp /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010/static/apptainer_images/*.def $BACKUP_DIR/

# 3. Job í…œí”Œë¦¿ ë°±ì—…
cp -r /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010/visualization/job_templates $BACKUP_DIR/

# 4. ë§ˆìŠ¤í„° ì´ë¯¸ì§€ ë°±ì—… (ì„ íƒì )
# cp /scratch/apptainers/ubuntu_vnc_gpu.sif $BACKUP_DIR/
```

### 20.4 íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

| ë¬¸ì œ | ì¦ìƒ | í•´ê²° ë°©ë²• |
|------|------|----------|
| VNC í™”ë©´ ê²€ì€ìƒ‰ | ì—°ê²°ë˜ì§€ë§Œ í™”ë©´ í‘œì‹œ ì•ˆë¨ | `~/.vnc/xstartup` í™•ì¸, XFCE4 ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦ |
| GPU ì¸ì‹ ì•ˆë¨ | `nvidia-smi` ì‹¤íŒ¨ | `--nv` í”Œë˜ê·¸ í™•ì¸, í˜¸ìŠ¤íŠ¸ ë“œë¼ì´ë²„ ë²„ì „ í™•ì¸ |
| ìƒŒë“œë°•ìŠ¤ ìƒì„± ëŠë¦¼ | 30ì´ˆ ì´ìƒ ì†Œìš” | ìºì‹œ ë””ë ‰í† ë¦¬ë¥¼ SSDë¡œ ì´ë™, Overlay ë°©ì‹ ì‚¬ìš© |
| í¬íŠ¸ ì¶©ëŒ | VNC ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ | Display ë²ˆí˜¸ ìë™ í• ë‹¹ ë¡œì§ í™•ì¸ |
| WebSocket ëŠê¹€ | ì—°ê²° ë¶ˆì•ˆì • | í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¦ê°€, ë„¤íŠ¸ì›Œí¬ í™•ì¸ |

---

## 21. ì£¼ìš” ì°¨ì´ì  ìš”ì•½ (ì—…ë°ì´íŠ¸)

### ğŸ”„ ì›ë˜ ê³„íš vs ë³´ê°•ëœ ìµœì¢… ê³„íš

| í•­ëª© | ì›ë˜ ê³„íš | **ë³´ê°•ëœ ìµœì¢… ê³„íš** |
|------|----------|---------------------|
| **ì•„í‚¤í…ì²˜** | ë…ë¦½ ì„œë¹„ìŠ¤ (visualization_6000) | **backend_5010 í™•ì¥ (ê¶Œì¥) â­** |
| **Database** | ìƒˆ DB ìƒì„± | **ê¸°ì¡´ sessions.db í™•ì¥** |
| **ì¸ì¦** | ë³„ë„ ì¸ì¦ | **ê¸°ì¡´ JWT ì‹œìŠ¤í…œ ì¬ì‚¬ìš©** |
| **WebSocket** | ë…ë¦½ í”„ë¡ì‹œ | **websocket_5011 í™•ì¥** |
| **ëª¨ë‹ˆí„°ë§** | ì–¸ê¸‰ ì—†ìŒ | **Prometheus + Grafana í†µí•© â­** |
| **ë³´ì•ˆ** | ê¸°ë³¸ VNC ë¹„ë°€ë²ˆí˜¸ | **ì„¸ì…˜ë³„ í† í°, ì•”í˜¸í™”, SSH í„°ë„ â­** |
| **ì—ëŸ¬ ì²˜ë¦¬** | ê¸°ë³¸ ì¬ì‹œë„ | **ìë™ ë³µêµ¬ + ì•Œë¦¼ ì‹œìŠ¤í…œ â­** |
| **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬** | ì–¸ê¸‰ ì—†ìŒ | **ì¿¼í„°, GPU í• ë‹¹ ì •ì±…, ë””ìŠ¤í¬ ì •ë¦¬ â­** |
| **Frontend** | ê°„ë‹¨í•œ í†µí•© | **ìƒì„¸ ì»´í¬ë„ŒíŠ¸ + Custom Hooks â­** |
| **ìš´ì˜** | ì–¸ê¸‰ ì—†ìŒ | **ì¼ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸, ë°±ì—…, íŠ¸ëŸ¬ë¸”ìŠˆíŒ… â­** |

---

## 22. ê°œë°œ ìš°ì„ ìˆœìœ„ ë° ë¡œë“œë§µ (í†µí•© ì•„í‚¤í…ì²˜ ë°˜ì˜) â­

### Phase 0: ì¤‘ì•™ ì¸ì¦ í¬í„¸ (Auth Portal) êµ¬ì¶• (Week 1-2) - **CRITICAL PRIORITY** ğŸ”¥

**ëª©í‘œ**: 443 í¬íŠ¸ ë©”ì¸ í¬í„¸ + SAML SSO + JWT í† í° ì‹œìŠ¤í…œ ì™„ì„±

#### Week 1, Day 1-2: ì¸í”„ë¼ êµ¬ì¶•
- [ ] **í™˜ê²½ ì„¤ì •**
  - [ ] Redis ì„¤ì¹˜ ë° ì„¤ì •
  - [ ] Node.js ì„¤ì¹˜ (saml-idpìš©)
  - [ ] Nginx ì„¤ì¹˜ (443 í¬íŠ¸ í”„ë¡ì‹œìš©)
- [ ] **saml-idp ì„¤ì •**
  - [ ] saml-idp ì„¤ì¹˜
  - [ ] config.js ì‘ì„± (Auth Portal 4430 ì—°ë™)
  - [ ] ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„±
  - [ ] í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì 4ëª… ì„¤ì •
    - user01: ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼
    - user02: ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë§Œ
    - automation_user: ìë™í™”ë§Œ
    - admin: ëª¨ë“  ê¶Œí•œ

#### Week 1, Day 3-5: Auth Portal Backend
- [ ] **í”„ë¡œì íŠ¸ ìƒì„±**
  - [ ] auth_portal_443/backend ë””ë ‰í† ë¦¬ ìƒì„±
  - [ ] ê°€ìƒí™˜ê²½ ì„¤ì •
  - [ ] requirements.txt ì‘ì„± (python3-saml, PyJWT, flask-session, redis)
- [ ] **SAML ëª¨ë“ˆ (sso/)**
  - [ ] saml_config.py (dev/prod ë¶„ë¦¬)
  - [ ] saml_auth.py (SAMLAuthManager)
  - [ ] routes.py (/login, /acs, /logout, /metadata)
- [ ] **JWT ëª¨ë“ˆ (jwt_manager/)**
  - [ ] token_issuer.py (í† í° ë°œê¸‰ + ê°±ì‹ )
  - [ ] token_validator.py (í† í° ê²€ì¦ + ê¶Œí•œ í™•ì¸)
- [ ] **API (api/)**
  - [ ] auth.py (/verify, /refresh, /session)
  - [ ] services.py (ì„œë¹„ìŠ¤ ëª©ë¡, ì ‘ê·¼ URL)
- [ ] **app.py**
  - [ ] Flask-Session + Redis ì„¤ì •
  - [ ] Blueprint ë“±ë¡
  - [ ] CORS ì„¤ì •

#### Week 1, Day 6-7 + Week 2, Day 1-2: Auth Portal Frontend
- [ ] **í”„ë¡œì íŠ¸ ìƒì„±**
  - [ ] auth_portal_443/frontend (Vite + React + TypeScript)
  - [ ] Tailwind CSS ì„¤ì •
- [ ] **í˜ì´ì§€**
  - [ ] Login.tsx (SSO ë¡œê·¸ì¸ ë²„íŠ¼)
  - [ ] ServiceMenu.tsx (ì„œë¹„ìŠ¤ ì„ íƒ í™”ë©´)
  - [ ] Callback.tsx (SAML ACS ì²˜ë¦¬)
- [ ] **ì»´í¬ë„ŒíŠ¸**
  - [ ] ServiceCard.tsx (ì„œë¹„ìŠ¤ ì¹´ë“œ UI)
  - [ ] UserProfile.tsx (ì‚¬ìš©ì ì •ë³´ + ë¡œê·¸ì•„ì›ƒ)
- [ ] **ìœ í‹¸**
  - [ ] api.ts (Auth API í´ë¼ì´ì–¸íŠ¸)

#### Week 2, Day 3-4: í†µí•© í…ŒìŠ¤íŠ¸
- [ ] **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**
  - [ ] JWT í† í° ë°œê¸‰/ê²€ì¦ í…ŒìŠ¤íŠ¸
  - [ ] SAML ì¸ì¦ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
  - [ ] ê¶Œí•œ í™•ì¸ ë¡œì§ í…ŒìŠ¤íŠ¸
- [ ] **E2E í…ŒìŠ¤íŠ¸**
  - [ ] saml-idp ë¡œê·¸ì¸ â†’ JWT ë°œê¸‰
  - [ ] ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ (user01 â†’ 2ê°œ, user02 â†’ 1ê°œ)
  - [ ] ì„œë¹„ìŠ¤ ì„ íƒ â†’ í† í°ê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### Week 2, Day 5-7: Nginx í”„ë¡ì‹œ ì„¤ì •
- [ ] **Nginx ì„¤ì • (443 â†’ í”„ë¡ì‹œ)**
  - [ ] SSL ì¸ì¦ì„œ ìƒì„± (ìì²´ ì„œëª… ë˜ëŠ” Let's Encrypt)
  - [ ] 443 â†’ Auth Portal Frontend í”„ë¡ì‹œ
  - [ ] /api â†’ Auth Portal Backend (4430) í”„ë¡ì‹œ
  - [ ] CORS í—¤ë” ì¶”ê°€
- [ ] **í†µí•© í…ŒìŠ¤íŠ¸**
  - [ ] https://localhost â†’ Auth Portal ì ‘ì†
  - [ ] SSO ë¡œê·¸ì¸ í”Œë¡œìš° ì™„ë£Œ
  - [ ] ì„œë¹„ìŠ¤ ì„ íƒ â†’ 3010 ë˜ëŠ” 5173ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### ê²€ì¦ ê¸°ì¤€
- âœ… saml-idp ë¡œê·¸ì¸ â†’ JWT í† í° ë°œê¸‰
- âœ… ì„œë¹„ìŠ¤ ëª©ë¡ì— ê¶Œí•œ ê¸°ë°˜ í•„í„°ë§ ì ìš©
- âœ… ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ/ìë™í™” ì‹œìŠ¤í…œ ì„ íƒ ê°€ëŠ¥
- âœ… Nginx 443 í¬íŠ¸ì—ì„œ HTTPS ì ‘ì† ê°€ëŠ¥

---

### Phase 1: ê¸°ì¡´ ì„œë¹„ìŠ¤ JWT í†µí•© (Week 3) - **HIGH PRIORITY**

**ëª©í‘œ**: frontend_3010, backend_5010ì— JWT ê²€ì¦ ì¶”ê°€

#### Week 3, Day 1-3: backend_5010 JWT í†µí•©
- [ ] **JWT ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€**
  - [ ] jwt_middleware.py ìƒì„±
  - [ ] @jwt_required ë°ì½”ë ˆì´í„°
  - [ ] @permission_required ë°ì½”ë ˆì´í„°
- [ ] **ê¸°ì¡´ API ì—…ë°ì´íŠ¸**
  - [ ] visualization APIì— @jwt_required + @permission_required(['GPU-Users']) ì ìš©
  - [ ] Slurm APIì— @jwt_required + @permission_required(['HPC-Users']) ì ìš©
  - [ ] ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ `request.user` ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
- [ ] **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**
  - [ ] .env íŒŒì¼ì— JWT_SECRET_KEY ì¶”ê°€ (Auth Portalê³¼ ë™ì¼)

#### Week 3, Day 4-5: frontend_3010 JWT í†µí•©
- [ ] **AuthService ì¶”ê°€**
  - [ ] src/utils/auth.ts ìƒì„±
  - [ ] URLì—ì„œ í† í° ì¶”ì¶œ (initializeFromURL)
  - [ ] í† í° ì €ì¥/ì¡°íšŒ/ì‚­ì œ (localStorage)
  - [ ] í† í° ê²€ì¦ (Auth Portal /verify í˜¸ì¶œ)
- [ ] **App.tsx ì—…ë°ì´íŠ¸**
  - [ ] useEffectì—ì„œ í† í° ê²€ì¦
  - [ ] ì¸ì¦ ì‹¤íŒ¨ ì‹œ Auth Portalë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- [ ] **API í´ë¼ì´ì–¸íŠ¸ ì—…ë°ì´íŠ¸**
  - [ ] src/utils/api.ts ìˆ˜ì •
  - [ ] ëª¨ë“  ìš”ì²­ì— Authorization í—¤ë” ìë™ ì¶”ê°€
  - [ ] 401 ì‘ë‹µ ì‹œ Auth Portalë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### Week 3, Day 6-7: í†µí•© í…ŒìŠ¤íŠ¸
- [ ] **E2E í”Œë¡œìš°**
  - [ ] Auth Portal ë¡œê·¸ì¸ â†’ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ ì„ íƒ
  - [ ] frontend_3010ì—ì„œ í† í° ê²€ì¦ ì„±ê³µ
  - [ ] Slurm Job ì œì¶œ API í˜¸ì¶œ (JWT í† í° í¬í•¨)
  - [ ] VNC ì„¸ì…˜ ìƒì„± (GPU-Users ê¶Œí•œ í™•ì¸)
- [ ] **ê¶Œí•œ í…ŒìŠ¤íŠ¸**
  - [ ] user02 (HPC-Usersë§Œ) â†’ VNC ì ‘ê·¼ ë¶ˆê°€ (403)
  - [ ] user01 (GPU-Users í¬í•¨) â†’ VNC ì ‘ê·¼ ê°€ëŠ¥

#### ê²€ì¦ ê¸°ì¤€
- âœ… frontend_3010 ìë™ í† í° ê²€ì¦
- âœ… backend_5010 ëª¨ë“  API JWT ë³´í˜¸
- âœ… ê¶Œí•œ ê¸°ë°˜ API ì ‘ê·¼ ì œì–´ ë™ì‘

---

### Phase 2: ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶• (Week 4-5) - **HIGH PRIORITY**

**ëª©í‘œ**: frontend_5173, backend_5000/5001 ì‹ ê·œ ê°œë°œ

#### Week 4: backend_5000/5001
- [ ] **backend_5000 ê¸°ë³¸ êµ¬ì¡°**
  - [ ] Flask í”„ë¡œì íŠ¸ ìƒì„±
  - [ ] JWT ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€ (backend_5010ê³¼ ë™ì¼)
  - [ ] @permission_required(['Automation-Users'])
- [ ] **ì›Œí¬í”Œë¡œìš° API**
  - [ ] /api/workflows (ëª©ë¡, ìƒì„±, ì‚­ì œ)
  - [ ] /api/workflows/<id>/execute (ì‹¤í–‰)
  - [ ] /api/workflows/<id>/status (ìƒíƒœ ì¡°íšŒ)
- [ ] **5010 í”„ë¡ì‹œ**
  - [ ] /api/slurm/* â†’ backend_5010ìœ¼ë¡œ í”„ë¡ì‹œ
  - [ ] JWT í† í° ì „ë‹¬
- [ ] **backend_5001 í”„ë¡ì‹œ ì„œë²„**
  - [ ] Flask ë˜ëŠ” Nginx
  - [ ] 5001 â†’ 5000 í”„ë¡ì‹œ

#### Week 5: frontend_5173
- [ ] **í”„ë¡œì íŠ¸ ìƒì„±**
  - [ ] Vite + React + TypeScript
  - [ ] Tailwind CSS
- [ ] **AuthService í†µí•©** (frontend_3010ê³¼ ë™ì¼)
- [ ] **ì›Œí¬í”Œë¡œìš° UI**
  - [ ] ì›Œí¬í”Œë¡œìš° ëª©ë¡
  - [ ] ì›Œí¬í”Œë¡œìš° ìƒì„±/í¸ì§‘
  - [ ] Job ì‹¤í–‰ ë° ëª¨ë‹ˆí„°ë§

#### ê²€ì¦ ê¸°ì¤€
- âœ… Auth Portal â†’ ìë™í™” ì‹œìŠ¤í…œ ì„ íƒ â†’ frontend_5173 ì ‘ì†
- âœ… automation_userë¡œ ë¡œê·¸ì¸ â†’ ì›Œí¬í”Œë¡œìš° ì ‘ê·¼ ê°€ëŠ¥
- âœ… user02 (Automation-Users ì—†ìŒ) â†’ 403 ì—ëŸ¬

---

### Phase 3-4: VNC, ëª¨ë‹ˆí„°ë§, ìµœì í™” (Week 6-8)
(ê¸°ì¡´ ê³„íš ìœ ì§€)

---

### Phase 1: í•µì‹¬ VNC ê¸°ëŠ¥ (Week 2-3) - **HIGH PRIORITY**

**ëª©í‘œ**: ì¸ì¦ëœ ì‚¬ìš©ìê°€ VNC ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„

#### Week 2: Backend êµ¬í˜„
- [ ] **ì¸ì¦ í†µí•©**
  - [ ] visualization APIì— `@login_required` ì ìš©
  - [ ] VNC ì„¸ì…˜ ìƒì„± ì‹œ `@permission_required(['GPU-Users'])` ì ìš©
  - [ ] ì‚¬ìš©ìë³„ ì„¸ì…˜ ê²©ë¦¬ (user_id ê¸°ë°˜)
- [ ] **Database ìŠ¤í‚¤ë§ˆ**
  - [ ] vnc_sessions í…Œì´ë¸” ì¶”ê°€
  - [ ] vnc_quotas í…Œì´ë¸” ì¶”ê°€
  - [ ] user_id ì™¸ë˜í‚¤ ì„¤ì •
- [ ] **Apptainer í†µí•©**
  - [ ] ubuntu_vnc_gpu.def ì‘ì„±
  - [ ] ì´ë¯¸ì§€ ë¹Œë“œ ë° ë…¸ë“œ ë°°í¬
  - [ ] ìƒŒë“œë°•ìŠ¤ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
- [ ] **Slurm í†µí•©**
  - [ ] vnc_session.sh.j2 í…œí”Œë¦¿ ì‘ì„±
  - [ ] Job ì œì¶œ ë¡œì§ (ì‚¬ìš©ì ê¶Œí•œìœ¼ë¡œ ì œì¶œ)
  - [ ] Job ìƒíƒœ ëª¨ë‹ˆí„°ë§

#### Week 3: Frontend + WebSocket
- [ ] **Frontend ì»´í¬ë„ŒíŠ¸**
  - [ ] SessionManager (ì„¸ì…˜ ìƒì„± UI)
  - [ ] NodeSelector (GPU ë…¸ë“œ ì„ íƒ)
  - [ ] VNCViewer (noVNC í†µí•©)
  - [ ] SessionList (ì‚¬ìš©ì ì„¸ì…˜ ëª©ë¡)
- [ ] **WebSocket í”„ë¡ì‹œ**
  - [ ] websocket_5011 í™•ì¥
  - [ ] VNC í”„ë¡ì‹œ í•¸ë“¤ëŸ¬
  - [ ] ì„¸ì…˜ ì¸ì¦ í™•ì¸

#### ê²€ì¦ ê¸°ì¤€
- âœ… SSO ë¡œê·¸ì¸ í›„ VNC ì„¸ì…˜ ìƒì„± ê°€ëŠ¥
- âœ… GPU-Users ê·¸ë£¹ë§Œ ì„¸ì…˜ ìƒì„± ê°€ëŠ¥
- âœ… ìƒŒë“œë°•ìŠ¤ ë‚´ì—ì„œ VNC ì„œë²„ ì‹œì‘
- âœ… ë¸Œë¼ìš°ì €ì—ì„œ Desktop í‘œì‹œ
- âœ… ì‚¬ìš©ìë³„ ì„¸ì…˜ ê²©ë¦¬ í™•ì¸

---

### Phase 2: ë³´ì•ˆ ê°•í™” ë° ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ (Week 4) - **HIGH PRIORITY**

#### ë³´ì•ˆ ê°•í™”
- [ ] VNC ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (Fernet)
- [ ] ì„¸ì…˜ë³„ í† í° ì‹œìŠ¤í…œ (SHA256)
- [ ] SSH í„°ë„ ì˜µì…˜ ì¶”ê°€
- [ ] SAML Assertion ì„œëª… ê²€ì¦ ê°•í™”

#### ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
- [ ] ì‚¬ìš©ì ì¿¼í„° ì‹œìŠ¤í…œ (ìµœëŒ€ ì„¸ì…˜ ìˆ˜)
- [ ] GPU í• ë‹¹ ì •ì±… (Fair-share)
- [ ] Display ë²ˆí˜¸ ìë™ í• ë‹¹
- [ ] ìƒŒë“œë°•ìŠ¤ ë””ìŠ¤í¬ ê´€ë¦¬

#### ADFS ì—°ë™ ì¤€ë¹„
- [ ] í”„ë¡œë•ì…˜ SAML ì„¤ì • (.env.production)
- [ ] ADFS ê´€ë¦¬ìì™€ í˜‘ì—…
  - [ ] Relying Party Trust ì„¤ì •
  - [ ] Claim Rules ì„¤ì •
  - [ ] ê·¸ë£¹ ë§¤í•‘ í™•ì¸
- [ ] í™˜ê²½ ë³€ìˆ˜ ì „í™˜ í…ŒìŠ¤íŠ¸ (dev â†’ prod)

#### ê²€ì¦ ê¸°ì¤€
- âœ… ì‚¬ìš©ìë‹¹ ìµœëŒ€ 2ê°œ ì„¸ì…˜ ì œí•œ
- âœ… GPU ì‚¬ìš©ë¥  ê¸°ë°˜ ë…¸ë“œ í• ë‹¹
- âœ… VNC ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì €ì¥
- âœ… ADFS ì—°ë™ í…ŒìŠ¤íŠ¸ (ê°€ëŠ¥í•œ ê²½ìš°)

---

### Phase 3: ëª¨ë‹ˆí„°ë§ ë° ìë™ ë³µêµ¬ (Week 5) - **MEDIUM PRIORITY**

#### ëª¨ë‹ˆí„°ë§
- [ ] Prometheus ë©”íŠ¸ë¦­ ì¶”ê°€
  - [ ] vnc_sessions_total
  - [ ] vnc_sessions_active
  - [ ] apptainer_sandbox_build_time
  - [ ] sso_login_failures
- [ ] Grafana ëŒ€ì‹œë³´ë“œ ìƒì„±
- [ ] ë¡œê¹… ì‹œìŠ¤í…œ ê°œì„ 

#### ìë™ ë³µêµ¬
- [ ] ì„¸ì…˜ í—¬ìŠ¤ì²´í¬ (30ì´ˆ ì£¼ê¸°)
- [ ] VNC í”„ë¡œì„¸ìŠ¤ ìë™ ì¬ì‹œì‘
- [ ] Slurm Job ì¬ìŠ¤ì¼€ì¤„ë§
- [ ] ì—ëŸ¬ ì•Œë¦¼ ì‹œìŠ¤í…œ (WebSocket + Email)

#### ê²€ì¦ ê¸°ì¤€
- âœ… Grafanaì—ì„œ ì„¸ì…˜ ìƒíƒœ ì‹œê°í™”
- âœ… VNC ì„œë²„ í¬ë˜ì‹œ ì‹œ ìë™ ë³µêµ¬
- âœ… ì—ëŸ¬ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸

---

### Phase 4: ìµœì í™” ë° ìš´ì˜ (Week 6) - **LOW PRIORITY**

#### ì„±ëŠ¥ ìµœì í™”
- [ ] TurboVNC ì˜µì…˜ íŠœë‹
- [ ] Apptainer ìºì‹œ ìµœì í™” (SSD í™œìš©)
- [ ] ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš© ì „ëµ
- [ ] WebSocket ë²„í¼ë§ ìµœì í™”

#### ìš´ì˜ ìë™í™”
- [ ] ì¼ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- [ ] ë°±ì—… ìë™í™” (Database, Definition íŒŒì¼)
- [ ] ì¢€ë¹„ ìƒŒë“œë°•ìŠ¤ ìë™ ì •ë¦¬
- [ ] ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •

#### ë¬¸ì„œí™”
- [ ] ì‚¬ìš©ì ê°€ì´ë“œ (SSO ë¡œê·¸ì¸, ì„¸ì…˜ ìƒì„±)
- [ ] ê´€ë¦¬ì ê°€ì´ë“œ (ADFS ì„¤ì •, íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)
- [ ] API ë¬¸ì„œ (Swagger/OpenAPI)

#### ê²€ì¦ ê¸°ì¤€
- âœ… ìƒŒë“œë°•ìŠ¤ ìƒì„± < 30ì´ˆ
- âœ… 24ì‹œê°„ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… ë¬¸ì„œ ì™„ì„±ë„ 90% ì´ìƒ

---

### ì „ì²´ ë¡œë“œë§µ íƒ€ì„ë¼ì¸

```
Week 1: [SSO ì¸ì¦ ì‹œìŠ¤í…œ] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (Critical)
Week 2: [VNC Backend]      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (High)
Week 3: [VNC Frontend]     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (High)
Week 4: [ë³´ì•ˆ + ë¦¬ì†ŒìŠ¤]     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         (High)
Week 5: [ëª¨ë‹ˆí„°ë§ + ë³µêµ¬]   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             (Medium)
Week 6: [ìµœì í™” + ìš´ì˜]     â–ˆâ–ˆâ–ˆâ–ˆ                 (Low)
```

### ì£¼ìš” ë§ˆì¼ìŠ¤í†¤

| Week | ë§ˆì¼ìŠ¤í†¤ | í•µì‹¬ ê¸°ëŠ¥ |
|------|---------|----------|
| **Week 1** | SSO ì¸ì¦ ì™„ì„± | saml-idp ë¡œê·¸ì¸, ê¶Œí•œ ê²€ì¦, Redis ì„¸ì…˜ |
| **Week 2-3** | VNC ì„¸ì…˜ ìƒì„± | Apptainer + Slurm + VNC + noVNC |
| **Week 4** | ë³´ì•ˆ + ADFS | í† í° ì•”í˜¸í™”, ADFS ì—°ë™ ì¤€ë¹„ |
| **Week 5** | ëª¨ë‹ˆí„°ë§ | Prometheus, ìë™ ë³µêµ¬ |
| **Week 6** | í”„ë¡œë•ì…˜ ì¤€ë¹„ | ì„±ëŠ¥ íŠœë‹, ë¬¸ì„œí™”, ìš´ì˜ ìë™í™” |

---

## 23. ì„±ê³µ ê¸°ì¤€ (ì—…ë°ì´íŠ¸)

### ê¸°ëŠ¥ì  ê¸°ì¤€
- [x] **ê¸°ì¡´ ì¸í”„ë¼ í†µí•©**: backend_5010, websocket_5011, database ì¬ì‚¬ìš© âœ…
- [ ] GPU ë…¸ë“œ ì„ íƒ ê°€ëŠ¥
- [ ] Apptainer ìƒŒë“œë°•ìŠ¤ ìë™ ìƒì„±
- [ ] ìƒŒë“œë°•ìŠ¤ ë‚´ì—ì„œ VNC ì„œë²„ ì‹œì‘
- [ ] ë¸Œë¼ìš°ì €ì—ì„œ Ubuntu ë°ìŠ¤í¬í†± í‘œì‹œ
- [ ] GPU ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ê°€ëŠ¥ (vglrun glxgears)
- [ ] ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš©ìœ¼ë¡œ ë¹ ë¥¸ ì¬ì‹œì‘
- [ ] ë‹¤ì¤‘ ì„¸ì…˜ ì§€ì› (ì‚¬ìš©ìë‹¹ ìµœëŒ€ 2-3ê°œ)
- [ ] **ì¸ì¦ ë° ë³´ì•ˆ**: JWT + ì„¸ì…˜ í† í° + ì•”í˜¸í™” âœ…
- [ ] **ìë™ ë³µêµ¬**: ì„¸ì…˜ í—¬ìŠ¤ì²´í¬ + ì—ëŸ¬ ë³µêµ¬ âœ…
- [ ] **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**: ì¿¼í„° + GPU í• ë‹¹ + ë””ìŠ¤í¬ ì •ë¦¬ âœ…

### ì„±ëŠ¥ ê¸°ì¤€
- [ ] ìƒŒë“œë°•ìŠ¤ ìƒì„±: < 30ì´ˆ (ì²« ì‹¤í–‰)
- [ ] ìƒŒë“œë°•ìŠ¤ ì¬ì‚¬ìš©: < 5ì´ˆ (ì¬ì‹¤í–‰)
- [ ] VNC ì‘ë‹µ ì‹œê°„: < 100ms
- [ ] GPU ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥: ë„¤ì´í‹°ë¸Œ ëŒ€ë¹„ 95% ì´ìƒ
- [ ] **WebSocket ì²˜ë¦¬ëŸ‰**: 1,000+ ë©”ì‹œì§€/ì´ˆ âœ…

### ì•ˆì •ì„± ê¸°ì¤€
- [ ] 24ì‹œê°„ ì—°ì† ìš´ì˜ ì‹œ ì¥ì•  ì—†ìŒ
- [ ] ìƒŒë“œë°•ìŠ¤ ê²©ë¦¬ë¡œ ì‚¬ìš©ì ê°„ ê°„ì„­ ì—†ìŒ
- [ ] Slurm Job ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
- [ ] **ì—ëŸ¬ ë³µêµ¬ìœ¨**: 90% ì´ìƒ ìë™ ë³µêµ¬ âœ…
- [ ] **ì„¸ì…˜ ë³µêµ¬ ì‹œê°„**: < 30ì´ˆ âœ…

### ìš´ì˜ ê¸°ì¤€
- [ ] **ëª¨ë‹ˆí„°ë§**: Prometheus + Grafana ëŒ€ì‹œë³´ë“œ âœ…
- [ ] **ë¡œê¹…**: êµ¬ì¡°í™”ëœ ë¡œê·¸ (ì„¸ì…˜, Apptainer, ì—ëŸ¬) âœ…
- [ ] **ë°±ì—…**: ì¼ì¼ ìë™ ë°±ì—… âœ…
- [ ] **ë¬¸ì„œí™”**: ì‚¬ìš©ì ê°€ì´ë“œ + ê´€ë¦¬ì ê°€ì´ë“œ + API ë¬¸ì„œ âœ…

---

## 24. ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ì‘ì—… (Auth Portal 443 ì¤‘ì‹¬) ğŸ”¥

### **Phase 0-1: Auth Portal ì¸í”„ë¼ êµ¬ì¶• (Week 1 Day 1-2)**

#### Step 1: í•„ìˆ˜ ì¸í”„ë¼ ì„¤ì¹˜ (30ë¶„)

```bash
# Redis ì„¤ì¹˜ (ì„¸ì…˜ ì €ì¥ì†Œ)
sudo apt update
sudo apt install redis-server -y
sudo systemctl start redis
sudo systemctl enable redis
redis-cli ping  # PONG ì‘ë‹µ í™•ì¸

# Node.js 18 ì„¤ì¹˜ (saml-idpìš©)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
node --version  # v18.x.x í™•ì¸

# Nginx ì„¤ì¹˜ (443 HTTPS í”„ë¡ì‹œ)
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
nginx -v  # ë²„ì „ í™•ì¸
```

#### Step 2: Auth Portal í”„ë¡œì íŠ¸ êµ¬ì¡° ìƒì„± (10ë¶„)

```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard

# Backend ë””ë ‰í† ë¦¬ êµ¬ì¡°
mkdir -p auth_portal_443/backend/{sso,jwt_manager,api,database,saml_certs}
mkdir -p auth_portal_443/backend/sso
mkdir -p auth_portal_443/backend/jwt_manager
mkdir -p auth_portal_443/backend/api
mkdir -p auth_portal_443/backend/database

# Frontend ë””ë ‰í† ë¦¬ (ë‚˜ì¤‘ì— npm create viteë¡œ ì´ˆê¸°í™”)
mkdir -p auth_portal_443/frontend

# êµ¬ì¡° í™•ì¸
tree auth_portal_443 -L 3
# auth_portal_443/
# â”œâ”€â”€ backend/
# â”‚   â”œâ”€â”€ sso/
# â”‚   â”œâ”€â”€ jwt_manager/
# â”‚   â”œâ”€â”€ api/
# â”‚   â”œâ”€â”€ database/
# â”‚   â””â”€â”€ saml_certs/
# â””â”€â”€ frontend/
```

#### Step 3: saml-idp ê°œë°œ í™˜ê²½ ì„¤ì • (20ë¶„)

```bash
# saml-idp ì„¤ì¹˜
npm install -g saml-idp

# saml-idp ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp

# ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„±
openssl req -x509 -newkey rsa:2048 -keyout idp-key.pem -out idp-cert.pem -days 365 -nodes \
  -subj "/C=KR/ST=Seoul/L=Seoul/O=HPC Lab/CN=localhost"

# Section 0.4ì˜ config.js ìƒì„± (4ëª…ì˜ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì í¬í•¨)
cat > config.js << 'EOF'
module.exports = {
  user: 'user01',  // ê¸°ë³¸ ë¡œê·¸ì¸ ì‚¬ìš©ì
  users: [
    {
      nameID: 'user01',
      email: 'user01@hpc.local',
      displayName: 'Test User 1',
      groups: ['HPC-Users', 'GPU-Users', 'Automation-Users']  // ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼
    },
    {
      nameID: 'user02',
      email: 'user02@hpc.local',
      displayName: 'Test User 2',
      groups: ['HPC-Users']  // 3010 ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë§Œ
    },
    {
      nameID: 'automation_user',
      email: 'automation@hpc.local',
      displayName: 'Automation User',
      groups: ['Automation-Users']  // 5173 ìë™í™” ì‹œìŠ¤í…œë§Œ
    },
    {
      nameID: 'admin',
      email: 'admin@hpc.local',
      displayName: 'Administrator',
      groups: ['HPC-Admins', 'HPC-Users', 'GPU-Users', 'Automation-Users']  // ì „ì²´ ì ‘ê·¼
    }
  ],
  audience: 'hpc-auth-portal',  // Auth Portal SP EntityID
  destination: 'http://localhost:4430/sso/acs',  // Auth Portal ACS URL
  acsUrl: 'http://localhost:4430/sso/acs',
  sloUrl: 'http://localhost:4430/sso/slo'
};
EOF

# start.sh ìƒì„±
cat > start.sh << 'EOF'
#!/bin/bash
saml-idp --iss http://localhost:7000/metadata \
  --acs http://localhost:4430/sso/acs \
  --aud hpc-auth-portal \
  --cert idp-cert.pem \
  --key idp-key.pem \
  --port 7000 \
  --config config.js
EOF
chmod +x start.sh

# saml-idp ì‹¤í–‰ (ë³„ë„ í„°ë¯¸ë„)
./start.sh
# ì¶œë ¥: IdP is running on http://localhost:7000
```

---

### **Phase 0-2: Auth Portal Backend êµ¬í˜„ (Week 1 Day 3-5)**

#### Step 4: Backend Python í™˜ê²½ ì„¤ì • (15ë¶„)

```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443/backend

# Python ê°€ìƒí™˜ê²½ ìƒì„±
python3 -m venv venv
source venv/bin/activate

# í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
pip install flask flask-cors python3-saml PyJWT redis flask-session

# requirements.txt ìƒì„±
pip freeze > requirements.txt

# saml-idp ì¸ì¦ì„œ ë³µì‚¬
cp ../../saml_idp/idp-cert.pem saml_certs/idp-cert.pem
```

#### Step 5: SAML ì¸ì¦ ëª¨ë“ˆ êµ¬í˜„ (1-2ì‹œê°„)

Section 0.5ì˜ ì½”ë“œë¥¼ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒ íŒŒì¼ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤:

```bash
cd sso

# 1. saml_config.py (SAML SP ì„¤ì •)
cat > saml_config.py << 'EOF'
# Section 0.5 ì°¸ì¡°: SAML SP ì„¤ì •
import os

def get_saml_settings():
    return {
        "strict": True,
        "debug": True,
        "sp": {
            "entityId": "hpc-auth-portal",
            "assertionConsumerService": {
                "url": "http://localhost:4430/sso/acs",
                "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
            },
            "singleLogoutService": {
                "url": "http://localhost:4430/sso/slo",
                "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "x509cert": "",
            "privateKey": ""
        },
        "idp": {
            "entityId": "http://localhost:7000/metadata",
            "singleSignOnService": {
                "url": "http://localhost:7000/saml/sso",
                "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "x509cert": open("saml_certs/idp-cert.pem").read()
        }
    }
EOF

# 2. saml_auth.py (SAML ì¸ì¦ ì²˜ë¦¬)
# Section 0.5 ì°¸ì¡°: SAMLAuthManager í´ë˜ìŠ¤

# 3. routes.py (SAML ë¼ìš°íŠ¸)
# Section 0.5 ì°¸ì¡°: /sso/login, /sso/acs, /sso/metadata

# 4. __init__.py
touch __init__.py
```

#### Step 6: JWT í† í° ë§¤ë‹ˆì € êµ¬í˜„ (1ì‹œê°„)

```bash
cd ../jwt_manager

# token_issuer.py (JWT ë°œê¸‰)
# Section 0.5 ì°¸ì¡°: JWTTokenIssuer í´ë˜ìŠ¤

# token_validator.py (JWT ê²€ì¦)
# Section 0.5 ì°¸ì¡°: JWTTokenValidator í´ë˜ìŠ¤

# __init__.py
touch __init__.py
```

#### Step 7: Services API êµ¬í˜„ (1ì‹œê°„)

```bash
cd ../api

# services.py (ì„œë¹„ìŠ¤ ëª©ë¡ ë° ì ‘ê·¼ ì œì–´)
# Section 0.5 ì°¸ì¡°: SERVICES ëª©ë¡ ë° ì—”ë“œí¬ì¸íŠ¸

# auth.py (ì„¸ì…˜ ê²€ì¦ API)
# Section 0.5 ì°¸ì¡°: /api/auth/verify, /api/auth/refresh

# __init__.py
touch __init__.py
```

#### Step 8: Auth Portal Backend ë©”ì¸ ì•± êµ¬ì„± (30ë¶„)

```bash
cd ..  # auth_portal_443/backend

# app.py (Flask ì•± ë©”ì¸)
cat > app.py << 'EOF'
from flask import Flask, session
from flask_cors import CORS
from flask_session import Session
import redis
import os

# ëª¨ë“ˆ ì„í¬íŠ¸
from sso.routes import sso_bp
from api.services import services_bp
from api.auth import auth_bp

app = Flask(__name__)
CORS(app, supports_credentials=True)

# ì„¸ì…˜ ì„¤ì • (Redis)
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://localhost:6379')
app.config['SESSION_COOKIE_NAME'] = 'auth_portal_session'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['PERMANENT_SESSION_LIFETIME'] = 28800  # 8ì‹œê°„

Session(app)

# Blueprint ë“±ë¡
app.register_blueprint(sso_bp, url_prefix='/sso')
app.register_blueprint(services_bp, url_prefix='/api/services')
app.register_blueprint(auth_bp, url_prefix='/api/auth')

@app.route('/health')
def health():
    return {'status': 'ok', 'service': 'auth-portal-backend'}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=4430, debug=True)
EOF

# .env íŒŒì¼ ìƒì„±
cat > .env << 'EOF'
FLASK_ENV=development
SECRET_KEY=dev-secret-key-change-in-production
JWT_SECRET_KEY=jwt-secret-key-shared-across-all-services
REDIS_URL=redis://localhost:6379
SAML_ENV=dev
EOF
```

#### Step 9: Backend í…ŒìŠ¤íŠ¸ (30ë¶„)

```bash
# Terminal 1: saml-idp ì‹¤í–‰
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp
./start.sh

# Terminal 2: Auth Portal Backend ì‹¤í–‰
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443/backend
source venv/bin/activate
python app.py

# Terminal 3: í…ŒìŠ¤íŠ¸
curl http://localhost:4430/health
curl http://localhost:4430/sso/metadata  # SAML SP Metadata í™•ì¸
curl http://localhost:4430/api/services  # ì„œë¹„ìŠ¤ ëª©ë¡ í™•ì¸ (ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥)

# ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸
# http://localhost:4430/sso/login ì ‘ì† â†’ saml-idp ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

---

### **Phase 0-3: Auth Portal Frontend êµ¬í˜„ (Week 1 Day 6-7, Week 2 Day 1-2)**

#### Step 10: React + Vite í”„ë¡œì íŠ¸ ì´ˆê¸°í™” (15ë¶„)

```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443

# Vite React TypeScript í”„ë¡œì íŠ¸ ìƒì„±
npm create vite@latest frontend -- --template react-ts
cd frontend
npm install

# ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
npm install react-router-dom axios jwt-decode
npm install @types/node --save-dev

# ê°œë°œ ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ ë³€ê²½: 5173 â†’ 4431)
# vite.config.ts ìˆ˜ì •
cat >> vite.config.ts << 'EOF'
export default {
  server: {
    port: 4431
  }
}
EOF
```

#### Step 11: Auth Portal í˜ì´ì§€ êµ¬í˜„ (2-3ì‹œê°„)

Section 0.6ê³¼ 0.7ì„ ì°¸ì¡°í•˜ì—¬ ë‹¤ìŒ í˜ì´ì§€ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤:

```bash
cd src

# 1. Login í˜ì´ì§€ (src/pages/Login.tsx)
# - SAML SSO ë¡œê·¸ì¸ ë²„íŠ¼ (/sso/loginìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
# - ë¡œê³  ë° í™˜ì˜ ë©”ì‹œì§€

# 2. ServiceMenu í˜ì´ì§€ (src/pages/ServiceMenu.tsx)
# - ì‚¬ìš©ì ì •ë³´ í‘œì‹œ (displayName, email, groups)
# - /api/servicesì—ì„œ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
# - ê·¸ë£¹ë³„ ì ‘ê·¼ ê°€ëŠ¥ ì„œë¹„ìŠ¤ í•„í„°ë§
# - ì„œë¹„ìŠ¤ ì¹´ë“œ í´ë¦­ ì‹œ JWT í† í°ì„ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì „ë‹¬í•˜ì—¬ ë¦¬ë‹¤ì´ë ‰íŠ¸
#   ì˜ˆ: http://localhost:3010?token=eyJhbGciOi...

# 3. Callback í˜ì´ì§€ (src/pages/Callback.tsx)
# - SAML ACS ì²˜ë¦¬ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°›ëŠ” í˜ì´ì§€
# - ì„¸ì…˜ í™•ì¸ â†’ ServiceMenuë¡œ ì´ë™

# 4. AuthService (src/utils/auth.ts)
# - ì„¸ì…˜ ê²€ì¦ (/api/auth/verify)
# - í† í° ë¦¬í”„ë ˆì‹œ (/api/auth/refresh)
# - ë¡œê·¸ì•„ì›ƒ (/api/auth/logout)

# 5. App.tsx ë¼ìš°íŒ…
# - / â†’ Login
# - /callback â†’ Callback
# - /services â†’ ServiceMenu (Protected Route)
```

#### Step 12: Frontend í†µí•© í…ŒìŠ¤íŠ¸ (30ë¶„)

```bash
# Terminal 1: saml-idp
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/saml_idp
./start.sh

# Terminal 2: Auth Portal Backend
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443/backend
source venv/bin/activate
python app.py

# Terminal 3: Auth Portal Frontend
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443/frontend
npm run dev

# ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸
# 1. http://localhost:4431 ì ‘ì†
# 2. "SSO ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­
# 3. saml-idp ë¡œê·¸ì¸ (user01 / ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ)
# 4. ServiceMenu í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
# 5. ì„œë¹„ìŠ¤ ì¹´ë“œ 2ê°œ í‘œì‹œ í™•ì¸ (user01ì€ ëª¨ë“  ì„œë¹„ìŠ¤ ì ‘ê·¼ ê°€ëŠ¥)
```

---

### **Phase 0-4: Nginx HTTPS í”„ë¡ì‹œ ì„¤ì • (Week 2 Day 3-4)**

#### Step 13: SSL ì¸ì¦ì„œ ìƒì„± (10ë¶„)

```bash
# ìì²´ ì„œëª… ì¸ì¦ì„œ ìƒì„± (ê°œë°œìš©)
sudo mkdir -p /etc/nginx/ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/auth_portal.key \
  -out /etc/nginx/ssl/auth_portal.crt \
  -subj "/C=KR/ST=Seoul/L=Seoul/O=HPC Lab/CN=localhost"
```

#### Step 14: Nginx ì„¤ì • (20ë¶„)

```bash
# Nginx ì„¤ì • íŒŒì¼ ìƒì„±
sudo nano /etc/nginx/sites-available/auth_portal_443

# ë‹¤ìŒ ë‚´ìš© ì…ë ¥:
server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/ssl/auth_portal.crt;
    ssl_certificate_key /etc/nginx/ssl/auth_portal.key;

    # Frontend (React)
    location / {
        proxy_pass http://localhost:4431;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API
    location /api/ {
        proxy_pass http://localhost:4430/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SAML SSO
    location /sso/ {
        proxy_pass http://localhost:4430/sso/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ì„¤ì • í™œì„±í™”
sudo ln -s /etc/nginx/sites-available/auth_portal_443 /etc/nginx/sites-enabled/
sudo nginx -t  # ì„¤ì • ê²€ì¦
sudo systemctl reload nginx
```

#### Step 15: HTTPS í†µí•© í…ŒìŠ¤íŠ¸ (30ë¶„)

```bash
# ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰ í›„
# https://localhost ì ‘ì† (ë¸Œë¼ìš°ì €ì—ì„œ ìì²´ ì„œëª… ì¸ì¦ì„œ ê²½ê³  ë¬´ì‹œ)
# SSO ë¡œê·¸ì¸ í”Œë¡œìš° ì™„ì „ í…ŒìŠ¤íŠ¸
```

---

### **Phase 1: ê¸°ì¡´ ì„œë¹„ìŠ¤ JWT í†µí•© (Week 3)**

#### Step 16: backend_5010 JWT ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€

Section 0.6ì˜ ì½”ë“œ ì°¸ì¡°:
```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/backend_5010

# jwt_middleware.py ìƒì„±
# @jwt_required ë°ì½”ë ˆì´í„° ì¶”ê°€
# ê¸°ì¡´ APIì— ì ìš©
```

#### Step 17: frontend_3010 JWT í•¸ë“¤ë§ ì¶”ê°€

Section 0.7ì˜ ì½”ë“œ ì°¸ì¡°:
```bash
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/frontend_3010/src

# utils/auth.ts ìƒì„±
# AuthService.initializeFromURL() í˜¸ì¶œ (App.tsx)
# API ìš”ì²­ ì‹œ Authorization í—¤ë” ì¶”ê°€
```

---

### **Phase 2-4: ì´í›„ ì‘ì—… (Week 4-8)**

#### Step 18: Automation System (backend_5000/5001 + frontend_5173)
#### Step 19: VNC Visualization ê¸°ëŠ¥ (Apptainer + TurboVNC)
#### Step 20: Monitoring (Prometheus + Grafana)
#### Step 21: ìš´ì˜ ìµœì í™” ë° ë¬¸ì„œí™”

---

## 25. ì²´í¬ë¦¬ìŠ¤íŠ¸ ë° ê²€ì¦ âœ…

### Phase 0 Week 1-2 ì™„ë£Œ ê¸°ì¤€ (Auth Portal 443)

#### Week 1 Day 1-2: ì¸í”„ë¼ (Step 1-3)
- [ ] **í•„ìˆ˜ ì„œë¹„ìŠ¤ ì„¤ì¹˜**
  - [ ] Redis ì‹¤í–‰ ì¤‘ (`redis-cli ping` â†’ PONG)
  - [ ] Node.js 18.x ì„¤ì¹˜ ì™„ë£Œ
  - [ ] Nginx ì‹¤í–‰ ì¤‘
- [ ] **saml-idp ì„¤ì •**
  - [ ] saml-idp í¬íŠ¸ 7000ì—ì„œ ì‹¤í–‰ ì¤‘
  - [ ] config.jsì— 4ëª…ì˜ í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ë“±ë¡
  - [ ] idp-cert.pem ìƒì„± ì™„ë£Œ
- [ ] **í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬**
  - [ ] auth_portal_443/backend/{sso,jwt_manager,api,database,saml_certs} ìƒì„±
  - [ ] auth_portal_443/frontend ë””ë ‰í† ë¦¬ ì¡´ì¬

#### Week 1 Day 3-5: Backend (Step 4-9)
- [ ] **Backend í™˜ê²½**
  - [ ] Python venv í™œì„±í™”
  - [ ] í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜: flask, python3-saml, PyJWT, redis, flask-session
  - [ ] saml_certs/idp-cert.pem ë³µì‚¬ ì™„ë£Œ
- [ ] **SAML ì¸ì¦ ëª¨ë“ˆ**
  - [ ] `sso/saml_config.py`: SP ì„¤ì • ì™„ë£Œ
  - [ ] `sso/saml_auth.py`: SAMLAuthManager í´ë˜ìŠ¤ êµ¬í˜„
  - [ ] `sso/routes.py`: /sso/login, /sso/acs, /sso/metadata ì—”ë“œí¬ì¸íŠ¸
- [ ] **JWT í† í° ë§¤ë‹ˆì €**
  - [ ] `jwt_manager/token_issuer.py`: JWTTokenIssuer í´ë˜ìŠ¤
  - [ ] `jwt_manager/token_validator.py`: JWTTokenValidator í´ë˜ìŠ¤
- [ ] **Services API**
  - [ ] `api/services.py`: SERVICES ëª©ë¡ ë° /api/services ì—”ë“œí¬ì¸íŠ¸
  - [ ] `api/auth.py`: /api/auth/verify, /api/auth/refresh ì—”ë“œí¬ì¸íŠ¸
- [ ] **Backend ë©”ì¸ ì•±**
  - [ ] app.py: Flask-Session + Redis ì„¤ì •
  - [ ] Blueprint ë“±ë¡ (sso, services, auth)
  - [ ] .env íŒŒì¼ ìƒì„± (JWT_SECRET_KEY í¬í•¨)
- [ ] **Backend í…ŒìŠ¤íŠ¸**
  - [ ] `http://localhost:4430/health` â†’ 200 OK
  - [ ] `http://localhost:4430/sso/metadata` â†’ SAML SP Metadata ì¶œë ¥
  - [ ] `http://localhost:4430/api/services` â†’ ì„œë¹„ìŠ¤ ëª©ë¡ 2ê°œ ë°˜í™˜
  - [ ] `http://localhost:4430/sso/login` â†’ saml-idpë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### Week 1 Day 6-7, Week 2 Day 1-2: Frontend (Step 10-12)
- [ ] **React í”„ë¡œì íŠ¸ ì´ˆê¸°í™”**
  - [ ] npm create vite ì™„ë£Œ (react-ts í…œí”Œë¦¿)
  - [ ] ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜: react-router-dom, axios, jwt-decode
  - [ ] vite.config.ts: port 4431 ì„¤ì •
- [ ] **í˜ì´ì§€ êµ¬í˜„**
  - [ ] `pages/Login.tsx`: SSO ë¡œê·¸ì¸ ë²„íŠ¼
  - [ ] `pages/ServiceMenu.tsx`: ì‚¬ìš©ì ì •ë³´ + ì„œë¹„ìŠ¤ ì¹´ë“œ ëª©ë¡
  - [ ] `pages/Callback.tsx`: SAML ACS í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬
  - [ ] `utils/auth.ts`: AuthService í´ë˜ìŠ¤ (ì„¸ì…˜ ê²€ì¦, í† í° ë¦¬í”„ë ˆì‹œ)
  - [ ] App.tsx: ë¼ìš°íŒ… ì„¤ì • (/, /callback, /services)
- [ ] **Frontend í…ŒìŠ¤íŠ¸**
  - [ ] `http://localhost:4431` ì ‘ì† â†’ Login í˜ì´ì§€ í‘œì‹œ
  - [ ] "SSO ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­ â†’ saml-idp ë¡œê·¸ì¸ í˜ì´ì§€
  - [ ] user01 ë¡œê·¸ì¸ â†’ ServiceMenu í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  - [ ] ì„œë¹„ìŠ¤ ì¹´ë“œ 2ê°œ í‘œì‹œ (ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ, ìë™í™” ì‹œìŠ¤í…œ)
  - [ ] user02 ë¡œê·¸ì¸ â†’ ì„œë¹„ìŠ¤ ì¹´ë“œ 1ê°œ í‘œì‹œ (ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë§Œ)

#### Week 2 Day 3-4: Nginx HTTPS (Step 13-15)
- [ ] **SSL ì¸ì¦ì„œ**
  - [ ] `/etc/nginx/ssl/auth_portal.crt` ìƒì„±
  - [ ] `/etc/nginx/ssl/auth_portal.key` ìƒì„±
- [ ] **Nginx ì„¤ì •**
  - [ ] `/etc/nginx/sites-available/auth_portal_443` ìƒì„±
  - [ ] location / â†’ http://localhost:4431 (Frontend)
  - [ ] location /api/ â†’ http://localhost:4430/api/ (Backend API)
  - [ ] location /sso/ â†’ http://localhost:4430/sso/ (SAML)
  - [ ] sites-enabled ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±
  - [ ] nginx -t ê²€ì¦ í†µê³¼
  - [ ] nginx ì¬ì‹œì‘ ì™„ë£Œ
- [ ] **HTTPS í…ŒìŠ¤íŠ¸**
  - [ ] `https://localhost` ì ‘ì† (ì¸ì¦ì„œ ê²½ê³  ë¬´ì‹œ)
  - [ ] SSO ë¡œê·¸ì¸ í”Œë¡œìš° ì™„ì „ ë™ì‘
  - [ ] ServiceMenuì—ì„œ ì„œë¹„ìŠ¤ í´ë¦­ â†’ JWT í† í° ì „ë‹¬ í™•ì¸

### Phase 1 Week 3 ì™„ë£Œ ê¸°ì¤€ (ê¸°ì¡´ ì„œë¹„ìŠ¤ JWT í†µí•©)
- [ ] **backend_5010 JWT ë¯¸ë“¤ì›¨ì–´**
  - [ ] jwt_middleware.py êµ¬í˜„
  - [ ] @jwt_required ë°ì½”ë ˆì´í„° ì¶”ê°€
  - [ ] ê¸°ì¡´ API ì—”ë“œí¬ì¸íŠ¸ì— @jwt_required ì ìš©
  - [ ] JWT_SECRET_KEY í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Auth Portalê³¼ ë™ì¼)
- [ ] **frontend_3010 JWT í•¸ë“¤ë§**
  - [ ] utils/auth.ts ìƒì„±
  - [ ] AuthService.initializeFromURL() êµ¬í˜„ (ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ í† í° ì¶”ì¶œ)
  - [ ] API ìš”ì²­ ì‹œ Authorization í—¤ë” ì¶”ê°€
  - [ ] App.tsxì—ì„œ AuthService ì´ˆê¸°í™”
- [ ] **í†µí•© í…ŒìŠ¤íŠ¸**
  - [ ] Auth Portal (443) ë¡œê·¸ì¸ â†’ ServiceMenu
  - [ ] "ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ" í´ë¦­ â†’ `http://localhost:3010?token=...`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  - [ ] frontend_3010ì´ í† í° ì¶”ì¶œ â†’ localStorage ì €ì¥
  - [ ] backend_5010 API í˜¸ì¶œ ì‹œ JWT ê²€ì¦ ì„±ê³µ

### Phase 2 Week 4-5 ì™„ë£Œ ê¸°ì¤€ (Automation System)
- [ ] backend_5000 JWT ë¯¸ë“¤ì›¨ì–´ ì ìš©
- [ ] backend_5000 â†’ backend_5010 í”„ë¡ì‹œ êµ¬í˜„
- [ ] frontend_5173 JWT í•¸ë“¤ë§ êµ¬í˜„
- [ ] Auth Portal ServiceMenuì—ì„œ ìë™í™” ì‹œìŠ¤í…œ ì ‘ê·¼ ì„±ê³µ

### Phase 3-4 Week 6-8 ì™„ë£Œ ê¸°ì¤€ (VNC + Monitoring + Operations)
- [ ] Apptainer ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
- [ ] VNC Job ì œì¶œ ì„±ê³µ
- [ ] noVNC ë¸Œë¼ìš°ì € ì—°ê²°
- [ ] GPU ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (glxgears)
- [ ] Prometheus + Grafana ëŒ€ì‹œë³´ë“œ ìƒì„±
- [ ] ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ ë™ì‘
- [ ] ë¬¸ì„œ ì™„ì„± (ì‚¬ìš©ì + ê´€ë¦¬ì ê°€ì´ë“œ)

---

## 26. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… (Auth Portal ê´€ë ¨) ğŸ”§

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ

| ë¬¸ì œ | ì›ì¸ | í•´ê²° ë°©ë²• |
|------|------|----------|
| **SAML Response ê²€ì¦ ì‹¤íŒ¨** | ì¸ì¦ì„œ ë¶ˆì¼ì¹˜ | `auth_portal_443/backend/saml_certs/idp-cert.pem` ê²½ë¡œ í™•ì¸, sso/saml_config.pyì—ì„œ ì¸ì¦ì„œ ì½ê¸° í™•ì¸ |
| **Redis ì—°ê²° ì‹¤íŒ¨** | Redis ë¯¸ì‹¤í–‰ | `sudo systemctl start redis && redis-cli ping` |
| **ì„¸ì…˜ ìƒì„± ì•ˆë¨** | Flask-Session ì„¤ì • ì˜¤ë¥˜ | app.pyì—ì„œ `app.config['SESSION_TYPE'] = 'redis'` í™•ì¸, Session(app) í˜¸ì¶œ í™•ì¸ |
| **JWT í† í° ê²€ì¦ ì‹¤íŒ¨** | SECRET_KEY ë¶ˆì¼ì¹˜ | Auth Portalê³¼ backend_5010ì˜ JWT_SECRET_KEYê°€ ë™ì¼í•œì§€ í™•ì¸ (.env íŒŒì¼) |
| **ê¶Œí•œ ê²€ì¦ ì‹¤íŒ¨ (ServiceMenu)** | groups íŒŒì‹± ì˜¤ë¥˜ | saml-idp config.jsì—ì„œ groups ë°°ì—´ í™•ì¸, ACSì—ì„œ `saml_response['groups']` íŒŒì‹± í™•ì¸ |
| **ë¡œê·¸ì¸ ë¬´í•œ ë£¨í”„** | ì¿ í‚¤ ì„¤ì • ë¬¸ì œ | app.config['SESSION_COOKIE_SECURE'] = False (HTTP í™˜ê²½), CORS ì„¤ì • í™•ì¸ |
| **ServiceMenu ë¹ˆ í™”ë©´** | SAML ACS í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨ | routes.pyì˜ ACS í•¸ë“¤ëŸ¬ì—ì„œ `/callback`ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í™•ì¸ |
| **ì„œë¹„ìŠ¤ ì¹´ë“œê°€ ì•ˆ ë³´ì„** | ê·¸ë£¹ í•„í„°ë§ ë¬¸ì œ | ServiceMenu.tsxì—ì„œ user.groupsì™€ service.required_groups ë¹„êµ ë¡œì§ í™•ì¸ |
| **Nginx 502 Bad Gateway** | Backend ë¯¸ì‹¤í–‰ | auth_portal_443/backendì—ì„œ `python app.py` ì‹¤í–‰ í™•ì¸ (í¬íŠ¸ 4430) |
| **Nginx 404 Not Found (/)** | Frontend ë¯¸ì‹¤í–‰ | auth_portal_443/frontendì—ì„œ `npm run dev` ì‹¤í–‰ í™•ì¸ (í¬íŠ¸ 4431) |

### ë””ë²„ê¹… ëª…ë ¹ì–´

#### ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```bash
# Redis ì‹¤í–‰ í™•ì¸
redis-cli ping  # PONG ì‘ë‹µ í™•ì¸
sudo systemctl status redis

# Nginx ì‹¤í–‰ í™•ì¸
sudo systemctl status nginx
sudo nginx -t  # ì„¤ì • ê²€ì¦

# saml-idp ì‹¤í–‰ í™•ì¸
curl http://localhost:7000/metadata  # IdP Metadata ì¶œë ¥

# Auth Portal Backend ì‹¤í–‰ í™•ì¸
curl http://localhost:4430/health  # {"status": "ok", "service": "auth-portal-backend"}

# Auth Portal Frontend ì‹¤í–‰ í™•ì¸
curl http://localhost:4431  # HTML ì¶œë ¥
```

#### Redis ì„¸ì…˜ ë””ë²„ê¹…
```bash
# Redis CLI ì ‘ì†
redis-cli

# ì„¸ì…˜ í‚¤ í™•ì¸
> KEYS session:*
> KEYS flask_session:*

# ì„¸ì…˜ ë‚´ìš© í™•ì¸
> GET flask_session:<session_id>

# ëª¨ë“  í‚¤ í™•ì¸
> KEYS *

# Redis ë¹„ìš°ê¸° (í…ŒìŠ¤íŠ¸ ì‹œ)
> FLUSHALL
```

#### SAML ë””ë²„ê¹…
```bash
# SAML SP Metadata ê²€ì¦ (Auth Portal)
curl http://localhost:4430/sso/metadata | xmllint --format -

# SAML IdP Metadata ê²€ì¦ (saml-idp)
curl http://localhost:7000/metadata | xmllint --format -

# ACS ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
curl -X POST http://localhost:4430/sso/acs  # 400 ì—ëŸ¬ ì •ìƒ (SAML Response í•„ìš”)
```

#### JWT ë””ë²„ê¹…
```bash
# JWT í† í° ë””ì½”ë”© (https://jwt.io ë˜ëŠ” Python)
python3 << 'EOF'
import jwt
token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."  # ì‹¤ì œ í† í° ì…ë ¥
try:
    payload = jwt.decode(token, "jwt-secret-key-shared-across-all-services", algorithms=['HS256'])
    print("âœ… í† í° ê²€ì¦ ì„±ê³µ:")
    print(f"  user_id: {payload['user_id']}")
    print(f"  groups: {payload['groups']}")
    print(f"  exp: {payload['exp']}")
except jwt.ExpiredSignatureError:
    print("âŒ í† í° ë§Œë£Œ")
except jwt.InvalidTokenError as e:
    print(f"âŒ í† í° ê²€ì¦ ì‹¤íŒ¨: {e}")
EOF
```

#### Backend ë¡œê·¸ í™•ì¸
```bash
# Auth Portal Backend ë¡œê·¸ (Flask ë””ë²„ê·¸ ëª¨ë“œ)
cd /home/koopark/claude/KooSlurmInstallAutomationRefactory/dashboard/auth_portal_443/backend
source venv/bin/activate
FLASK_DEBUG=1 python app.py

# saml-idp ë¡œê·¸ í™•ì¸ (ì‹¤í–‰ í„°ë¯¸ë„)
# POST /saml/sso â†’ ë¡œê·¸ì¸ ìš”ì²­
# POST /saml/acs â†’ ACS ì‘ë‹µ
```

#### Network ë””ë²„ê¹…
```bash
# í¬íŠ¸ ì‚¬ìš© í™•ì¸
sudo netstat -tuln | grep -E '443|4430|4431|7000|6379'
# 443    (Nginx HTTPS)
# 4430   (Auth Portal Backend)
# 4431   (Auth Portal Frontend)
# 7000   (saml-idp)
# 6379   (Redis)

# í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps aux | grep -E 'redis|nginx|python|node|saml-idp'
```

### ì¼ë°˜ì ì¸ í•´ê²° ìˆœì„œ

#### ë¬¸ì œ: ë¡œê·¸ì¸ì´ ì•ˆë¨
1. **Redis í™•ì¸**: `redis-cli ping` â†’ PONG ì‘ë‹µ
2. **saml-idp í™•ì¸**: `curl http://localhost:7000/metadata`
3. **Backend í™•ì¸**: `curl http://localhost:4430/health`
4. **SAML í”Œë¡œìš° í™•ì¸**: ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ Network íƒ­
   - `/sso/login` â†’ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸ (saml-idp)
   - saml-idp ë¡œê·¸ì¸ í¼ í‘œì‹œ
   - saml-idp POST `/saml/acs` â†’ 302 ë¦¬ë‹¤ì´ë ‰íŠ¸ (Auth Portal)
   - `/callback` â†’ ServiceMenu í˜ì´ì§€

#### ë¬¸ì œ: ServiceMenuì— ì„œë¹„ìŠ¤ê°€ ì•ˆ ë³´ì„
1. **ì‚¬ìš©ì ê·¸ë£¹ í™•ì¸**: ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ Console
   ```javascript
   // ServiceMenu.tsxì—ì„œ console.log ì¶”ê°€
   console.log('User groups:', user.groups);
   console.log('Available services:', services);
   ```
2. **API ì‘ë‹µ í™•ì¸**: `curl http://localhost:4430/api/services`
3. **ê·¸ë£¹ ë§¤ì¹­ ë¡œì§ í™•ì¸**: ServiceMenu.tsxì˜ í•„í„°ë§ ì¡°ê±´

#### ë¬¸ì œ: JWT í† í°ì´ ì „ë‹¬ ì•ˆë¨
1. **í† í° ë°œê¸‰ í™•ì¸**: Auth Portal Backend ë¡œê·¸ì—ì„œ `issue_token` í˜¸ì¶œ í™•ì¸
2. **ë¦¬ë‹¤ì´ë ‰íŠ¸ URL í™•ì¸**: ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ Network íƒ­
   - ì˜ˆìƒ: `http://localhost:3010?token=eyJhbGci...`
3. **Frontend JWT ì¶”ì¶œ í™•ì¸**: frontend_3010ì˜ AuthService.initializeFromURL() í˜¸ì¶œ í™•ì¸
4. **localStorage í™•ì¸**: ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ Application â†’ Local Storage
   - `jwt_token` í‚¤ ì¡´ì¬ í™•ì¸

---

**ë¬¸ì„œ ë²„ì „**: 5.0 (Auth Portal 443 í†µí•© ì•„í‚¤í…ì²˜ ì™„ë£Œ)

### ë³€ê²½ ì´ë ¥
- **v5.0** (2025-10-16): Auth Portal 443 ì¤‘ì‹¬ ì•„í‚¤í…ì²˜ë¡œ ì „ë©´ ì¬êµ¬ì„±
  - Section 0: 7ê°œ ì„œë¹„ìŠ¤ í†µí•© ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€
  - Section 0.5: Auth Portal Backend ì™„ì „ êµ¬í˜„ (SAML + JWT + Services API)
  - Section 0.6: JWT ë¯¸ë“¤ì›¨ì–´ (backend_5010/5000)
  - Section 0.7: Frontend JWT í•¸ë“¤ë§
  - Section 22: ê°œë°œ ë¡œë“œë§µ 4ë‹¨ê³„ë¡œ ì¬êµ¬ì„± (Auth Portal â†’ JWT í†µí•© â†’ Automation â†’ VNC/Monitoring)
  - Section 24: ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ì‘ì—… 21ë‹¨ê³„ë¡œ ìƒì„¸í™”
  - Section 25: Phaseë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¸ë¶„í™”
  - Section 26: Auth Portal íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ ì¶”ê°€
- **v4.0** (2025-10-16): SSO ìµœìš°ì„  ìˆœìœ„ ë°˜ì˜
- **v3.0** (2025-10-15): ì´ˆê¸° ë³´ì•ˆ ë° ëª¨ë‹ˆí„°ë§ ê³„íš ì¶”ê°€
- **v2.0** (2025-10-14): VNC í•µì‹¬ ê¸°ëŠ¥ ì„¤ê³„ ì™„ë£Œ
- **v1.0** (2025-10-13): ì´ˆê¸° ë¬¸ì„œ ì‘ì„±

**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-16
**ì‘ì„±ì**: AI Assistant
**ê²€í† ì**: koopark

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:
- ğŸ”¥ **ADFS SSO ì¸ì¦ ì‹œìŠ¤í…œ Section 0 ì¶”ê°€** (ìµœìš°ì„ )
- âœ… saml-idp ê°œë°œ í™˜ê²½ êµ¬ì¶• ê°€ì´ë“œ
- âœ… python3-saml í†µí•© ì½”ë“œ (SAMLAuthManager)
- âœ… Redis ì„¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ
- âœ… ê¶Œí•œ ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (@permission_required)
- âœ… ADFS í”„ë¡œë•ì…˜ ì—°ë™ ì¤€ë¹„ (PowerShell ìŠ¤í¬ë¦½íŠ¸)
- âœ… Phase 0 (Week 1): SSO ì¸ì¦ ì‹œìŠ¤í…œ - CRITICAL PRIORITY
- âœ… ê°œë°œ ë¡œë“œë§µ ì¬ì¡°ì • (SSO â†’ VNC â†’ ë³´ì•ˆ â†’ ëª¨ë‹ˆí„°ë§)
- âœ… ì¦‰ì‹œ ì‹œì‘ ê°€ëŠ¥í•œ ì‘ì—… ì—…ë°ì´íŠ¸ (SSO ì¤‘ì‹¬)
- âœ… SSO íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ ì¶”ê°€

**ë‹¤ìŒ ìš°ì„ ìˆœìœ„**:
1. **Week 1**: saml-idp + Redis + SAML Backend êµ¬í˜„
2. **Week 2-3**: VNC ì„¸ì…˜ ìƒì„± + noVNC í†µí•©
3. **Week 4**: ADFS ì—°ë™ + ë³´ì•ˆ ê°•í™”

**END OF DOCUMENT**
