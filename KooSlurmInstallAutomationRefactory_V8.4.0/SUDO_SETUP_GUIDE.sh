#!/bin/bash
################################################################################
# sudo ê¶Œí•œ ìˆ˜ë™ ì„¤ì • ê°€ì´ë“œ
# SSHë¡œ ì ‘ì† ê°€ëŠ¥í•˜ì§€ë§Œ sudo ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°
################################################################################

cat << 'EOF'
================================================================================
ğŸ” sudo ê¶Œí•œ ìˆ˜ë™ ì„¤ì • ê°€ì´ë“œ
================================================================================

ë¬¸ì œ: SSH ì—°ê²°ì€ ë˜ì§€ë§Œ sudo ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°

í•´ê²° ë°©ë²• (ê° ë…¸ë“œì—ì„œ ì‹¤í–‰):

================================================================================
ë°©ë²• 1: root ê³„ì •ìœ¼ë¡œ ì§ì ‘ ì„¤ì • (ê¶Œì¥)
================================================================================

1ï¸âƒ£  ë¬¸ì œê°€ ìˆëŠ” ë…¸ë“œì— ë¡œê·¸ì¸:
   ssh node1

2ï¸âƒ£  rootë¡œ ì „í™˜:
   su -
   # ë˜ëŠ”
   sudo su -  # ë‹¤ë¥¸ sudo ê¶Œí•œ ìˆëŠ” ê³„ì •ì´ ìˆë‹¤ë©´

3ï¸âƒ£  ì‚¬ìš©ìë¥¼ sudo/wheel ê·¸ë£¹ì— ì¶”ê°€:
   # Ubuntu/Debian:
   usermod -aG sudo koopark
   
   # CentOS/RHEL:
   usermod -aG wheel koopark

4ï¸âƒ£  sudoers íŒŒì¼ ìƒì„± (íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ sudo ì‚¬ìš©):
   echo 'koopark ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/koopark
   chmod 0440 /etc/sudoers.d/koopark

5ï¸âƒ£  ê²€ì¦:
   visudo -c -f /etc/sudoers.d/koopark
   
   # ìƒˆ í„°ë¯¸ë„ì—ì„œ í…ŒìŠ¤íŠ¸
   ssh node1
   sudo whoami  # "root" ì¶œë ¥ë˜ì–´ì•¼ í•¨

================================================================================
ë°©ë²• 2: ë‹¤ë¥¸ sudo ê¶Œí•œ ìˆëŠ” ê³„ì • ì‚¬ìš©
================================================================================

ë‹¤ë¥¸ sudo ê¶Œí•œì´ ìˆëŠ” ê³„ì •(ì˜ˆ: admin)ì´ ìˆë‹¤ë©´:

ssh admin@node1
sudo usermod -aG sudo koopark
sudo echo 'koopark ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/koopark
sudo chmod 0440 /etc/sudoers.d/koopark

================================================================================
ë°©ë²• 3: ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì›ê²© ì‹¤í–‰
================================================================================

ì»¨íŠ¸ë¡¤ëŸ¬(smarttwincluster)ì—ì„œ rootë¡œ ì‹¤í–‰:

# node1ì— rootë¡œ SSH ì ‘ì† ê°€ëŠ¥í•œ ê²½ìš°
ssh root@node1 "usermod -aG sudo koopark && \
  echo 'koopark ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/koopark && \
  chmod 0440 /etc/sudoers.d/koopark"

================================================================================
ë°©ë²• 4: ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
================================================================================

# Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (root ì ‘ê·¼ í•„ìš”)
python3 setup_sudo_auto.py

================================================================================
âœ… ì„¤ì • ì™„ë£Œ í›„ í…ŒìŠ¤íŠ¸
================================================================================

# ê° ë…¸ë“œì—ì„œ í…ŒìŠ¤íŠ¸
ssh node1 'sudo whoami'  # "root" ì¶œë ¥ë˜ì–´ì•¼ í•¨
ssh node2 'sudo whoami'  # "root" ì¶œë ¥ë˜ì–´ì•¼ í•¨

# ë˜ëŠ” ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
python3 test_connection.py my_cluster.yaml

================================================================================
ğŸš¨ ì£¼ì˜ì‚¬í•­
================================================================================

1. root ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë¥´ëŠ” ê²½ìš°:
   - ë¬¼ë¦¬ì  ì ‘ê·¼ ë˜ëŠ” ì½˜ì†” ì ‘ê·¼ í•„ìš”
   - ë˜ëŠ” ë‹¤ë¥¸ sudo ê¶Œí•œ ìˆëŠ” ê³„ì • í•„ìš”

2. sudoers íŒŒì¼ í¸ì§‘ì‹œ:
   - ë°˜ë“œì‹œ visudo ëª…ë ¹ ì‚¬ìš©
   - ì§ì ‘ í¸ì§‘í•˜ë©´ ì˜ëª»ëœ ë¬¸ë²•ìœ¼ë¡œ ì‹œìŠ¤í…œ ì ê¹€ ìœ„í—˜

3. ë³´ì•ˆ:
   - NOPASSWDëŠ” í¸ì˜ì„±ì„ ìœ„í•¨
   - í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” íŒ¨ìŠ¤ì›Œë“œ ìš”êµ¬ ê¶Œì¥
   - ì‚¬ìš© í›„ ê¶Œí•œ ì œê±° ê³ ë ¤

================================================================================
ğŸ’¡ ë¹ ë¥¸ í•´ê²° (ëª¨ë“  ë…¸ë“œë¥¼ í•œ ë²ˆì—)
================================================================================

#!/bin/bash
# ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ rootë¡œ ì‹¤í–‰

for node in node1 node2; do
  echo "Setting up sudo for $node..."
  ssh root@$node "
    usermod -aG sudo koopark || usermod -aG wheel koopark
    echo 'koopark ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/koopark
    chmod 0440 /etc/sudoers.d/koopark
    visudo -c
  "
done

echo "Done! Testing..."
for node in node1 node2; do
  ssh $node 'sudo whoami'
done

================================================================================
EOF
