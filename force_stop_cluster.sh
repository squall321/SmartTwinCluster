#!/bin/bash
################################################################################
# Slurm Cluster ê°•ì œ ì¢…ë£Œ (ë¹ ë¥¸ ë²„ì „)
# Timeout ë¬¸ì œ ë°œìƒ ì‹œ ì‚¬ìš©
################################################################################

echo "================================================================================"
echo "âš¡ Slurm Cluster ê°•ì œ ì¢…ë£Œ (ë¹ ë¥¸ ë²„ì „)"
echo "================================================================================"
echo ""

COMPUTE_NODES=("192.168.122.90" "192.168.122.103")
SSH_USER="koopark"

################################################################################
# 1. ì»¨íŠ¸ë¡¤ëŸ¬ ê°•ì œ ì¢…ë£Œ
################################################################################

echo "1ï¸âƒ£  ì»¨íŠ¸ë¡¤ëŸ¬ ê°•ì œ ì¢…ë£Œ..."
sudo systemctl stop slurmctld || true
sleep 1

# í”„ë¡œì„¸ìŠ¤ í™•ì¸
if pgrep -f slurmctld > /dev/null; then
    echo "   ê°•ì œ ì¢…ë£Œ ì¤‘..."
    sudo pkill -9 slurmctld || true
    sleep 1
fi

if pgrep -f slurmctld > /dev/null; then
    echo "   âš ï¸  ì¼ë¶€ í”„ë¡œì„¸ìŠ¤ê°€ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤"
else
    echo "   âœ… slurmctld ì¢…ë£Œ ì™„ë£Œ"
fi

echo ""

################################################################################
# 2. ê³„ì‚° ë…¸ë“œ ê°•ì œ ì¢…ë£Œ (timeout 5ì´ˆ)
################################################################################

echo "2ï¸âƒ£  ê³„ì‚° ë…¸ë“œ ê°•ì œ ì¢…ë£Œ..."

for node in "${COMPUTE_NODES[@]}"; do
    echo ""
    echo "ğŸ”§ ${node} ì¢…ë£Œ ì¤‘..."
    
    # 5ì´ˆ timeout
    if timeout 5 ssh -o ConnectTimeout=3 ${SSH_USER}@${node} "sudo systemctl stop slurmd; sudo pkill -9 slurmd" 2>/dev/null; then
        echo "   âœ… ${node}: ëª…ë ¹ ì „ì†¡ ì™„ë£Œ"
    else
        echo "   âš ï¸  ${node}: Timeout ë˜ëŠ” ì—°ê²° ì‹¤íŒ¨ (ë¬´ì‹œ)"
    fi
done

echo ""
echo "âœ… ê°•ì œ ì¢…ë£Œ ì™„ë£Œ!"
echo ""

################################################################################
# 3. ìƒíƒœ í™•ì¸
################################################################################

echo "3ï¸âƒ£  ë¡œì»¬ í”„ë¡œì„¸ìŠ¤ í™•ì¸..."

if pgrep -f "slurm" > /dev/null; then
    echo "   ë‚¨ì•„ìˆëŠ” Slurm í”„ë¡œì„¸ìŠ¤:"
    ps aux | grep -E "slurm[cd]|slurmdbd" | grep -v grep || echo "   (ì—†ìŒ)"
else
    echo "   âœ… ë¡œì»¬ Slurm í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
fi

echo ""

echo "================================================================================"
echo "âœ… ê°•ì œ ì¢…ë£Œ ì™„ë£Œ"
echo "================================================================================"
echo ""

echo "ğŸ’¡ ì‹œì‘í•˜ë ¤ë©´:"
echo "   ./start_slurm_cluster.sh"
echo ""

echo "================================================================================"
