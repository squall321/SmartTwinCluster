# Keepalived Configuration Template
# Generated by cluster/setup/phase4_keepalived.sh
# This file should be placed at /etc/keepalived/keepalived.conf

################################################################################
# GLOBAL CONFIGURATION
################################################################################

global_defs {
    # Notification email (optional)
    # notification_email {
    #     admin@example.com
    # }
    # notification_email_from keepalived@{{HOSTNAME}}
    # smtp_server 127.0.0.1
    # smtp_connect_timeout 30

    # Router ID (unique identifier for this node)
    # TEMPLATE_VARIABLE: router_id
    router_id {{HOSTNAME}}

    # Enable script security
    enable_script_security

    # Script user
    script_user root
}

################################################################################
# VRRP SCRIPT - HEALTH CHECK
################################################################################

# Health check script
# Checks if critical services are running
# TEMPLATE_VARIABLE: track_script
vrrp_script chk_services {
    script "{{HEALTH_CHECK_SCRIPT}}"
    interval 5          # Check every 5 seconds
    weight -20          # Decrease priority by 20 if check fails
    fall 2              # Require 2 failures for KO
    rise 2              # Require 2 successes for OK
}

################################################################################
# VRRP INSTANCE - MAIN VIP
################################################################################

vrrp_instance VI_MAIN {
    # State: MASTER or BACKUP
    # TEMPLATE_VARIABLE: state
    state {{STATE}}

    # Interface to bind VIP
    # TEMPLATE_VARIABLE: interface
    interface {{INTERFACE}}

    # Virtual router ID (must be same on all nodes, 1-255)
    virtual_router_id 51

    # Priority (higher = preferred master)
    # TEMPLATE_VARIABLE: priority
    priority {{PRIORITY}}

    # Advertisement interval (seconds)
    advert_int 1

    # Authentication
    authentication {
        auth_type PASS
        # TEMPLATE_VARIABLE: auth_pass
        auth_pass {{AUTH_PASS}}
    }

    # Virtual IP addresses
    virtual_ipaddress {
        # TEMPLATE_VARIABLE: vip_address
        {{VIP_ADDRESS}}/{{VIP_NETMASK}} dev {{INTERFACE}}
    }

    # Track scripts (health checks)
    track_script {
        chk_services
    }

    # Notification scripts
    # TEMPLATE_VARIABLE: notify_scripts
    notify_master "{{NOTIFY_MASTER_SCRIPT}}"
    notify_backup "{{NOTIFY_BACKUP_SCRIPT}}"
    notify_fault "{{NOTIFY_FAULT_SCRIPT}}"

    # Use VRRP version 2
    version 2

    # Preemption settings
    # If set to nopreempt, higher priority node won't take over from lower priority
    # TEMPLATE_VARIABLE: preempt
    {{PREEMPT_CONFIG}}

    # Delay before taking over (seconds)
    # TEMPLATE_VARIABLE: preempt_delay
    {{PREEMPT_DELAY_CONFIG}}
}

################################################################################
# VIRTUAL SERVER CONFIGURATION (Optional)
################################################################################

# Virtual server for load balancing (optional)
# Uncomment if you want Keepalived to also do load balancing

# virtual_server {{VIP_ADDRESS}} 6379 {
#     delay_loop 6
#     lb_algo rr
#     lb_kind NAT
#     protocol TCP
#
#     # Real servers (Redis nodes)
#     real_server 192.168.1.101 6379 {
#         weight 1
#         TCP_CHECK {
#             connect_timeout 3
#         }
#     }
#     real_server 192.168.1.102 6379 {
#         weight 1
#         TCP_CHECK {
#             connect_timeout 3
#         }
#     }
# }

################################################################################
# ADVANCED SETTINGS
################################################################################

# VRRP sync groups (optional)
# Use if you want multiple VIPs to fail over together

# vrrp_sync_group VG1 {
#     group {
#         VI_MAIN
#         VI_SECONDARY
#     }
#     notify_master "{{NOTIFY_MASTER_SCRIPT}}"
#     notify_backup "{{NOTIFY_BACKUP_SCRIPT}}"
#     notify_fault "{{NOTIFY_FAULT_SCRIPT}}"
# }

# Secondary VIP (optional)
# vrrp_instance VI_SECONDARY {
#     state {{STATE}}
#     interface {{INTERFACE}}
#     virtual_router_id 52
#     priority {{PRIORITY}}
#     advert_int 1
#     authentication {
#         auth_type PASS
#         auth_pass {{AUTH_PASS}}
#     }
#     virtual_ipaddress {
#         {{VIP_ADDRESS_SECONDARY}}/{{VIP_NETMASK}} dev {{INTERFACE}}
#     }
# }
