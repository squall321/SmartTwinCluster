# MariaDB Galera Cluster Configuration Template
# Generated by cluster/setup/phase1_database.sh
# This file should be placed at /etc/mysql/mariadb.conf.d/60-galera.cnf

[mysqld]
# === Galera Cluster Configuration ===

# Mandatory settings
binlog_format=ROW
default_storage_engine=InnoDB
innodb_autoinc_lock_mode=2

# === Node Configuration ===
# This node's unique identifier
# TEMPLATE_VARIABLE: wsrep_node_address
wsrep_node_address={{NODE_IP}}

# This node's name (hostname)
# TEMPLATE_VARIABLE: wsrep_node_name
wsrep_node_name={{NODE_HOSTNAME}}

# === Cluster Configuration ===
# Enable wsrep replication
wsrep_on=ON

# Galera provider library
# TEMPLATE_VARIABLE: wsrep_provider (OS-specific)
wsrep_provider={{WSREP_PROVIDER_PATH}}

# Cluster name - all nodes must have same name
# TEMPLATE_VARIABLE: wsrep_cluster_name
wsrep_cluster_name={{CLUSTER_NAME}}

# Cluster members (comma-separated list)
# TEMPLATE_VARIABLE: wsrep_cluster_address
# Format: gcomm://IP1:4567,IP2:4567,IP3:4567
# Bootstrap mode: gcomm:// (empty list)
# Join mode: gcomm://existing_node1,existing_node2,...
wsrep_cluster_address={{CLUSTER_ADDRESS}}

# === SST (State Snapshot Transfer) Configuration ===
# SST method: rsync, xtrabackup-v2, mariabackup
# mariabackup is recommended for MariaDB 10.3+
wsrep_sst_method=mariabackup

# SST user credentials
# TEMPLATE_VARIABLE: wsrep_sst_auth
wsrep_sst_auth={{SST_USER}}:{{SST_PASSWORD}}

# === Replication Configuration ===
# Slave threads (parallel apply)
# Recommended: number of CPU cores
wsrep_slave_threads={{WSREP_SLAVE_THREADS}}

# Certification mode
# TEMPLATE_VARIABLE: wsrep_certify_nonPK
wsrep_certify_nonPK=1

# Maximum write set size (512MB)
wsrep_max_ws_size=536870912

# Maximum write set rows
wsrep_max_ws_rows=0

# === Flow Control ===
# Flow control is now managed automatically by Galera 4.x
# The old wsrep_flow_control_* variables are deprecated in MariaDB 10.6+
# Flow control behavior is controlled through wsrep_provider_options below

# === Performance Configuration ===
# InnoDB buffer pool size (70-80% of RAM recommended)
# TEMPLATE_VARIABLE: innodb_buffer_pool_size
innodb_buffer_pool_size={{INNODB_BUFFER_POOL_SIZE}}

# InnoDB log file size
innodb_log_file_size=512M

# InnoDB flush method
innodb_flush_log_at_trx_commit=0
innodb_flush_method=O_DIRECT

# Query cache (disabled for Galera)
query_cache_size=0
query_cache_type=0

# === Connection Configuration ===
# Maximum connections
# TEMPLATE_VARIABLE: max_connections
max_connections={{MAX_CONNECTIONS}}

# Maximum allowed packet size
max_allowed_packet=256M

# === Logging Configuration ===
# General query log (disabled in production)
general_log=0
general_log_file=/var/log/mysql/mysql.log

# Slow query log
slow_query_log=1
slow_query_log_file=/var/log/mysql/mysql-slow.log
long_query_time=2

# Error log
log_error=/var/log/mysql/error.log

# Binary log (required for Galera)
log_bin=/var/log/mysql/mysql-bin
expire_logs_days=7
max_binlog_size=100M

# === Character Set ===
character_set_server=utf8mb4
collation_server=utf8mb4_unicode_ci

# === Networking ===
# Bind to all interfaces (0.0.0.0) or specific IP
# TEMPLATE_VARIABLE: bind_address
bind_address={{BIND_ADDRESS}}

# MySQL port
port=3306

# === Galera-specific Timeouts ===
# Evict unresponsive nodes from cluster
wsrep_provider_options="evs.keepalive_period=PT1S;evs.suspect_timeout=PT10S;evs.inactive_timeout=PT30S;evs.install_timeout=PT15S;evs.join_retrans_period=PT1S;evs.send_window=512;evs.user_send_window=256;gcache.size=1G"

# === Startup Configuration ===
# SST receive address
# TEMPLATE_VARIABLE: wsrep_sst_receive_address
wsrep_sst_receive_address={{NODE_IP}}:4444

# === Security ===
# Skip name resolution for faster connections
skip_name_resolve=1

# Require secure connections for replication traffic (optional)
# wsrep_provider_options="socket.ssl_key=/path/to/server-key.pem;socket.ssl_cert=/path/to/server-cert.pem;socket.ssl_ca=/path/to/ca-cert.pem"

# === Bootstrap Mode ===
# Only set to ON when bootstrapping new cluster
# Must be set to OFF after cluster is started
# TEMPLATE_VARIABLE: wsrep_new_cluster (only for bootstrap)
# wsrep_new_cluster=OFF
