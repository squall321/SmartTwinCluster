# Slurm Configuration Template
# Generated by cluster/setup/phase3_slurm.sh
# This file should be placed at /etc/slurm/slurm.conf

################################################################################
# CLUSTER CONFIGURATION
################################################################################

# Cluster name
# TEMPLATE_VARIABLE: ClusterName
ClusterName={{CLUSTER_NAME}}

# Controllers (multi-master setup)
# TEMPLATE_VARIABLE: SlurmctldHost (multiple entries)
# VIP owner is primary (listed first), others are backups
{{SLURMCTLD_HOSTS}}

# Slurm User
SlurmUser=slurm
SlurmdUser=root

################################################################################
# SHARED STATE DIRECTORY (GlusterFS)
################################################################################

# State save location (shared via GlusterFS)
# TEMPLATE_VARIABLE: StateSaveLocation
StateSaveLocation={{STATE_SAVE_LOCATION}}

# Slurm spool directory (local, not shared)
SlurmdSpoolDir=/var/spool/slurmd

# PID files
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmdPidFile=/var/run/slurmd.pid

################################################################################
# LOGGING
################################################################################

# Controller log file
SlurmctldLogFile={{SLURMCTLD_LOG_FILE}}

# Daemon log file
SlurmdLogFile={{SLURMD_LOG_FILE}}

# Debug level (quiet, fatal, error, info, verbose, debug, debug2-5)
SlurmctldDebug=info
SlurmdDebug=info

################################################################################
# AUTHENTICATION & SECURITY
################################################################################

# Authentication type
AuthType=auth/munge

# Crypto type
CryptoType=crypto/munge

# Message authentication
AuthAltTypes=auth/munge

################################################################################
# SCHEDULING
################################################################################

# Scheduler type
SchedulerType=sched/backfill

# Scheduler parameters
SchedulerParameters=default_queue_depth=100,max_rpc_cnt=0,max_sched_time=2

# Select type (cons_tres recommended for modern Slurm)
SelectType=select/cons_tres
SelectTypeParameters=CR_Core_Memory

################################################################################
# PRIORITY
################################################################################

# Priority type (multifactor for fair-share scheduling)
PriorityType=priority/multifactor

# Priority decay half-life (7 days)
PriorityDecayHalfLife=7-0

# Priority calculation period
PriorityCalcPeriod=5

# Priority max age (also 7 days)
PriorityMaxAge=7-0

# Priority weights
PriorityWeightAge=1000
PriorityWeightFairshare=10000
PriorityWeightJobSize=1000
PriorityWeightPartition=1000
PriorityWeightQOS=0

# Favor small jobs
PriorityFavorSmall=NO

################################################################################
# FAIR-SHARE
################################################################################

# Fair-share algorithm
PriorityFlags=FAIR_TREE,SMALL_RELATIVE_TO_TIME

################################################################################
# ACCOUNTING
################################################################################

# Accounting storage type (MySQL/MariaDB)
AccountingStorageType=accounting_storage/slurmdbd

# Accounting storage host
# TEMPLATE_VARIABLE: AccountingStorageHost
AccountingStorageHost={{ACCOUNTING_STORAGE_HOST:-localhost}}

# Accounting storage port
AccountingStoragePort=6819

# Enforce accounting
AccountingStorageEnforce=associations,limits,qos

# Job accounting gather frequency
JobAcctGatherType=jobacct_gather/linux
JobAcctGatherFrequency=30

################################################################################
# JOB COMPLETION
################################################################################

# Job completion logging
JobCompType=jobcomp/none

################################################################################
# PROCESS TRACKING
################################################################################

# Process tracking (cgroup recommended)
ProctrackType=proctrack/cgroup

# Task plugin
TaskPlugin=task/cgroup,task/affinity

################################################################################
# TOPOLOGY
################################################################################

# Topology plugin (none, tree, 3d_torus)
TopologyPlugin=topology/none

################################################################################
# TIMERS
################################################################################

# Message timeout
MessageTimeout=60

# How long to wait for a response from slurmctld
SlurmctldTimeout=120

# How long to wait for a response from slurmd
SlurmdTimeout=300

# Inactive limit (suspend jobs if no activity)
InactiveLimit=0

# Minimum job age (seconds before eligible for scheduling)
MinJobAge=300

# Kill wait time
KillWait=30

# Wait time for kill on invalid dependency
KillOnBadExit=1

# How long until controller declares itself down
SlurmctldParameters=enable_configless

################################################################################
# HEALTH CHECK
################################################################################

# Health check program
# HealthCheckProgram=/usr/sbin/nhc
# HealthCheckInterval=300

################################################################################
# POWER MANAGEMENT
################################################################################

# Suspend/resume programs (optional)
# SuspendProgram=/usr/local/slurm/sbin/slurm_suspend
# ResumeProgram=/usr/local/slurm/sbin/slurm_resume
# SuspendTimeout=60
# ResumeTimeout=60
# SuspendExcNodes=
# SuspendExcParts=
# SuspendRate=60
# ResumeRate=300

################################################################################
# PREEMPTION
################################################################################

# Preemption mode
PreemptMode=REQUEUE
PreemptType=preempt/qos

################################################################################
# COMMUNICATION
################################################################################

# Return to service
ReturnToService=2

# Propagate resource limits
PropagateResourceLimits=ALL

################################################################################
# EPILOG/PROLOG
################################################################################

# Prolog/Epilog scripts (optional)
# Prolog=/etc/slurm/prolog.sh
# Epilog=/etc/slurm/epilog.sh
# PrologFlags=Alloc,Serial
# EpilogSlurmctld=/etc/slurm/epilog_controller.sh

################################################################################
# MPI
################################################################################

# MPI type
MpiDefault=pmix

################################################################################
# RESOURCE LIMITS
################################################################################

# Default resource limits
DefMemPerCPU=1024
MaxMemPerCPU=0

################################################################################
# NODES
################################################################################

# Node definitions
# TEMPLATE_VARIABLE: NodeName (generated from YAML)
{{NODE_DEFINITIONS}}

################################################################################
# PARTITIONS
################################################################################

# Partition definitions
# TEMPLATE_VARIABLE: PartitionName (generated from YAML)
{{PARTITION_DEFINITIONS}}

# Default partition
# TEMPLATE_VARIABLE: PartitionName (default)
{{DEFAULT_PARTITION}}

################################################################################
# ADVANCED CONFIGURATION
################################################################################

# Enable job container support
# PrologFlags=contain

# GPU configuration
# GresTypes=gpu

# Enable cloud bursting
# PrivateData=cloud

# Federation support
# FederationParameters=fed_display

################################################################################
# PLUGIN DIRECTORIES
################################################################################

# Plugin directory
# Auto-detect based on OS (Ubuntu: /usr/lib/x86_64-linux-gnu/slurm-wlm, CentOS: /usr/lib64/slurm)
PluginDir={{PLUGIN_DIR:-/usr/local/slurm/lib/slurm}}

################################################################################
# CONSTRAINTS
################################################################################

# Enable constraint-based scheduling
# SchedulerParameters=...,enable_hetjob_steps

################################################################################
# OTHER
################################################################################

# First job ID
# FirstJobId=1

# Max job ID
# MaxJobId=67043328

# Max job count
# MaxJobCount=10000

# Max array size
MaxArraySize=10001

# Max step count
# MaxStepCount=40000

# Track wckey
# TrackWCKey=no

# Tree width
# TreeWidth=50

# CLI filter plugins
# CliFilterPlugins=

# Prolog/Epilog timeout
# PrologEpilogTimeout=65534

# Complete wait time
CompleteWait=0

# Disable root jobs
# DisableRootJobs=NO

# Enforce part limits
# EnforcePartLimits=NO

# Group update force
# GroupUpdateForce=0

# Group update time
# GroupUpdateTime=600

# Launch parameters
LaunchParameters=enable_nss_slurm

# Reconfig flags
# ReconfigFlags=

# Batch start timeout
# BatchStartTimeout=10

# Over time limit
# OverTimeLimit=0

# Unkillable step timeout
# UnkillableStepTimeout=60

# VSI ze data
# VSIZEFactor=0
